@namespace Beastborne.UI.Components
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@inherits Panel

@if (IsVisible())
{
	<root class="tutorial-popup">
		<div class="tutorial-content">
			<!-- Tamer character -->
			<div class="popup-character">
				<img src="@GetTamerSprite()" class="tamer-sprite" />
			</div>

			<!-- Speech bubble -->
			<div class="popup-bubble">
				<div class="popup-header">
					<div class="popup-title">@GetTitle()</div>
					<button class="popup-close" onclick=@OnClose>âœ•</button>
				</div>

				<div class="popup-message">@GetMessage()</div>

				@if (!string.IsNullOrEmpty(GetActionHint()))
				{
					<div class="popup-hint">
						@GetActionHint()
					</div>
				}

				<div class="popup-footer">
					<div class="popup-progress">
						@GetStepCounter()
					</div>
					<div class="popup-actions">
						@if (CanGoPrevious())
						{
							<button class="btn-prev" onclick=@OnPrevious>Back</button>
						}
						<button class="btn-next" onclick=@OnNext>
							@GetNextButtonText()
						</button>
					</div>
				</div>
			</div>
		</div>
	</root>
}

@code {
	private bool IsVisible()
	{
		return TutorialManager.Instance?.IsTutorialActive == true;
	}

	private string GetTamerSprite()
	{
		// Use the player's chosen gender for the tamer sprite
		var gender = TamerManager.Instance?.CurrentTamer?.Gender ?? TamerGender.Male;
		return gender == TamerGender.Female
			? "ui/characters/female/female_tamer.png"
			: "ui/characters/male/male_tamer.png";
	}

	private string GetTitle()
	{
		return TutorialManager.Instance?.CurrentStep?.Title ?? "Tutorial";
	}

	private string GetMessage()
	{
		return TutorialManager.Instance?.CurrentStep?.Message ?? "";
	}

	private string GetActionHint()
	{
		return TutorialManager.Instance?.CurrentStep?.ActionHint ?? "";
	}

	private string GetStepCounter()
	{
		var current = GetCurrentIndex() + 1;
		var total = GetTotalSteps();
		return $"{current} / {total}";
	}

	private int GetCurrentIndex()
	{
		return TutorialManager.Instance?.CurrentStepIndex ?? 0;
	}

	private int GetTotalSteps()
	{
		return TutorialManager.Instance?.TotalSteps ?? 1;
	}

	private bool CanGoPrevious()
	{
		return GetCurrentIndex() > 0;
	}

	private string GetNextButtonText()
	{
		// Last step shows "Finish" instead of "Next"
		if (GetCurrentIndex() >= GetTotalSteps() - 1)
			return "Finish";
		return "Next";
	}

	private void OnNext()
	{
		SoundManager.PlayClick();
		TutorialManager.Instance?.NextStep();
	}

	private void OnPrevious()
	{
		SoundManager.PlayBack();
		TutorialManager.Instance?.PreviousStep();
	}

	private void OnClose()
	{
		SoundManager.PlayBack();
		TutorialManager.Instance?.SkipTutorial();
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(IsVisible());
		hash.Add(GetCurrentIndex());
		hash.Add(GetTitle());
		return hash.ToHashCode();
	}
}
