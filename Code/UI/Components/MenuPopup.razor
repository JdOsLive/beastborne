@namespace Beastborne.UI.Components
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Systems;
@using Beastborne.UI.Panels;
@inherits Panel

@if (IsVisible)
{
	<root class="menu-container">
		<div class="menu-overlay" onclick=@Close></div>
		<div class="menu-popup">
			<div class="popup-header">
				<span class="popup-title">‚öîÔ∏è Menu</span>
				<button class="close-btn" onclick=@Close>‚úï</button>
			</div>

			<div class="popup-content">
				<!-- 2x2 Grid for main options -->
				<div class="options-grid">
					<div class="grid-row">
						<button class="menu-option grid-item" onclick=@OnHelpClicked>
							<span class="option-icon">‚ÑπÔ∏è</span>
							<div class="option-text">
								<span class="option-label">Help</span>
								<span class="option-desc">Controls & tips</span>
							</div>
						</button>

						<button class="menu-option grid-item" onclick=@OnTutorialClicked>
							<span class="option-icon">üìñ</span>
							<div class="option-text">
								<span class="option-label">Tutorial</span>
								<span class="option-desc">Replay tutorial</span>
							</div>
						</button>
					</div>

					<div class="grid-row">
						<button class="menu-option grid-item" onclick=@OnOptionsClicked>
							<span class="option-icon">‚öôÔ∏è</span>
							<div class="option-text">
								<span class="option-label">Options</span>
								<span class="option-desc">Settings</span>
							</div>
						</button>

						<button class="menu-option grid-item" onclick=@OnAchievementsClicked>
							<span class="option-icon">üèÜ</span>
							<div class="option-text">
								<span class="option-label">Achievements</span>
								<span class="option-desc">Progress</span>
							</div>
						</button>
					</div>
				</div>

				<div class="menu-divider"></div>

				<button class="menu-option danger" onclick=@OnMainMenuClicked>
					<span class="option-icon">üö™</span>
					<div class="option-text">
						<span class="option-label">Return to Main Menu</span>
						<span class="option-desc">Save and exit to title</span>
					</div>
				</button>

				<button class="menu-option small" onclick=@OnCreditsClicked>
					<span class="option-icon small">‚≠ê</span>
					<span class="option-label">Credits</span>
				</button>
			</div>

			<div class="popup-footer">
				<button class="discord-btn" onclick=@OnDiscordClicked>
					<img class="discord-btn-icon" src="/ui/buttons/pixel--discord-white.png" />
					<span>@discordLabel</span>
				</button>
				<button class="cancel-btn" onclick=@Close>Close</button>
			</div>
		</div>
	</root>
}

@code {
	public static MenuPopup Instance { get; private set; }

	public bool IsVisible { get; private set; }

	// Discord link
	private string discordLabel = "Join Discord";
	private string discordDesc = "discord.gg/dJTTyCqKru";
	private const string DiscordLink = "https://discord.gg/dJTTyCqKru";

	protected override void OnAfterTreeRender( bool firstTime )
	{
		if ( firstTime )
		{
			Instance = this;
		}
	}

	public static void Show()
	{
		if ( Instance != null )
		{
			Instance.IsVisible = true;
			Instance.StateHasChanged();
			SoundManager.PlayPopup();
		}
	}

	public static void Hide()
	{
		if ( Instance != null )
		{
			Instance.IsVisible = false;
			Instance.StateHasChanged();
		}
	}

	private void Close()
	{
		SoundManager.PlayBack();
		Hide();
	}

	private void OnTutorialClicked()
	{
		SoundManager.PlayForward();
		Hide();
		TutorialManager.Instance?.RestartTutorial();
	}

	private void OnOptionsClicked()
	{
		SoundManager.PlayForward();
		Hide();
		OptionsPanel.Show();
	}

	private void OnHelpClicked()
	{
		SoundManager.PlayForward();
		Hide();
		HelpPanel.Show();
	}

	private void OnAchievementsClicked()
	{
		SoundManager.PlayForward();
		Hide();
		AchievementPanel.Toggle();
	}

	private void OnCreditsClicked()
	{
		SoundManager.PlayForward();
		Hide();
		CreditsPanel.Show();
	}

	private void OnMainMenuClicked()
	{
		SoundManager.PlayForward();
		Hide();
		GameManager.Instance?.ReturnToMainMenu();
	}

	private async void OnDiscordClicked()
	{
		SoundManager.PlayClick();
		Clipboard.SetText( DiscordLink );
		discordLabel = "Copied!";
		discordDesc = "Link copied to clipboard";
		StateHasChanged();
		await Task.Delay( 2000 );
		discordLabel = "Join Discord";
		discordDesc = "discord.gg/dJTTyCqKru";
		StateHasChanged();
	}

	protected override int BuildHash()
	{
		return HashCode.Combine( IsVisible, discordLabel );
	}
}
