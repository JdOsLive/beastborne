@namespace Beastborne.UI.Components
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@inherits Panel

<div class="active-effects-panel @(isExpanded ? "expanded" : "")">
	<div class="effects-popup @(isExpanded ? "open" : "")">
		<div class="bg-scroll"><img src="ui/bg-patterns/bg-effects.svg" /></div>
		<!-- Header -->
		<div class="ep-header">
			<div class="ep-title">
				<span class="ep-title-icon">âœ¦</span>
				<span>Active Effects</span>
			</div>
			<button class="close-btn" onclick=@ToggleExpanded>
				<img class="close-icon" src="ui/icons/buttons/close.svg" />
				<img class="close-icon-anim" src="ui/icons/animated/close.webp" />
			</button>
		</div>

		<!-- Tabs -->
		<div class="ep-tabs">
			<div class="ep-tab @(currentTab == "boosts" ? "active" : "")" onclick=@(() => SetTab("boosts"))>
				<span>Boosts & Relics</span>
				<span class="ep-tab-count">@GetBoostsRelicsCount()</span>
			</div>
			<div class="ep-tab @(currentTab == "skills" ? "active" : "")" onclick=@(() => SetTab("skills"))>
				<span>Skill Bonuses</span>
				<span class="ep-tab-count">@GetActiveSkillCount()</span>
			</div>
		</div>
		<div class="ep-divider"></div>

		<!-- Scroll Content â€” all items must be direct children for s&box scroll -->
		<div class="ep-scroll">
			@if (currentTab == "boosts")
			{
				@{
					var boosts = GetActiveBoosts();
					var hasEliteInk = HasEliteInk();
					var hasMasterInk = HasMasterInk();
				}

				<!-- Boosts Section Header -->
				<div class="ep-sec-head">
					<div class="ep-sec-title">
						<span class="ep-sec-icon">âš¡</span>
						<span>Boosts</span>
					</div>
					<span class="ep-sec-count">@GetBoostSectionCount()</span>
				</div>

				@if (TamerManager.IsDoubleXPActive)
				{
					<div class="boost-card event-boost">
						<div class="boost-icon event"><span>2X</span></div>
						<div class="boost-info">
							<span class="boost-name">Double XP Weekend</span>
							<span class="boost-desc">2x Tamer XP from all sources</span>
						</div>
						<span class="boost-timer">@FormatEventTime()</span>
						<span class="boost-server">EVENT</span>
					</div>
				}

				@if (boosts.Count == 0 && !hasEliteInk && !hasMasterInk && !TamerManager.IsDoubleXPActive)
				{
					<div class="ep-empty"><span>No active boosts</span></div>
				}
				else
				{
					@foreach (var boost in boosts)
					{
						<div class="boost-card">
							<div class="boost-icon @GetBoostIconClass(boost.Type)">
								<img src="@GetBoostIconPath(boost.Type)" />
							</div>
							<div class="boost-info">
								<span class="boost-name">@GetBoostLabel(boost.Type)</span>
								<span class="boost-desc">@GetBoostDescription(boost.Type, boost.Multiplier)</span>
								@if (boost.IsServer && !string.IsNullOrEmpty(boost.ActivatedBy))
								{
									<span class="boost-source">Activated by @boost.ActivatedBy</span>
								}
							</div>
							<span class="boost-timer @(boost.TimeRemaining.TotalMinutes < 5 ? "expiring" : "")">@FormatBoostTime(boost.TimeRemaining)</span>
							@if (boost.IsServer)
							{
								<span class="boost-server">SERVER</span>
							}
						</div>
					}

					@if (hasEliteInk)
					{
						<div class="boost-card">
							<div class="boost-icon ink"><img src="ui/items/consumables/elite_ink.png" /></div>
							<div class="boost-info">
								<span class="boost-name">Elite Contract Ink</span>
								<span class="boost-desc">+15% catch rate</span>
							</div>
							<span class="boost-timer @(GetEliteInkRemaining().TotalMinutes < 5 ? "expiring" : "")">@FormatBoostTime(GetEliteInkRemaining())</span>
						</div>
					}

					@if (hasMasterInk)
					{
						<div class="boost-card">
							<div class="boost-icon ink"><img src="ui/items/consumables/master_ink.png" /></div>
							<div class="boost-info">
								<span class="boost-name">Master Ink</span>
								<span class="boost-desc">Next capture guaranteed</span>
							</div>
							<span class="boost-timer"><span>1 use</span></span>
						</div>
					}
				}

				<div class="ep-divider"></div>

				<!-- Relics Section Header -->
				@{
					var relics = GetEquippedRelics();
				}

				<div class="ep-sec-head">
					<div class="ep-sec-title">
						<span class="ep-sec-icon">ðŸ’Ž</span>
						<span>Equipped Relics</span>
					</div>
					<span class="ep-sec-count">@relics.Count / 3</span>
				</div>

				@if (relics.Count == 0)
				{
					<div class="ep-empty"><span>No relics equipped</span></div>
				}
				else
				{
					@foreach (var relic in relics)
					{
						<div class="relic-card @GetRarityClass(relic.Rarity)">
							<div class="relic-icon"><img src="@relic.IconPath" /></div>
							<div class="relic-info">
								<span class="relic-name">@relic.Name</span>
								<span class="relic-desc">@GetRelicEffect(relic)</span>
							</div>
							<span class="relic-rarity @GetRarityClass(relic.Rarity)">@relic.Rarity</span>
						</div>
					}
				}
			}
			else
			{
				@{
					var skills = GetActiveSkillBonuses();
				}

				<!-- Skill Bonuses Section Header -->
				<div class="ep-sec-head">
					<div class="ep-sec-title">
						<span class="ep-sec-icon">ðŸŒ¿</span>
						<span>Skill Bonuses</span>
					</div>
					<span class="ep-sec-count">@GetActiveSkillCount()</span>
				</div>

				@if (skills.Count == 0)
				{
					<div class="ep-empty"><span>No skill bonuses active</span></div>
				}
				else
				{
					@foreach (var skill in skills)
					{
						<div class="skill-card">
							<div class="skill-icon"><span>@skill.Icon</span></div>
							<div class="skill-info">
								<span class="skill-name">@skill.Name</span>
								<span class="skill-desc">@skill.Description</span>
							</div>
							<span class="skill-rank"><img class="rank-icon" src="ui/icons/ranking/@GetRankIcon(skill.Rank)" /><span>@skill.Rank</span></span>
						</div>
					}
				}
			}
		</div>
	</div>
</div>

@code {
	private bool isExpanded = false;
	private string currentTab = "boosts";

	// Static instance for external access (bottom bar toggle)
	public static ActiveEffectsPanel Instance { get; private set; }

	public static bool IsEffectsExpanded { get; private set; } = false;

	/// <summary>
	/// Get total active effect count for badge display
	/// </summary>
	public static int TotalEffectCount => Instance?.GetTotalEffectCount() ?? 0;

	protected override void OnAfterTreeRender( bool firstTime )
	{
		if ( firstTime ) Instance = this;
	}

	public void ToggleExpanded()
	{
		isExpanded = !isExpanded;
		IsEffectsExpanded = isExpanded;
		if (isExpanded)
		{
			currentTab = "boosts";
			SoundManager.PlayPopup();
		}
		else
			SoundManager.PlayPopdown();
	}

	private void SetTab(string tab)
	{
		if (currentTab != tab)
		{
			currentTab = tab;
			SoundManager.PlayClick();
		}
	}

	private int GetTotalEffectCount()
	{
		return GetBoostSectionCount() + GetEquippedRelics().Count;
	}

	private int GetBoostsRelicsCount()
	{
		return GetBoostSectionCount() + GetEquippedRelics().Count;
	}

	private int GetBoostSectionCount()
	{
		return GetActiveBoosts().Count + (HasEliteInk() ? 1 : 0) + (HasMasterInk() ? 1 : 0) + (TamerManager.IsDoubleXPActive ? 1 : 0);
	}

	private bool HasEliteInk()
	{
		return TamerManager.Instance?.CurrentTamer?.EliteInkExpiresAt > DateTime.Now;
	}

	private bool HasMasterInk()
	{
		return TamerManager.Instance?.CurrentTamer?.HasMasterInk == true
			|| ItemManager.Instance?.HasItem("boss_master_ink") == true;
	}

	private TimeSpan GetEliteInkRemaining()
	{
		var expiry = TamerManager.Instance?.CurrentTamer?.EliteInkExpiresAt ?? DateTime.MinValue;
		if (expiry <= DateTime.Now) return TimeSpan.Zero;
		return expiry - DateTime.Now;
	}

	private List<(ShopItemType Type, float Multiplier, TimeSpan TimeRemaining, bool IsServer, string ActivatedBy)> GetActiveBoosts()
	{
		return ShopManager.Instance?.GetAllActiveBoosts() ?? new();
	}

	private string GetBoostIconPath(ShopItemType type)
	{
		return type switch
		{
			ShopItemType.TamerXPBoost => "ui/items/boosts/tamer_xp_scroll.png",
			ShopItemType.BeastXPBoost => "ui/items/boosts/beast_xp_tome.png",
			ShopItemType.XPBoost => "ui/items/boosts/tamer_xp_scroll.png",
			ShopItemType.GoldBoost => "ui/items/boosts/gold_multiplier.png",
			ShopItemType.RareEncounter => "ui/items/boosts/rare_radar.png",
			ShopItemType.LuckyCharm => "ui/items/boosts/lucky_clover.png",
			_ => "ui/items/boosts/tamer_xp_scroll.png"
		};
	}

	private string GetBoostIconClass(ShopItemType type)
	{
		return type switch
		{
			ShopItemType.GoldBoost => "gold",
			ShopItemType.TamerXPBoost or ShopItemType.BeastXPBoost or ShopItemType.XPBoost => "xp",
			_ => "ink"
		};
	}

	private string GetBoostLabel(ShopItemType type)
	{
		return type switch
		{
			ShopItemType.TamerXPBoost => "Tamer XP Boost",
			ShopItemType.BeastXPBoost => "Beast XP Boost",
			ShopItemType.XPBoost => "XP Boost",
			ShopItemType.GoldBoost => "Gold Boost",
			ShopItemType.RareEncounter => "Lucky Charm",
			ShopItemType.LuckyCharm => "Lucky Charm",
			_ => type.ToString()
		};
	}

	private string GetBoostDescription(ShopItemType type, float multiplier)
	{
		return type switch
		{
			ShopItemType.TamerXPBoost => $"{multiplier}x Tamer XP gain",
			ShopItemType.BeastXPBoost => $"{multiplier}x Beast XP gain",
			ShopItemType.XPBoost => $"{multiplier}x XP gain",
			ShopItemType.GoldBoost => $"{multiplier}x Gold from battles",
			ShopItemType.RareEncounter => $"{multiplier}x Rare encounter chance",
			ShopItemType.LuckyCharm => $"{multiplier}x Luck bonus",
			_ => $"{multiplier}x bonus"
		};
	}

	private string FormatBoostTime(TimeSpan time)
	{
		if (time.TotalHours >= 1)
			return $"{(int)time.TotalHours}h {time.Minutes}m";
		if (time.TotalMinutes >= 1)
			return $"{(int)time.TotalMinutes}m {time.Seconds}s";
		return $"{time.Seconds}s";
	}

	private string FormatEventTime()
	{
		var remaining = TamerManager.EventXPEnd - DateTime.UtcNow;
		if (remaining.TotalHours >= 1)
			return $"{(int)remaining.TotalHours}h {remaining.Minutes}m";
		if (remaining.TotalMinutes >= 1)
			return $"{(int)remaining.TotalMinutes}m";
		return "Ending soon";
	}

	private List<ItemDefinition> GetEquippedRelics()
	{
		var relicIds = TamerManager.Instance?.CurrentTamer?.EquippedRelics;
		if (relicIds == null || relicIds.Count == 0) return new();

		var relics = new List<ItemDefinition>();
		foreach (var id in relicIds)
		{
			var item = ItemManager.Instance?.GetItem(id);
			if (item != null)
				relics.Add(item);
		}
		return relics;
	}

	private string GetRarityClass(ItemRarity rarity)
	{
		return rarity.ToString().ToLower();
	}

	private string GetRelicEffect(ItemDefinition relic)
	{
		if (relic == null) return "";

		return relic.EffectType switch
		{
			ItemEffectType.PassiveGoldFind => $"+{relic.EffectValue}% Gold from battles",
			ItemEffectType.PassiveItemFind => $"+{relic.EffectValue}% Item find rate",
			ItemEffectType.PassiveCatchRate => $"+{relic.EffectValue}% Contract Success",
			ItemEffectType.PassiveXPGain => $"+{relic.EffectValue}% Monster XP",
			_ => relic.Description
		};
	}

	private int GetActiveSkillCount()
	{
		return TamerManager.Instance?.CurrentTamer?.SkillRanks?.Count ?? 0;
	}

	private List<(string Name, string Icon, string Description, int Rank)> GetActiveSkillBonuses()
	{
		var result = new List<(string, string, string, int)>();
		var tamer = TamerManager.Instance?.CurrentTamer;
		var skillTree = TamerManager.Instance?.SkillTree;

		if (tamer?.SkillRanks == null || skillTree == null) return result;

		foreach (var (skillId, rank) in tamer.SkillRanks)
		{
			var node = skillTree.GetNode(skillId);
			if (node == null) continue;

			string icon = GetBranchIcon(node.Branch);
			string desc = GetSkillBonusDescription(node, rank);
			result.Add((node.Name, icon, desc, rank));
		}

		return result;
	}

	private string GetBranchIcon(SkillBranch branch)
	{
		return branch switch
		{
			SkillBranch.Power => "âš”",
			SkillBranch.Fusion => "âš—",
			SkillBranch.Expedition => "ðŸ—º",
			SkillBranch.Mastery => "ðŸ‘‘",
			SkillBranch.Fortune => "ðŸ’°",
			_ => "ðŸŒ³"
		};
	}

	private string GetSkillBonusDescription(SkillNode node, int rank)
	{
		if (node == null || node.Effects == null || node.Effects.Count == 0)
			return node?.Description ?? "";

		var effect = node.Effects[0];
		float totalValue = effect.Value * rank;

		return effect.Type switch
		{
			SkillEffectType.ShopDiscount => $"{totalValue}% shop discount",
			SkillEffectType.ExpeditionXPBonus or SkillEffectType.XPGainBonus => $"+{totalValue}% XP gain",
			SkillEffectType.ExpeditionGoldBonus or SkillEffectType.GoldDropBonus or SkillEffectType.GoldFindBonus => $"+{totalValue}% gold",
			SkillEffectType.CritChanceBonus or SkillEffectType.CritChance => $"+{totalValue}% crit chance",
			SkillEffectType.CritDamageBonus => $"+{totalValue}% crit damage",
			SkillEffectType.CatchRateBonus => $"+{totalValue}% catch rate",
			SkillEffectType.AllMonsterATKPercent => $"+{totalValue}% ATK",
			SkillEffectType.AllMonsterDEFPercent => $"+{totalValue}% DEF",
			SkillEffectType.AllMonsterHPPercent => $"+{totalValue}% HP",
			SkillEffectType.AllMonsterSPDPercent => $"+{totalValue}% SPD",
			SkillEffectType.GeneticInheritanceBonus or SkillEffectType.GeneInheritanceBonus => $"+{totalValue}% gene inheritance",
			SkillEffectType.BossDamageBonus => $"+{totalValue}% boss damage",
			SkillEffectType.ItemFindBonus => $"+{totalValue}% item find",
			_ => effect.GetDescription()
		};
	}

	private string GetRankIcon(int rank)
	{
		return rank switch
		{
			<= 1 => "bronze.svg",
			<= 2 => "silver.svg",
			<= 3 => "gold.svg",
			<= 5 => "platinum.svg",
			<= 7 => "diamond.svg",
			<= 8 => "legendary.svg",
			<= 9 => "master.svg",
			_ => "mythic.svg"
		};
	}

	public override void Tick()
	{
		base.Tick();

		if (isExpanded && Input.Pressed("Escape"))
		{
			isExpanded = false;
			IsEffectsExpanded = false;
			SoundManager.PlayBack();
		}
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(isExpanded);
		hash.Add(currentTab);
		hash.Add(GetTotalEffectCount());

		var boosts = GetActiveBoosts();
		foreach (var boost in boosts)
		{
			hash.Add((int)boost.TimeRemaining.TotalSeconds);
		}

		hash.Add(HasEliteInk());
		if (HasEliteInk())
			hash.Add((int)GetEliteInkRemaining().TotalSeconds);
		hash.Add(HasMasterInk());

		var relics = GetEquippedRelics();
		foreach (var relic in relics)
		{
			hash.Add(relic.Id);
		}

		hash.Add(GetActiveSkillCount());

		return hash.ToHashCode();
	}
}
