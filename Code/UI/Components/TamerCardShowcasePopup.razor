@namespace Beastborne.UI.Components
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@inherits Panel

<root>
@if (IsVisible && msg != null)
{
	@{
		var gender = (msg.CardGender?.ToLower() ?? "male") == "female" ? "female" : "male";
		var avatar = gender == "female" ? "ui/characters/female/female_tamer.png" : "ui/characters/male/male_tamer.png";
		var rankColor = CompetitiveManager.GetRankColor( msg.CardArenaRank ?? "Unranked" );
		var rankIcon = CompetitiveManager.GetRankIcon( msg.CardArenaRank ?? "Unranked" );
		var expBg = !string.IsNullOrEmpty( msg.CardFavoriteExpeditionId )
			? ExpeditionManager.Instance?.GetExpedition( msg.CardFavoriteExpeditionId )?.BackgroundImage : null;
		var favSpecies = !string.IsNullOrEmpty( msg.CardFavoriteSpeciesId )
			? MonsterManager.Instance?.GetSpecies( msg.CardFavoriteSpeciesId ) : null;
		var elementClass = favSpecies?.Element.ToString().ToLower() ?? "";
		var expName = !string.IsNullOrEmpty( msg.CardFavoriteExpeditionId )
			? (ExpeditionManager.Instance?.GetExpedition( msg.CardFavoriteExpeditionId )?.Name ?? msg.CardFavoriteExpeditionId) : null;
		var winRate = (msg.CardArenaWins + msg.CardArenaLosses) > 0
			? (int)((float)msg.CardArenaWins / (msg.CardArenaWins + msg.CardArenaLosses) * 100) : 0;
	}
	<div class="tc-popup-container">
		<div class="tc-popup-overlay" onclick=@Close></div>
		<div class="cd-modal">
			<button class="cd-close" onclick=@Close>Ã—</button>

			<!-- Hero Banner -->
			<div class="cd-hero">
				@if ( expBg != null )
				{
					<div class="cd-hero-bg" style="background-image: url(@expBg)"></div>
				}
				<div class="cd-hero-content">
					<div class="cd-avatar @gender">
						<img src="@avatar" />
					</div>
					<div class="cd-hero-level">
						<span class="cd-level-label">LEVEL</span>
						<span class="cd-level-num">@msg.CardLevel</span>
					</div>
					<div class="cd-hero-info">
						<span class="cd-name">@msg.CardName</span>
						<span class="cd-title" style="color: #a78bfa">@msg.CardTitle</span>
						<span class="cd-rank-pill" style="border-color: @rankColor">@rankIcon @(msg.CardArenaRank ?? "Unranked")</span>
					</div>
				</div>
			</div>

			<div class="cd-content">
				<!-- Arena Showcase -->
				<div class="cd-arena" style="border-left: 3px solid @rankColor">
					<div class="cd-arena-top">
						<div class="cd-arena-rank">
							<span class="cd-rank-icon" style="color: @rankColor">@rankIcon</span>
							<div class="cd-rank-details">
								<span class="cd-rank-name" style="color: @rankColor">@(msg.CardArenaRank ?? "Unranked")</span>
								<span class="cd-rank-pts">@msg.CardArenaPoints.ToString("N0") pts</span>
							</div>
						</div>
						<div class="cd-winrate" style="color: @rankColor">
							<span class="cd-winrate-val">@winRate%</span>
							<span class="cd-winrate-label">Win Rate</span>
						</div>
					</div>
					<div class="cd-arena-pills">
						<div class="cd-arena-pill">
							<span class="cd-pill-val">@msg.CardArenaWins.ToString("N0")</span>
							<span class="cd-pill-label">Wins</span>
						</div>
						<div class="cd-arena-pill">
							<span class="cd-pill-val">@msg.CardArenaLosses.ToString("N0")</span>
							<span class="cd-pill-label">Losses</span>
						</div>
					</div>
				</div>

				<!-- Stats Grid -->
				<div class="cd-stats">
					<div class="cd-stats-row">
						<div class="cd-stat">
							<span class="cd-stat-val">@msg.CardMonstersCaught.ToString("N0")</span>
							<span class="cd-stat-label">CAUGHT</span>
						</div>
						<div class="cd-stat">
							<span class="cd-stat-val">@msg.CardMonstersBred.ToString("N0")</span>
							<span class="cd-stat-label">BRED</span>
						</div>
						<div class="cd-stat">
							<span class="cd-stat-val">@msg.CardMonstersEvolved.ToString("N0")</span>
							<span class="cd-stat-label">EVOLVED</span>
						</div>
					</div>
					<div class="cd-stats-row">
						<div class="cd-stat">
							<span class="cd-stat-val">@msg.CardBattlesWon.ToString("N0")</span>
							<span class="cd-stat-label">BATTLES WON</span>
						</div>
						<div class="cd-stat">
							<span class="cd-stat-val">@msg.CardAchievementCount.ToString("N0")</span>
							<span class="cd-stat-label">ACHIEVEMENTS</span>
						</div>
						<div class="cd-stat">
							<span class="cd-stat-val">@msg.CardHighestExpedition.ToString("N0")</span>
							<span class="cd-stat-label">HIGHEST STAGE</span>
						</div>
					</div>
				</div>

				<!-- Favorites -->
				<div class="cd-favorites">
					@if ( favSpecies != null )
					{
						<div class="cd-fav-beast @elementClass">
							<span class="cd-fav-label">FAVORITE BEAST</span>
							<div class="cd-fav-row">
								<div class="cd-fav-portrait">
									<img class="cd-fav-portrait-img" src="@favSpecies.IconPath" style="margin-left: @(favSpecies.IconOffsetX - 18)px; margin-top: @(favSpecies.IconOffsetY)px" />
								</div>
								<span class="cd-fav-name">@favSpecies.Name</span>
							</div>
						</div>
					}
					@if ( expName != null )
					{
						<div class="cd-fav-exp">
							@if ( expBg != null )
							{
								<div class="cd-fav-exp-bg" style="background-image: url(@expBg)"></div>
							}
							<span class="cd-fav-label">FAVORITE EXPEDITION</span>
							<span class="cd-fav-name">@expName</span>
						</div>
					}
				</div>
			</div>
		</div>
	</div>
}
</root>

@code {
	public static TamerCardShowcasePopup Instance { get; private set; }

	public bool IsVisible { get; private set; }
	private ChatMessage msg;

	protected override void OnAfterTreeRender(bool firstTime)
	{
		if (firstTime)
		{
			Instance = this;
		}
	}

	public static void Show(ChatMessage message)
	{
		if (Instance != null && message != null)
		{
			Instance.msg = message;
			Instance.IsVisible = true;
			Instance.StateHasChanged();
			SoundManager.PlayPopup();
		}
	}

	public static void Hide()
	{
		if (Instance != null)
		{
			Instance.IsVisible = false;
			Instance.msg = null;
			Instance.StateHasChanged();
		}
	}

	private void Close()
	{
		SoundManager.PlayPopdown();
		Hide();
	}

	public override void Tick()
	{
		base.Tick();

		if (IsVisible && Input.Pressed("Escape"))
		{
			Close();
		}
	}

	protected override int BuildHash()
	{
		return HashCode.Combine(IsVisible, msg?.Id);
	}
}
