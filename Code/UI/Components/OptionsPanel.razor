@namespace Beastborne.UI.Components
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@inherits Panel

<root class="@(IsVisible ? "visible" : "")">
		<div class="options-overlay" onclick=@Close></div>
		<div class="options-panel">
			<div class="options-header">
				<span class="options-title">Options</span>
				<button class="close-btn" onclick=@Close>âœ•</button>
			</div>

			<div class="options-content">
				<!-- Battle Settings -->
				<div class="settings-section">
					<div class="section-header">
						<span class="section-icon">âš”</span>
						<span class="section-title">Battle</span>
					</div>
					<div class="section-content">
						<div class="setting-row">
							<span class="setting-label">Default Battle Speed</span>
							<div class="speed-buttons">
								<button class="@GetSpeedBtnClass(1.0f)" onclick=@(() => SetBattleSpeed(1.0f))>1x</button>
								<button class="@GetSpeedBtnClass(2.0f)" onclick=@(() => SetBattleSpeed(2.0f))>2x</button>
								<button class="@GetSpeedBtnClass(4.0f)" onclick=@(() => SetBattleSpeed(4.0f))>4x</button>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Default Auto-Battle</span>
							<div class="toggle @(GetAutoBattle() ? "active" : "")" onclick=@ToggleAutoBattle>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Default Auto-Retry</span>
							<div class="toggle @(GetAutoRetry() ? "active" : "")" onclick=@ToggleAutoRetry>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Default Auto-Contract</span>
							<div class="toggle @(GetAutoContract() ? "active" : "")" onclick=@ToggleAutoContract>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Skip Battle Animations</span>
							<div class="toggle @(GetSkipAnimations() ? "active" : "")" onclick=@ToggleSkipAnimations>
								<div class="toggle-slider"></div>
							</div>
						</div>
					</div>
				</div>

				<!-- Display Settings -->
				<div class="settings-section">
					<div class="section-header">
						<span class="section-icon">ðŸ–¥</span>
						<span class="section-title">Display</span>
					</div>
					<div class="section-content">
						<div class="setting-row">
							<span class="setting-label">Show Damage Numbers</span>
							<div class="toggle @(GetShowDamageNumbers() ? "active" : "")" onclick=@ToggleShowDamageNumbers>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Show Type Effectiveness</span>
							<div class="toggle @(GetShowTypeEffectiveness() ? "active" : "")" onclick=@ToggleShowTypeEffectiveness>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Show Genetics on Cards</span>
							<div class="toggle @(GetShowGeneticsOnCards() ? "active" : "")" onclick=@ToggleShowGeneticsOnCards>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Compact Card View</span>
							<div class="toggle @(GetCompactCardView() ? "active" : "")" onclick=@ToggleCompactCardView>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Show Power Ratings</span>
							<div class="toggle @(GetShowPowerRatings() ? "active" : "")" onclick=@ToggleShowPowerRatings>
								<div class="toggle-slider"></div>
							</div>
						</div>
					</div>
				</div>

				<!-- Notification Settings -->
				<div class="settings-section">
					<div class="section-header">
						<span class="section-icon">ðŸ””</span>
						<span class="section-title">Notifications</span>
					</div>
					<div class="section-content">
						<div class="setting-row">
							<span class="setting-label">Contract Warning Threshold</span>
							<div class="number-input">
								<button class="num-btn" onclick=@DecreaseContractWarning>-</button>
								<span class="num-value">@GetContractWarning()</span>
								<button class="num-btn" onclick=@IncreaseContractWarning>+</button>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Level Up Notifications</span>
							<div class="toggle @(GetShowLevelUpNotifications() ? "active" : "")" onclick=@ToggleShowLevelUpNotifications>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Discovery Alerts</span>
							<div class="toggle @(GetShowDiscoveryAlerts() ? "active" : "")" onclick=@ToggleShowDiscoveryAlerts>
								<div class="toggle-slider"></div>
							</div>
						</div>
					</div>
				</div>

				<!-- Confirmation Settings -->
				<div class="settings-section">
					<div class="section-header">
						<span class="section-icon">âš </span>
						<span class="section-title">Confirmations</span>
					</div>
					<div class="section-content">
						<div class="setting-row">
							<span class="setting-label">Confirm Before Release</span>
							<div class="toggle @(GetConfirmBeforeRelease() ? "active" : "")" onclick=@ToggleConfirmBeforeRelease>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Confirm Before Fusion</span>
							<div class="toggle @(GetConfirmBeforeFusion() ? "active" : "")" onclick=@ToggleConfirmBeforeFusion>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">Large Purchase Threshold</span>
							<div class="number-input wide">
								<button class="num-btn" onclick=@DecreasePurchaseThreshold>-</button>
								<span class="num-value">@GetPurchaseThreshold()</span>
								<button class="num-btn" onclick=@IncreasePurchaseThreshold>+</button>
							</div>
						</div>
					</div>
				</div>

				<!-- Accessibility Settings -->
				<div class="settings-section">
					<div class="section-header">
						<span class="section-icon">â™¿</span>
						<span class="section-title">Accessibility</span>
					</div>
					<div class="section-content">
						<div class="setting-row">
							<span class="setting-label">Larger Text Mode</span>
							<div class="toggle @(GetLargerTextMode() ? "active" : "")" onclick=@ToggleLargerTextMode>
								<div class="toggle-slider"></div>
							</div>
						</div>
						<div class="setting-row">
							<span class="setting-label">High Contrast Mode</span>
							<div class="toggle @(GetHighContrastMode() ? "active" : "")" onclick=@ToggleHighContrastMode>
								<div class="toggle-slider"></div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="options-footer">
				<button class="reset-btn" onclick=@OnResetClicked>Reset to Defaults</button>
				<button class="done-btn" onclick=@Close>Done</button>
			</div>
		</div>
	</root>

@code {
	public static OptionsPanel Instance { get; private set; }

	public bool IsVisible { get; private set; }

	protected override void OnAfterTreeRender( bool firstTime )
	{
		if ( firstTime )
		{
			Instance = this;
		}
	}

	public static void Show()
	{
		if ( Instance != null )
		{
			Instance.IsVisible = true;
			Instance.StateHasChanged();
			SoundManager.PlayClick();
		}
	}

	public static void Hide()
	{
		if ( Instance != null )
		{
			Instance.IsVisible = false;
			Instance.StateHasChanged();
		}
	}

	private void Close()
	{
		SoundManager.PlayBack();
		Hide();
	}

	// ============================================
	// GETTERS
	// ============================================

	private GameSettings GetSettings() => SettingsManager.Instance?.Settings ?? new GameSettings();

	private float GetBattleSpeed() => GetSettings().DefaultBattleSpeed;
	private bool IsSpeedActive( float speed ) => Math.Abs( GetBattleSpeed() - speed ) < 0.1f;
	private string GetSpeedBtnClass( float speed ) => IsSpeedActive( speed ) ? "speed-btn active" : "speed-btn";
	private bool GetAutoBattle() => GetSettings().DefaultAutoBattle;
	private bool GetAutoRetry() => GetSettings().DefaultAutoRetry;
	private bool GetAutoContract() => GetSettings().DefaultAutoContract;
	private bool GetSkipAnimations() => GetSettings().SkipBattleAnimations;

	private bool GetShowDamageNumbers() => GetSettings().ShowDamageNumbers;
	private bool GetShowTypeEffectiveness() => GetSettings().ShowTypeEffectiveness;
	private bool GetShowGeneticsOnCards() => GetSettings().ShowGeneticsOnCards;
	private bool GetCompactCardView() => GetSettings().CompactCardView;
	private bool GetShowPowerRatings() => GetSettings().ShowPowerRatings;

	private int GetContractWarning() => GetSettings().ContractWarningThreshold;
	private bool GetShowLevelUpNotifications() => GetSettings().ShowLevelUpNotifications;
	private bool GetShowDiscoveryAlerts() => GetSettings().ShowDiscoveryAlerts;

	private bool GetConfirmBeforeRelease() => GetSettings().ConfirmBeforeRelease;
	private bool GetConfirmBeforeFusion() => GetSettings().ConfirmBeforeFusion;
	private int GetPurchaseThreshold() => GetSettings().ConfirmPurchaseThreshold;

	private bool GetLargerTextMode() => GetSettings().LargerTextMode;
	private bool GetHighContrastMode() => GetSettings().HighContrastMode;

	// ============================================
	// SETTERS
	// ============================================

	private void SetBattleSpeed( float speed )
	{
		SettingsManager.Instance?.SetBattleSpeed( speed );
		SoundManager.PlayClick();
		StateHasChanged();
	}

	private void ToggleAutoBattle()
	{
		var current = GetAutoBattle();
		SettingsManager.Instance?.SetAutoBattle( !current );
		PlayToggleSound( !current );
	}

	private void ToggleAutoRetry()
	{
		var current = GetAutoRetry();
		SettingsManager.Instance?.SetAutoRetry( !current );
		PlayToggleSound( !current );
	}

	private void ToggleAutoContract()
	{
		var current = GetAutoContract();
		SettingsManager.Instance?.SetAutoContract( !current );
		PlayToggleSound( !current );
	}

	private void ToggleSkipAnimations()
	{
		var current = GetSkipAnimations();
		SettingsManager.Instance?.SetSkipAnimations( !current );
		PlayToggleSound( !current );
	}

	private void ToggleShowDamageNumbers()
	{
		var current = GetShowDamageNumbers();
		SettingsManager.Instance?.SetShowDamageNumbers( !current );
		PlayToggleSound( !current );
	}

	private void ToggleShowTypeEffectiveness()
	{
		var current = GetShowTypeEffectiveness();
		SettingsManager.Instance?.SetShowTypeEffectiveness( !current );
		PlayToggleSound( !current );
	}

	private void ToggleShowGeneticsOnCards()
	{
		var current = GetShowGeneticsOnCards();
		SettingsManager.Instance?.SetShowGeneticsOnCards( !current );
		PlayToggleSound( !current );
	}

	private void ToggleCompactCardView()
	{
		var current = GetCompactCardView();
		SettingsManager.Instance?.SetCompactCardView( !current );
		PlayToggleSound( !current );
	}

	private void ToggleShowPowerRatings()
	{
		var current = GetShowPowerRatings();
		SettingsManager.Instance?.SetShowPowerRatings( !current );
		PlayToggleSound( !current );
	}

	private void DecreaseContractWarning()
	{
		var current = GetContractWarning();
		if ( current > 0 )
		{
			SettingsManager.Instance?.SetContractWarningThreshold( current - 1 );
			SoundManager.PlayClick();
		}
	}

	private void IncreaseContractWarning()
	{
		var current = GetContractWarning();
		if ( current < 20 )
		{
			SettingsManager.Instance?.SetContractWarningThreshold( current + 1 );
			SoundManager.PlayClick();
		}
	}

	private void ToggleShowLevelUpNotifications()
	{
		var current = GetShowLevelUpNotifications();
		SettingsManager.Instance?.SetShowLevelUpNotifications( !current );
		PlayToggleSound( !current );
	}

	private void ToggleShowDiscoveryAlerts()
	{
		var current = GetShowDiscoveryAlerts();
		SettingsManager.Instance?.SetShowDiscoveryAlerts( !current );
		PlayToggleSound( !current );
	}

	private void ToggleConfirmBeforeRelease()
	{
		var current = GetConfirmBeforeRelease();
		SettingsManager.Instance?.SetConfirmBeforeRelease( !current );
		PlayToggleSound( !current );
	}

	private void ToggleConfirmBeforeFusion()
	{
		var current = GetConfirmBeforeFusion();
		SettingsManager.Instance?.SetConfirmBeforeFusion( !current );
		PlayToggleSound( !current );
	}

	private void DecreasePurchaseThreshold()
	{
		var current = GetPurchaseThreshold();
		var newValue = current <= 100 ? 0 : current - 500;
		SettingsManager.Instance?.SetConfirmPurchaseThreshold( Math.Max( 0, newValue ) );
		SoundManager.PlayClick();
	}

	private void IncreasePurchaseThreshold()
	{
		var current = GetPurchaseThreshold();
		var newValue = current == 0 ? 100 : current + 500;
		SettingsManager.Instance?.SetConfirmPurchaseThreshold( Math.Min( 10000, newValue ) );
		SoundManager.PlayClick();
	}

	private void ToggleLargerTextMode()
	{
		var current = GetLargerTextMode();
		SettingsManager.Instance?.SetLargerTextMode( !current );
		PlayToggleSound( !current );
	}

	private void ToggleHighContrastMode()
	{
		var current = GetHighContrastMode();
		SettingsManager.Instance?.SetHighContrastMode( !current );
		PlayToggleSound( !current );
	}

	private void PlayToggleSound( bool newState )
	{
		if ( newState )
			SoundManager.PlayToggleOn();
		else
			SoundManager.PlayToggleOff();
	}

	private void OnResetClicked()
	{
		SettingsManager.Instance?.ResetToDefaults();
		SoundManager.PlayClick();
		NotificationManager.Instance?.AddNotification( NotificationType.Info, "Settings Reset", "All settings have been reset to defaults." );
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add( IsVisible );
		if ( SettingsManager.Instance?.Settings != null )
		{
			var s = SettingsManager.Instance.Settings;
			hash.Add( s.DefaultBattleSpeed );
			hash.Add( s.DefaultAutoBattle );
			hash.Add( s.DefaultAutoRetry );
			hash.Add( s.DefaultAutoContract );
			hash.Add( s.SkipBattleAnimations );
			hash.Add( s.ShowDamageNumbers );
			hash.Add( s.ShowTypeEffectiveness );
			hash.Add( s.ShowGeneticsOnCards );
			hash.Add( s.CompactCardView );
			hash.Add( s.ShowPowerRatings );
			hash.Add( s.ContractWarningThreshold );
			hash.Add( s.ShowLevelUpNotifications );
			hash.Add( s.ShowDiscoveryAlerts );
			hash.Add( s.ConfirmBeforeRelease );
			hash.Add( s.ConfirmBeforeFusion );
			hash.Add( s.ConfirmPurchaseThreshold );
			hash.Add( s.LargerTextMode );
			hash.Add( s.HighContrastMode );
		}
		return hash.ToHashCode();
	}
}
