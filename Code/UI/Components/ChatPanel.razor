@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@namespace Beastborne.UI.Components
@inherits Panel

<root class="@(isExpanded ? "expanded" : "collapsed") @(hasUnread ? "has-unread" : "")">
	<div class="chat-overlay @(isExpanded ? "open" : "")">
			<div class="bg-scroll"><img src="ui/bg-patterns/bg-chat.svg" /></div>
			<!-- Header -->
			<div class="chat-header">
				<div class="header-left">
					<img class="chat-icon" src="ui/icons/buttons/chat.svg" />
					<span class="chat-title">CHAT</span>
				</div>
				<div class="header-right">
					<div class="online-badge">
						<div class="online-dot"><span> </span></div>
						<span class="online-count">@GetOnlineCount() online</span>
					</div>
					<button class="close-btn" onclick=@ToggleChat><img class="close-icon" src="ui/icons/buttons/close.svg" /><img class="close-icon-anim" src="ui/icons/animated/close.webp" /></button>
				</div>
			</div>

			<!-- Channel Tabs -->
			<div class="channel-tabs">
				<div class="ch-tab @(currentChannel == "global" ? "active" : "")" onclick=@(() => SetChannel("global"))><span>Global</span></div>
				<div class="ch-tab @(currentChannel == "guild" ? "active" : "") disabled"><span>Guild</span></div>
				<div class="ch-tab @(currentChannel == "trade" ? "active" : "") disabled"><span>Trade</span></div>
				<div class="ch-tab @(currentChannel == "help" ? "active" : "") disabled"><span>Help</span></div>
			</div>

			<!-- Messages -->
			<div class="chat-messages" @ref="messagesContainer">
				@foreach (var message in GetMessages())
				{
					@if (message.Type == ChatMessageType.Player)
					{
						<!-- Player Message -->
						<div class="msg">
							<div class="msg-avatar av-@message.ResolvedNameColor">
								<img src="avatar:@message.SteamId" />
								@{
									var playerLevel = GetPlayerLevel(message);
								}
								@if (playerLevel > 0)
								{
									<div class="lv-pip"><span>@playerLevel</span></div>
								}
							</div>
							<div class="msg-body">
								<div class="msg-top">
									@if (message.IsDeveloper)
									{
										<span class="role-pill dev">DEV</span>
									}
									<span class="msg-name c-@message.ResolvedNameColor">@message.PlayerName</span>
									<span class="msg-time">@message.FormattedTime</span>
								</div>
								<span class="msg-text">@message.Content</span>
							</div>
						</div>
					}
					else if (message.Type == ChatMessageType.BeastShowcase)
					{
						@{
							var beSpecies = !string.IsNullOrEmpty(message.ShowcaseSpeciesId)
								? MonsterManager.Instance?.GetSpecies(message.ShowcaseSpeciesId)
								: null;
							var beOffsetX = beSpecies?.IconOffsetX ?? 0f;
							var beOffsetY = beSpecies?.IconOffsetY ?? 0f;
						}
						<!-- Beast Showcase -->
						<div class="msg">
							<div class="msg-avatar av-@message.ResolvedNameColor">
								<img src="avatar:@message.SteamId" />
							</div>
							<div class="msg-body">
								<div class="msg-top">
									@if (message.IsDeveloper)
									{
										<span class="role-pill dev">DEV</span>
									}
									<span class="msg-name c-@message.ResolvedNameColor">@message.PlayerName</span>
									<span class="msg-time">@message.FormattedTime</span>
								</div>
								<div class="beast-embed @message.ShowcaseElement.ToLower()" onclick=@(() => ShowShowcasePopup(message))>
									<div class="be-art">
										@if (!string.IsNullOrEmpty(message.IconPath))
										{
											<img src="@message.IconPath" style="margin-left: @(beOffsetX - 18)px; margin-top: @(beOffsetY)px" />
										}
									</div>
									<div class="be-info">
										<span class="be-name">@message.ShowcaseNickname</span>
										<div class="be-stats">
											<span class="be-stat">LV @message.ShowcaseLevel</span>
											<span class="be-sep">·</span>
											<span class="be-stat">PWR @message.ShowcasePower</span>
											<span class="be-sep">·</span>
											<span class="be-rarity @message.ShowcaseRarity.ToLower()">@message.ShowcaseRarity.ToUpper()</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					}
					else if (message.Type == ChatMessageType.TamerCardShowcase)
					{
						@{
							var tcGenderClass = (message.CardGender?.ToLower() ?? "male") == "female" ? "female" : "male";
							var tcAvatarPath = tcGenderClass == "female"
								? "ui/characters/female/female_tamer.png"
								: "ui/characters/male/male_tamer.png";
							var tcExpBg = !string.IsNullOrEmpty( message.CardFavoriteExpeditionId )
								? ExpeditionManager.Instance?.GetExpedition( message.CardFavoriteExpeditionId )?.BackgroundImage
								: null;
							var tcFavSpecies = !string.IsNullOrEmpty( message.CardFavoriteSpeciesId )
								? MonsterManager.Instance?.GetSpecies( message.CardFavoriteSpeciesId )
								: null;
							var tcRankColor = CompetitiveManager.GetRankColor( message.CardArenaRank ?? "Unranked" );
						}
						<!-- Tamer Card Showcase -->
						<div class="msg">
							<div class="msg-avatar av-@message.ResolvedNameColor">
								<img src="avatar:@message.SteamId" />
							</div>
							<div class="msg-body">
								<div class="msg-top">
									@if (message.IsDeveloper)
									{
										<span class="role-pill dev">DEV</span>
									}
									<span class="msg-name c-@message.ResolvedNameColor">@message.PlayerName</span>
									<span class="msg-time">@message.FormattedTime</span>
								</div>
								<span class="tc-shared-text">shared their Tamer Card</span>
								<div class="tc-showcase" onclick=@(() => ShowTamerCardPopup(message))>
									@if ( tcExpBg != null )
									{
										<div class="tc-showcase-bg" style="background-image: url(@tcExpBg)"></div>
									}
									<div class="tc-showcase-content">
										<div class="tc-showcase-avatar @tcGenderClass">
											<img src="@tcAvatarPath" />
										</div>
										<div class="tc-showcase-info">
											<div class="tc-showcase-name-row">
												@if (message.IsDeveloper)
												{
													<span class="role-pill dev">DEV</span>
												}
												<span class="tc-showcase-name">@message.CardName</span>
											</div>
											<span class="tc-showcase-title">@message.CardTitle</span>
											<div class="tc-showcase-stats">
												<span class="tc-showcase-level">Lv. @message.CardLevel</span>
												<span class="tc-showcase-rank" style="color: @tcRankColor">@(message.CardArenaRank ?? "Unranked")</span>
												<span class="tc-showcase-pts">@message.CardArenaPoints pts</span>
											</div>
										</div>
									</div>
									@if ( tcFavSpecies != null && !string.IsNullOrEmpty( tcFavSpecies.IconPath ) )
									{
										<img class="tc-showcase-beast" src="@tcFavSpecies.IconPath" />
									}
								</div>
							</div>
						</div>
					}
					else if (message.Type == ChatMessageType.Join)
					{
						<!-- Join Message -->
						<div class="msg-join">
							<span class="arrow-in">→</span>
							<span class="jn">@message.PlayerName</span>
							<span class="join-text">joined the server</span>
						</div>
					}
					else if (message.Type == ChatMessageType.Leave)
					{
						<!-- Leave Message -->
						<div class="msg-join">
							<span class="arrow-out">←</span>
							<span class="jn">@message.PlayerName</span>
							<span class="join-text">left the server</span>
						</div>
					}
					else if (message.Type == ChatMessageType.Achievement)
					{
						<!-- Achievement Message -->
						<div class="msg-achievement">
							@if (!string.IsNullOrEmpty(message.IconPath))
							{
								<img class="sys-icon-img" src="@message.IconPath" />
							}
							else
							{
								<img class="sys-icon" src="ui/icons/buttons/info.svg" />
							}
							<span class="sys-text">@message.Content</span>
						</div>
					}
					else
					{
						<!-- System Message -->
						<div class="msg-system">
							<img class="sys-icon" src="ui/icons/buttons/info.svg" />
							<span class="sys-text">@message.Content</span>
						</div>
					}
				}
			</div>

			<!-- Input Area -->
			<div class="chat-input-area">
				<div class="input-row">
					<ChatInputBox @ref="chatInputBox" OnSubmit=@OnSendMessage />
					<button class="send-btn" onclick=@OnSendMessage>
						<img class="send-icon" src="ui/icons/buttons/send.svg" />
					</button>
				</div>
			</div>
		</div>
	</div>
</root>

@code {
	private bool isExpanded = false;
	private bool hasUnread = false;
	private int unreadCount = 0;
	private string currentChannel = "global";
	private Panel messagesContainer;
	private ChatInputBox chatInputBox;

	// Static instance for external access (bottom bar toggle)
	public static ChatPanel Instance { get; private set; }

	// Track if we're focused on chat input
	public static bool IsChatFocused { get; set; } = false;

	/// <summary>
	/// Get unread message count for badge display
	/// </summary>
	public static int UnreadMessageCount => Instance?.unreadCount ?? 0;

	private void ShowShowcasePopup(ChatMessage message)
	{
		BeastShowcasePopup.Show(message);
	}

	private void ShowTamerCardPopup(ChatMessage message)
	{
		TamerCardShowcasePopup.Show(message);
	}

	protected override void OnAfterTreeRender(bool firstTime)
	{
		if (firstTime)
		{
			Instance = this;

			if (ChatManager.Instance != null)
			{
				ChatManager.Instance.OnMessageReceived += OnMessageReceived;
				ChatManager.Instance.OnMessagesCleared += OnMessagesCleared;
			}
		}
	}

	public override void OnDeleted()
	{
		if (ChatManager.Instance != null)
		{
			ChatManager.Instance.OnMessageReceived -= OnMessageReceived;
			ChatManager.Instance.OnMessagesCleared -= OnMessagesCleared;
		}
		IsChatFocused = false;
	}

	private void OnMessageReceived(ChatMessage message)
	{
		if (!isExpanded)
		{
			hasUnread = true;
			unreadCount++;
		}
		else
		{
			_ = ScrollToBottomDelayed();
		}

		StateHasChanged();
	}

	private void OnMessagesCleared()
	{
		hasUnread = false;
		unreadCount = 0;
		StateHasChanged();
	}

	public void ToggleChat()
	{
		isExpanded = !isExpanded;

		if (isExpanded)
		{
			SoundManager.PlayPopup();
			hasUnread = false;
			unreadCount = 0;
			_ = FocusInputDelayed();
			_ = ScrollToBottomDelayed();
		}
		else
		{
			SoundManager.PlayPopdown();
			IsChatFocused = false;
		}
	}

	private async Task FocusInputDelayed()
	{
		await Task.Delay(100);
		chatInputBox?.FocusInput();
		IsChatFocused = true;
	}

	private async Task ScrollToBottomDelayed()
	{
		await Task.Delay(50);
		if (messagesContainer != null)
		{
			messagesContainer.ScrollOffset = new Vector2(0, messagesContainer.ScrollSize.y);
		}
	}

	private void OnSendMessage()
	{
		var text = chatInputBox?.GetText() ?? "";
		if (string.IsNullOrWhiteSpace(text)) return;

		ChatManager.Instance?.SendMessage(text);
		chatInputBox?.ClearText();
		SoundManager.PlayForward();
		chatInputBox?.FocusInput();
	}

	private List<ChatMessage> GetMessages()
	{
		return ChatManager.Instance?.GetRecentMessages(50) ?? new List<ChatMessage>();
	}

	private int GetOnlineCount()
	{
		return ChatManager.Instance?.OnlinePlayerCount ?? 1;
	}

	private void SetChannel(string channel)
	{
		currentChannel = channel;
		SoundManager.PlayClick();
	}

	private int GetPlayerLevel(ChatMessage message)
	{
		// Local player — get from current tamer
		if (message.SteamId == (ChatManager.Instance?.LocalSteamId ?? 0))
		{
			return TamerManager.Instance?.CurrentTamer?.Level ?? 0;
		}

		// Remote players — card showcase messages carry level data
		if (message.CardLevel > 0) return message.CardLevel;

		return 0;
	}

	public override void Tick()
	{
		base.Tick();

		if (isExpanded)
		{
			if (Input.Pressed("Escape"))
			{
				isExpanded = false;
				IsChatFocused = false;
				SoundManager.PlayPopdown();
			}
		}
		else
		{
			if (Input.Pressed("Chat") || Input.Pressed("Enter"))
			{
				isExpanded = true;
				hasUnread = false;
				unreadCount = 0;
				_ = FocusInputDelayed();
				SoundManager.PlayPopup();
			}
		}
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(isExpanded);
		hash.Add(hasUnread);
		hash.Add(unreadCount);
		hash.Add(currentChannel);
		hash.Add(chatInputBox?.GetText());
		hash.Add(ChatManager.Instance?.Messages?.Count ?? 0);
		hash.Add(GetOnlineCount());
		return hash.ToHashCode();
	}
}
