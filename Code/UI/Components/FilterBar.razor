@namespace Beastborne.UI.Components
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@inherits Panel

<root class="filter-bar">
	<!-- Element Dropdown -->
	<div class="dropdown-container">
		<button class="dropdown-btn element-btn @GetElementClass(CurrentElement)" onclick=@ToggleElementDropdown>
			<span class="dropdown-icon">@GetElementIcon(CurrentElement)</span>
			<span class="dropdown-label">@GetElementLabel(CurrentElement)</span>
			<span class="dropdown-arrow @(elementDropdownOpen ? "open" : "")">‚ñº</span>
		</button>
		@if (elementDropdownOpen)
		{
			<div class="dropdown-menu element-menu">
				<div class="dropdown-item @(CurrentElement == "all" ? "active" : "")" onclick=@(() => SelectElement("all"))>
					<span class="item-icon">‚óã</span>
					<span class="item-label">All</span>
				</div>
				<div class="dropdown-item neutral @(CurrentElement == "neutral" ? "active" : "")" onclick=@(() => SelectElement("neutral"))>
					<span class="item-icon">‚óê</span>
					<span class="item-label">Neutral</span>
				</div>
				<div class="dropdown-divider"></div>
				<div class="dropdown-item fire @(CurrentElement == "fire" ? "active" : "")" onclick=@(() => SelectElement("fire"))>
					<span class="item-icon">üî•</span>
					<span class="item-label">Fire</span>
				</div>
				<div class="dropdown-item water @(CurrentElement == "water" ? "active" : "")" onclick=@(() => SelectElement("water"))>
					<span class="item-icon">üíß</span>
					<span class="item-label">Water</span>
				</div>
				<div class="dropdown-item earth @(CurrentElement == "earth" ? "active" : "")" onclick=@(() => SelectElement("earth"))>
					<span class="item-icon">ü™®</span>
					<span class="item-label">Earth</span>
				</div>
				<div class="dropdown-item wind @(CurrentElement == "wind" ? "active" : "")" onclick=@(() => SelectElement("wind"))>
					<span class="item-icon">üí®</span>
					<span class="item-label">Wind</span>
				</div>
				<div class="dropdown-item electric @(CurrentElement == "electric" ? "active" : "")" onclick=@(() => SelectElement("electric"))>
					<span class="item-icon">‚ö°</span>
					<span class="item-label">Electric</span>
				</div>
				<div class="dropdown-item ice @(CurrentElement == "ice" ? "active" : "")" onclick=@(() => SelectElement("ice"))>
					<span class="item-icon">‚ùÑ</span>
					<span class="item-label">Ice</span>
				</div>
				<div class="dropdown-item nature @(CurrentElement == "nature" ? "active" : "")" onclick=@(() => SelectElement("nature"))>
					<span class="item-icon">üåø</span>
					<span class="item-label">Nature</span>
				</div>
				<div class="dropdown-item metal @(CurrentElement == "metal" ? "active" : "")" onclick=@(() => SelectElement("metal"))>
					<span class="item-icon">‚öô</span>
					<span class="item-label">Metal</span>
				</div>
				<div class="dropdown-item shadow @(CurrentElement == "shadow" ? "active" : "")" onclick=@(() => SelectElement("shadow"))>
					<span class="item-icon">üåë</span>
					<span class="item-label">Shadow</span>
				</div>
				<div class="dropdown-item spirit @(CurrentElement == "spirit" ? "active" : "")" onclick=@(() => SelectElement("spirit"))>
					<span class="item-icon">‚ú®</span>
					<span class="item-label">Spirit</span>
				</div>
			</div>
		}
	</div>

	<!-- Rarity Dropdown (optional) -->
	@if (ShowRarityFilter)
	{
		<div class="dropdown-container">
			<button class="dropdown-btn rarity-btn @GetRarityClass(CurrentRarity)" onclick=@ToggleRarityDropdown>
				<span class="dropdown-icon">‚òÖ</span>
				<span class="dropdown-label">@GetRarityLabel(CurrentRarity)</span>
				<span class="dropdown-arrow @(rarityDropdownOpen ? "open" : "")">‚ñº</span>
			</button>
			@if (rarityDropdownOpen)
			{
				<div class="dropdown-menu rarity-menu">
					<div class="dropdown-item @(CurrentRarity == "all" ? "active" : "")" onclick=@(() => SelectRarity("all"))>
						<span class="item-label">All Rarities</span>
					</div>
					<div class="dropdown-divider"></div>
					<div class="dropdown-item common @(CurrentRarity == "common" ? "active" : "")" onclick=@(() => SelectRarity("common"))>
						<span class="item-label">Common</span>
					</div>
					<div class="dropdown-item uncommon @(CurrentRarity == "uncommon" ? "active" : "")" onclick=@(() => SelectRarity("uncommon"))>
						<span class="item-label">Uncommon</span>
					</div>
					<div class="dropdown-item rare @(CurrentRarity == "rare" ? "active" : "")" onclick=@(() => SelectRarity("rare"))>
						<span class="item-label">Rare</span>
					</div>
					<div class="dropdown-item epic @(CurrentRarity == "epic" ? "active" : "")" onclick=@(() => SelectRarity("epic"))>
						<span class="item-label">Epic</span>
					</div>
					<div class="dropdown-item legendary @(CurrentRarity == "legendary" ? "active" : "")" onclick=@(() => SelectRarity("legendary"))>
						<span class="item-label">Legendary</span>
					</div>
					<div class="dropdown-item mythic @(CurrentRarity == "mythic" ? "active" : "")" onclick=@(() => SelectRarity("mythic"))>
						<span class="item-label">Mythic</span>
					</div>
				</div>
			}
		</div>
	}

	<!-- Sort Dropdown -->
	<div class="dropdown-container">
		<button class="dropdown-btn sort-btn" onclick=@ToggleSortDropdown>
			<span class="dropdown-icon">@GetSortIcon(CurrentSort)</span>
			<span class="dropdown-label">@GetSortLabel(CurrentSort)</span>
			<span class="dropdown-arrow @(sortDropdownOpen ? "open" : "")">‚ñº</span>
		</button>
		@if (sortDropdownOpen)
		{
			<div class="dropdown-menu sort-menu">
				@if (ShowBeastiarySort)
				{
					<div class="dropdown-item @(CurrentSort == "beastiary" ? "active" : "")" onclick=@(() => SelectSort("beastiary"))>
						<span class="item-icon">üìñ</span>
						<span class="item-label">Beastiary</span>
					</div>
				}
				<div class="dropdown-item @(CurrentSort == "power" ? "active" : "")" onclick=@(() => SelectSort("power"))>
					<span class="item-icon">‚öî</span>
					<span class="item-label">Power</span>
				</div>
				@if (!HideMonsterOnlySorts)
				{
					<div class="dropdown-item @(CurrentSort == "level" ? "active" : "")" onclick=@(() => SelectSort("level"))>
						<span class="item-icon">‚Üë</span>
						<span class="item-label">Level</span>
					</div>
					<div class="dropdown-item @(CurrentSort == "genes" ? "active" : "")" onclick=@(() => SelectSort("genes"))>
						<span class="item-icon">üß¨</span>
						<span class="item-label">Genes</span>
					</div>
				}
				<div class="dropdown-item @(CurrentSort == "basestats" ? "active" : "")" onclick=@(() => SelectSort("basestats"))>
					<span class="item-icon">üìä</span>
					<span class="item-label">Base Stats</span>
				</div>
				@if (!HideMonsterOnlySorts)
				{
					<div class="dropdown-divider"></div>
					<div class="dropdown-item fav @(CurrentSort == "fav" ? "active" : "")" onclick=@(() => SelectSort("fav"))>
						<span class="item-icon">‚ô•</span>
						<span class="item-label">Favorites</span>
					</div>
					<div class="dropdown-item @(CurrentSort == "recent" ? "active" : "")" onclick=@(() => SelectSort("recent"))>
						<span class="item-icon">‚è±</span>
						<span class="item-label">Recent</span>
					</div>
				}
				<div class="dropdown-divider"></div>
				<div class="dropdown-item @(CurrentSort == "name" ? "active" : "")" onclick=@OpenNameSearch>
					<span class="item-icon">üîç</span>
					<span class="item-label">Search Name...</span>
				</div>
			</div>
		}
	</div>

	<!-- Sort Direction Toggle -->
	<button class="sort-direction-btn" onclick=@ToggleSortDirection>
		@(SortAscending ? "‚Üë" : "‚Üì")
	</button>

	<!-- Name Search Popup -->
	@if (nameSearchOpen)
	{
		<div class="search-overlay" onclick=@OnOverlayClicked>
			<div class="search-popup" onclick=@OnPopupClicked>
				<div class="search-header">
					<span class="search-title">Search by Name</span>
					<button class="search-close" onclick=@CloseNameSearch>√ó</button>
				</div>
				<div class="search-input-wrapper">
					<TextEntry class="search-input" @ref="searchInput" Text="@searchText" Placeholder="Type to filter..." />
				</div>
				<div class="search-results">
					@foreach (var name in GetFilteredNames())
					{
						var species = GetSpeciesByName(name);
						<div class="search-result" onclick=@(() => SelectName(name))>
							@if (species != null)
							{
								<span class="result-number">#@species.BeastiaryNumber</span>
								<span class="result-element">@GetElementEmoji(species.Element)</span>
							}
							<span class="result-name">@name</span>
						</div>
					}
					@if (GetFilteredNames().Count == 0)
					{
						<div class="search-empty">No matches found</div>
					}
				</div>
			</div>
		</div>
	}
</root>

@code {
	// Properties that parent panels bind to
	[Property] public string CurrentElement { get; set; } = "all";
	[Property] public string CurrentSort { get; set; } = "power";
	[Property] public string CurrentRarity { get; set; } = "all";
	[Property] public string CurrentNameFilter { get; set; } = "";
	[Property] public bool SortAscending { get; set; } = false; // false = descending (high to low), true = ascending (low to high)

	// Feature toggles
	[Property] public bool ShowBeastiarySort { get; set; } = false;
	[Property] public bool ShowRarityFilter { get; set; } = false;
	[Property] public bool HideMonsterOnlySorts { get; set; } = false; // Hides Level, Genes, Favorites, Recent (for Beastiary)

	// Callbacks
	[Property] public Action<string> OnElementChanged { get; set; }
	[Property] public Action<string> OnSortChanged { get; set; }
	[Property] public Action<string> OnRarityChanged { get; set; }
	[Property] public Action<string> OnNameFilterChanged { get; set; }
	[Property] public Action<bool> OnSortDirectionChanged { get; set; }

	// Available names for search (set by parent)
	[Property] public List<string> AvailableNames { get; set; } = new();

	// Internal state
	private bool elementDropdownOpen = false;
	private bool sortDropdownOpen = false;
	private bool rarityDropdownOpen = false;
	private bool nameSearchOpen = false;
	private string searchText = "";
	private TextEntry searchInput;

	private void ToggleElementDropdown()
	{
		elementDropdownOpen = !elementDropdownOpen;
		sortDropdownOpen = false;
		rarityDropdownOpen = false;
		SoundManager.PlayClick();
	}

	private void ToggleSortDropdown()
	{
		sortDropdownOpen = !sortDropdownOpen;
		elementDropdownOpen = false;
		rarityDropdownOpen = false;
		SoundManager.PlayClick();
	}

	private void ToggleRarityDropdown()
	{
		rarityDropdownOpen = !rarityDropdownOpen;
		elementDropdownOpen = false;
		sortDropdownOpen = false;
		SoundManager.PlayClick();
	}

	private void ToggleSortDirection()
	{
		SortAscending = !SortAscending;
		OnSortDirectionChanged?.Invoke(SortAscending);
		SoundManager.PlayClick();
	}

	private void SelectElement(string element)
	{
		CurrentElement = element;
		elementDropdownOpen = false;
		OnElementChanged?.Invoke(element);
		SoundManager.PlaySelect();
	}

	private void SelectSort(string sort)
	{
		CurrentSort = sort;
		sortDropdownOpen = false;
		OnSortChanged?.Invoke(sort);
		SoundManager.PlaySelect();
	}

	private void SelectRarity(string rarity)
	{
		CurrentRarity = rarity;
		rarityDropdownOpen = false;
		OnRarityChanged?.Invoke(rarity);
		SoundManager.PlaySelect();
	}

	private void OpenNameSearch()
	{
		sortDropdownOpen = false;
		nameSearchOpen = true;
		searchText = "";
		SoundManager.PlayForward();
	}

	private void CloseNameSearch()
	{
		nameSearchOpen = false;
		SoundManager.PlayBack();
	}

	// Flag to track if popup was clicked (to prevent overlay close)
	private bool popupClicked = false;

	private void OnPopupClicked()
	{
		// Mark that the popup was clicked - don't close
		popupClicked = true;
	}

	private void OnOverlayClicked()
	{
		// Only close if the popup wasn't clicked
		if (!popupClicked)
		{
			CloseNameSearch();
		}
		popupClicked = false;
	}

	private void SelectName(string name)
	{
		CurrentNameFilter = name;
		CurrentSort = "name";
		nameSearchOpen = false;
		OnNameFilterChanged?.Invoke(name);
		OnSortChanged?.Invoke("name");
		SoundManager.PlaySelect();
	}

	private List<string> GetFilteredNames()
	{
		if (string.IsNullOrEmpty(searchText))
			return AvailableNames.Take(20).ToList();

		return AvailableNames
			.Where(n => n.ToLower().Contains(searchText.ToLower()))
			.Take(20)
			.ToList();
	}

	private MonsterSpecies GetSpeciesByName(string name)
	{
		return MonsterManager.Instance?.GetAllSpecies()?.FirstOrDefault(s => s.Name == name);
	}

	private string GetElementEmoji(ElementType element)
	{
		return element switch
		{
			ElementType.Fire => "üî•",
			ElementType.Water => "üíß",
			ElementType.Earth => "ü™®",
			ElementType.Wind => "üí®",
			ElementType.Electric => "‚ö°",
			ElementType.Ice => "‚ùÑ",
			ElementType.Nature => "üåø",
			ElementType.Metal => "‚öô",
			ElementType.Shadow => "üåë",
			ElementType.Spirit => "‚ú®",
			_ => "‚óê"
		};
	}

	// Close dropdowns when clicking elsewhere
	public void CloseAllDropdowns()
	{
		elementDropdownOpen = false;
		sortDropdownOpen = false;
		rarityDropdownOpen = false;
	}

	// UI Helpers
	private string GetElementClass(string element)
	{
		if (element == "all" || element == "neutral") return "";
		return element;
	}

	private string GetElementIcon(string element)
	{
		return element switch
		{
			"all" => "‚óã",
			"neutral" => "‚óê",
			"fire" => "üî•",
			"water" => "üíß",
			"earth" => "ü™®",
			"wind" => "üí®",
			"electric" => "‚ö°",
			"ice" => "‚ùÑ",
			"nature" => "üåø",
			"metal" => "‚öô",
			"shadow" => "üåë",
			"spirit" => "‚ú®",
			_ => "‚óã"
		};
	}

	private string GetElementLabel(string element)
	{
		if (element == "all") return "All Elements";
		return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(element);
	}

	private string GetSortIcon(string sort)
	{
		return sort switch
		{
			"power" => "‚öî",
			"level" => "‚Üë",
			"genes" => "üß¨",
			"basestats" => "üìä",
			"rarity" => "‚òÖ",
			"fav" => "‚ô•",
			"recent" => "‚è±",
			"beastiary" => "üìñ",
			"name" => "üîç",
			_ => "‚öî"
		};
	}

	private string GetSortLabel(string sort)
	{
		return sort switch
		{
			"power" => "Power",
			"level" => "Level",
			"genes" => "Genes",
			"basestats" => "Base Stats",
			"rarity" => "Rarity",
			"fav" => "Favorites",
			"recent" => "Recent",
			"beastiary" => "Beastiary",
			"name" => string.IsNullOrEmpty(CurrentNameFilter) ? "Name" : CurrentNameFilter,
			_ => "Power"
		};
	}

	private string GetRarityClass(string rarity)
	{
		if (rarity == "all") return "";
		return rarity;
	}

	private string GetRarityLabel(string rarity)
	{
		if (rarity == "all") return "All Rarities";
		return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(rarity);
	}

	public override void Tick()
	{
		base.Tick();

		// Update search text from input
		if (searchInput != null && nameSearchOpen)
		{
			searchText = searchInput.Text ?? "";
		}
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(CurrentElement);
		hash.Add(CurrentSort);
		hash.Add(CurrentRarity);
		hash.Add(CurrentNameFilter);
		hash.Add(SortAscending);
		hash.Add(elementDropdownOpen);
		hash.Add(sortDropdownOpen);
		hash.Add(rarityDropdownOpen);
		hash.Add(nameSearchOpen);
		hash.Add(searchText);
		return hash.ToHashCode();
	}
}
