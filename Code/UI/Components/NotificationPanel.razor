@namespace Beastborne.UI.Components
@using System.Linq;
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Systems;
@inherits Panel

<div class="notification-panel @(isExpanded ? "expanded" : "")">
	<!-- Expanded History View â€” always rendered, animated via CSS -->
	<div class="notification-history @(isExpanded ? "open" : "")">
			<div class="bg-scroll"><img src="ui/bg-patterns/bg-notifications.svg" /></div>
			<!-- Header -->
			<div class="notif-header">
				<div class="notif-header-left">
					<img class="notif-icon" src="ui/icons/buttons/notification.svg" />
					<span class="notif-title">NOTIFICATIONS</span>
				</div>
				<div class="notif-header-right">
					@{
						var unread = GetUnreadCount();
					}
					@if (unread > 0)
					{
						<span class="notif-badge">@unread new</span>
					}
					<button class="close-btn" onclick=@ToggleExpanded><img class="close-icon" src="ui/icons/buttons/close.svg" /><img class="close-icon-anim" src="ui/icons/animated/close.webp" /></button>
				</div>
			</div>

			<!-- Filter Tabs -->
			<div class="notif-filter">
				<div class="nf-pill @(currentFilter == "all" ? "active" : "")" onclick=@(() => SetFilter("all"))><span>All</span></div>
				<div class="nf-pill @(currentFilter == "game" ? "active" : "")" onclick=@(() => SetFilter("game"))><span>Game</span></div>
				<div class="nf-pill @(currentFilter == "social" ? "active" : "")" onclick=@(() => SetFilter("social"))><span>Social</span></div>
				<div class="nf-pill @(currentFilter == "system" ? "active" : "")" onclick=@(() => SetFilter("system"))><span>System</span></div>
			</div>

			<!-- Notification List -->
			<div class="notif-list">
				@{
					var filtered = GetFilteredHistory();
				}
				@if (filtered.Count == 0)
				{
					<div class="no-notifications"><span>No notifications yet</span></div>
				}
				else
				{
					@foreach (var notification in filtered)
					{
						<div class="notif-msg @GetTypeClass(notification.Type)">
							<div class="ni @GetTypeClass(notification.Type)">
								@if (notification.HasImageIcon)
								{
									<img class="ni-img" src=@notification.IconPath />
								}
								else
								{
									<span>@notification.Icon</span>
								}
							</div>
							<div class="nc">
								<span class="nt @GetTypeClass(notification.Type)">@notification.Title</span>
								<span class="ns">@notification.Message</span>
							</div>
							<span class="ntime">@GetTimeAgo(notification.CreatedAt)</span>
						</div>
					}
				}
			</div>

			<!-- Clear All -->
			@if (GetHistory().Count > 0)
			{
				<div class="notif-clear">
					<div class="notif-clear-btn" onclick=@ClearHistory><span>Clear All Notifications</span></div>
				</div>
			}
		</div>

	<!-- Expand Button (always visible) -->
	<button class="notification-expand-btn @(GetUnreadCount() > 0 ? "has-unread" : "")" onclick=@ToggleExpanded>
		<img class="notification-btn-icon" src="ui/icons/buttons/notification.svg" />
		<img class="notification-btn-icon-anim" src="ui/icons/animated/notification.webp" />
		<span class="notification-btn-text">NOTIFICATIONS</span>
		@if (GetUnreadCount() > 0)
		{
			<span class="unread-badge">@GetUnreadCount()</span>
		}
	</button>

	@if (!isExpanded)
	{
		<!-- Toast Notifications (below button) -->
		@foreach (var notification in GetNotifications())
		{
			<div class="notification @GetTypeClass(notification.Type)" onclick=@(() => DismissNotification(notification.Id))>
				<div class="notification-icon">
					@if (notification.HasImageIcon)
					{
						<img class="notification-icon-img" src=@notification.IconPath />
					}
					else
					{
						<span>@notification.Icon</span>
					}
				</div>
				<div class="notification-content">
					<div class="notification-title">@notification.Title</div>
					<div class="notification-message">@notification.Message</div>
				</div>
				<div class="notification-close"><img class="close-icon" src="ui/icons/buttons/close.svg" /></div>
				<div class="notification-progress">
					<div class="notification-progress-bar" style="width: @(notification.Progress * 100)%"></div>
				</div>
			</div>
		}
	}
</div>

@code {
	private bool isExpanded = false;
	private string currentFilter = "all";

	// Static property so other components can check if notifications are open
	public static bool IsNotificationsExpanded { get; private set; } = false;

	private List<Notification> GetNotifications()
	{
		return NotificationManager.Instance?.ActiveNotifications?.ToList() ?? new();
	}

	private List<Notification> GetHistory()
	{
		return NotificationManager.Instance?.NotificationHistory?.ToList() ?? new();
	}

	private List<Notification> GetFilteredHistory()
	{
		var history = GetHistory();
		if (currentFilter == "all") return history;
		return history.Where(n => GetFilterCategory(n.Type) == currentFilter).ToList();
	}

	private string GetFilterCategory(NotificationType type)
	{
		return type switch
		{
			NotificationType.Evolution => "game",
			NotificationType.Catch => "game",
			NotificationType.ServerBoost => "game",
			NotificationType.ExpeditionUnlock => "game",
			NotificationType.RankedBattle => "social",
			_ => "system"
		};
	}

	private int GetUnreadCount()
	{
		return NotificationManager.Instance?.UnreadCount ?? 0;
	}

	private string GetTypeClass(NotificationType type)
	{
		return type switch
		{
			NotificationType.Info => "info",
			NotificationType.Success => "success",
			NotificationType.Warning => "warning",
			NotificationType.Evolution => "evolution",
			NotificationType.ServerBoost => "server-boost",
			NotificationType.RankedBattle => "ranked-battle",
			NotificationType.Catch => "catch",
			NotificationType.TamerLevelUp => "tamer-level-up",
			NotificationType.ExpeditionUnlock => "expedition-unlock",
			_ => "info"
		};
	}

	private string GetTimeAgo(DateTime time)
	{
		var diff = DateTime.UtcNow - time;
		if (diff.TotalSeconds < 60) return "Just now";
		if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m";
		if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h";
		return $"{(int)diff.TotalDays}d";
	}

	private void SetFilter(string filter)
	{
		currentFilter = filter;
		SoundManager.PlayClick();
	}

	private void DismissNotification(Guid id)
	{
		NotificationManager.Instance?.RemoveNotification(id);
		SoundManager.PlayClick();
	}

	private void ToggleExpanded()
	{
		isExpanded = !isExpanded;
		IsNotificationsExpanded = isExpanded;
		if (isExpanded)
		{
			NotificationManager.Instance?.MarkAllRead();
			SoundManager.PlayPopup();
		}
		else
		{
			SoundManager.PlayPopdown();
		}
	}

	private void ClearHistory()
	{
		NotificationManager.Instance?.ClearHistory();
		SoundManager.PlayClick();
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(isExpanded);
		hash.Add(currentFilter);
		hash.Add(GetNotifications().Count);
		hash.Add(GetHistory().Count);
		hash.Add(GetUnreadCount());
		foreach (var n in GetNotifications())
		{
			hash.Add(n.Id);
			hash.Add((int)(n.Progress * 100));
		}
		return hash.ToHashCode();
	}
}
