@namespace Beastborne.UI.Components
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Systems;
@inherits Panel

<div class="radio-widget @(HasStations() ? "" : "hidden")">
	<div class="radio-panel @GetAccentClass() @(IsExpanded && HasStations() ? "open" : "")">
		<div class="bg-scroll"><img src="ui/bg-patterns/bg-radio.svg" /></div>

		<!-- Header -->
		<div class="rp-hdr">
			<img class="rp-hdr-icon" src="ui/icons/buttons/music.svg" />
			<span class="rp-hdr-title">Radio</span>
			<button class="close-btn" onclick=@OnCloseClick>
				<img class="close-icon" src="ui/icons/buttons/close.svg" />
				<img class="close-icon-anim" src="ui/icons/animated/close.webp" />
			</button>
		</div>

		<!-- Now Playing -->
		<div class="rp-np">
			<div class="rp-np-cover">
				<span class="rp-np-emoji">@GetStationIcon()</span>
			</div>
			<div class="rp-np-info">
				<div class="rp-np-station">
					<span class="rp-np-dot"></span>
					<span>@GetStationName()</span>
				</div>
				<span class="rp-np-title">@GetTrackName()</span>
				<span class="rp-np-sub">Track @GetTrackNumber() of @GetTrackCount()</span>
			</div>
		</div>

		<!-- Progress -->
		<div class="rp-progress">
			<div class="rp-prog-bar">
				<div class="rp-prog-fill" style="width: @GetProgressPercent()%"></div>
			</div>
			<div class="rp-prog-times">
				<span>@FormatTime(RadioManager.TrackPosition)</span>
				<span>@FormatTime(RadioManager.TrackDuration)</span>
			</div>
		</div>

		<!-- Controls -->
		<div class="rp-controls">
			<button class="rp-ctrl rp-ctrl-sm @(RadioManager.IsShuffle ? "on" : "")" onclick=@OnShuffleClick>
				<img class="rp-ctrl-icon" src="ui/icons/buttons/shuffle.svg" />
				<img class="rp-ctrl-icon-anim" src="ui/icons/animated/shuffle.webp" />
			</button>
			<button class="rp-ctrl" onclick=@OnPrevClick>
				<img class="rp-ctrl-icon" src="ui/icons/buttons/skip-back.svg" />
			</button>
			<button class="rp-ctrl rp-ctrl-play" onclick=@OnPlayClick>
				@if (IsPlaying())
				{
					<img class="rp-ctrl-icon" src="ui/icons/buttons/pause.svg" />
				}
				else
				{
					<img class="rp-ctrl-icon" src="ui/icons/buttons/play.svg" />
				}
			</button>
			<button class="rp-ctrl" onclick=@OnNextClick>
				<img class="rp-ctrl-icon" src="ui/icons/buttons/skip-forward.svg" />
			</button>
			<button class="rp-ctrl rp-ctrl-sm @(RadioManager.IsRepeat ? "on" : "")" onclick=@OnRepeatClick>
				<img class="rp-ctrl-icon" src="ui/icons/buttons/repeat.svg" />
				<img class="rp-ctrl-icon-anim" src="ui/icons/animated/repeat.webp" />
			</button>
		</div>

		<div class="rp-sep"></div>

		<!-- Station Pills -->
		<div class="rp-stations">
			@foreach (var station in RadioManager.Stations)
			{
				<button class="rp-st @(IsCurrentStation(station) ? "active" : "") @GetStationAccentClass(station)"
						onclick=@(() => OnStationSelect(station))>
					<span>@station.Icon</span>
					<span>@station.Name</span>
				</button>
			}
		</div>

		<div class="rp-sep"></div>

		<!-- Track List -->
		<div class="rp-tracklist-wrap">
			<div class="rp-tracklist">
				<span class="rp-tl-label">TRACKS</span>
				@if (RadioManager.CurrentStation != null)
				{
					@foreach (var track in RadioManager.CurrentStation.Tracks)
					{
						<button class="rp-trk @(IsCurrentTrack(track) && IsPlaying() ? "playing" : "") @(IsCurrentTrack(track) ? "selected" : "")"
								onclick=@(() => OnTrackSelect(track))>
							<div class="rp-trk-cover">
								<span>@GetStationIcon()</span>
							</div>
							<div class="rp-trk-info">
								<span class="rp-trk-name">@track.Name</span>
							</div>
						</button>
					}
				}
			</div>
		</div>

		<!-- Bottom: Volume -->
		<div class="rp-bottom">
			<img class="rp-vol-icon" src="@GetVolumeIcon()" />
			<div class="rp-vol-track" @ref="VolumeTrack" onmousedown=@OnVolumeDown onmousemove=@OnVolumeMove onmouseup=@OnVolumeUp>
				<div class="rp-vol-fill" style="width: @GetVolumePercent()%"></div>
				<div class="rp-vol-thumb" style="left: @GetVolumePercent()%"></div>
			</div>
			<span class="rp-vol-pct">@GetVolumePercent()%</span>
			<span class="rp-hint-key">[ ]</span>
		</div>
	</div>

	<button class="radio-button" onclick=@OnWidgetClick>
		<img class="radio-icon" src="ui/icons/buttons/music.svg" />
		<img class="radio-icon-anim" src="ui/icons/animated/music.webp" />
		<span class="now-playing">@GetTrackName()</span>
	</button>
</div>

@code {
	private bool IsExpanded = false;
	private Panel VolumeTrack;
	private bool _isDraggingVolume = false;

	private void OnWidgetClick()
	{
		IsExpanded = true;
		SoundManager.PlayPopup();
	}

	private void OnCloseClick()
	{
		IsExpanded = false;
		SoundManager.PlayPopdown();
	}

	private void OnPrevClick()
	{
		RadioManager.PreviousTrack();
	}

	private void OnPlayClick()
	{
		RadioManager.TogglePlay();
		SoundManager.PlayClick();
	}

	private void OnNextClick()
	{
		RadioManager.NextTrack();
	}

	private void OnShuffleClick()
	{
		RadioManager.ToggleShuffle();
		SoundManager.PlayClick();
	}

	private void OnRepeatClick()
	{
		RadioManager.ToggleRepeat();
		SoundManager.PlayClick();
	}

	private void OnStationSelect(RadioManager.Station station)
	{
		int index = RadioManager.Stations.IndexOf(station);
		if (index >= 0)
		{
			RadioManager.SetStation(index);
		}
		SoundManager.PlayClick();
	}

	private void OnTrackSelect(RadioManager.Track track)
	{
		if (RadioManager.CurrentStation == null) return;

		int index = RadioManager.CurrentStation.Tracks.IndexOf(track);
		if (index >= 0)
		{
			RadioManager.SetTrack(index);
		}
		SoundManager.PlayClick();
	}

	private void OnVolumeDown(PanelEvent e)
	{
		_isDraggingVolume = true;
		UpdateVolumeFromMouse();
	}

	private void OnVolumeMove(PanelEvent e)
	{
		if (!_isDraggingVolume) return;
		UpdateVolumeFromMouse();
	}

	private void OnVolumeUp(PanelEvent e)
	{
		_isDraggingVolume = false;
	}

	private void UpdateVolumeFromMouse()
	{
		if (VolumeTrack == null) return;

		var mouseX = MousePosition.x - VolumeTrack.Box.Left;
		var trackWidth = VolumeTrack.Box.Rect.Width;
		if (trackWidth <= 0) return;

		float pct = (mouseX / trackWidth).Clamp(0f, 1f);
		RadioManager.SetVolume(pct);
	}

	private bool IsCurrentStation(RadioManager.Station station)
	{
		return RadioManager.CurrentStation == station;
	}

	private bool IsCurrentTrack(RadioManager.Track track)
	{
		return RadioManager.CurrentTrack == track;
	}

	private string GetStationIcon()
	{
		return RadioManager.CurrentStation?.Icon ?? "ðŸ“»";
	}

	private string GetStationName()
	{
		return RadioManager.CurrentStation?.Name ?? "No Station";
	}

	private string GetTrackName()
	{
		var track = RadioManager.CurrentTrack;
		if (track == null)
			return "No Track";
		return track.Name;
	}

	private int GetTrackNumber()
	{
		return RadioManager.CurrentTrackIndex + 1;
	}

	private int GetTrackCount()
	{
		return RadioManager.CurrentStation?.Tracks.Count ?? 0;
	}

	private int GetVolumePercent()
	{
		return (int)(RadioManager.Volume * 100);
	}

	private string GetVolumeIcon()
	{
		float vol = RadioManager.Volume;
		if (vol <= 0.01f) return "ui/icons/buttons/volume-mute.svg";
		if (vol <= 0.4f) return "ui/icons/buttons/volume-low.svg";
		return "ui/icons/buttons/volume.svg";
	}

	private int GetProgressPercent()
	{
		float duration = RadioManager.TrackDuration;
		if (duration <= 0) return 0;
		float position = RadioManager.TrackPosition;
		return (int)((position / duration * 100f).Clamp(0f, 100f));
	}

	private string FormatTime(float seconds)
	{
		if (seconds <= 0) return "0:00";
		int mins = (int)(seconds / 60f);
		int secs = (int)(seconds % 60f);
		return $"{mins}:{secs:D2}";
	}

	private string GetAccentClass()
	{
		var station = RadioManager.CurrentStation;
		if (station == null) return "chill";
		return station.Context == RadioContext.Battle ? "battle" : "chill";
	}

	private string GetStationAccentClass(RadioManager.Station station)
	{
		return station.Context == RadioContext.Battle ? "battle" : "chill";
	}

	private bool IsPlaying()
	{
		return RadioManager.IsPlaying;
	}

	private bool HasStations()
	{
		return RadioManager.Stations.Count > 0;
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(IsExpanded);
		hash.Add(GetStationName());
		hash.Add(GetTrackName());
		hash.Add(IsPlaying());
		hash.Add(RadioManager.CurrentStationIndex);
		hash.Add(RadioManager.CurrentTrackIndex);
		hash.Add(RadioManager.Volume);
		hash.Add(RadioManager.IsShuffle);
		hash.Add(RadioManager.IsRepeat);
		hash.Add((int)RadioManager.TrackPosition);
		return hash.ToHashCode();
	}
}
