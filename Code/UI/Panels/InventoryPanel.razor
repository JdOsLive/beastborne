@namespace Beastborne.UI.Panels
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@inherits Panel

<root class="inventory-panel @(IsVisible ? "visible" : "")">
	<div class="inventory-overlay" onclick=@Close></div>

	<div class="inventory-modal">
		<div class="inventory-layout">

			<!-- ====== LEFT SIDEBAR ====== -->
			<div class="inventory-sidebar">

				<!-- Sidebar Header -->
				<div class="sidebar-header">
					<img class="sidebar-icon" src="ui/icons/buttons/inventory.svg" />
					<span class="sidebar-title">Inventory</span>
					<div class="sidebar-count-badge"><span>@GetTotalItemCount()</span></div>
				</div>

				<!-- Search (visual placeholder) -->
				<div class="sidebar-search">
					<span class="search-placeholder">Search items...</span>
				</div>

				<!-- Category List -->
				<div class="category-list">
					<div class="category-item @(currentCategory == "all" ? "active" : "")" onclick=@(() => SetCategory("all"))>
						@if (currentCategory == "all") { <div class="category-indicator"></div> }
						<div class="category-dot dot-white"></div>
						<span class="category-label">All Items</span>
						<span class="category-count">@GetTotalItemCount()</span>
					</div>
					<div class="category-item @(currentCategory == "consumable" ? "active" : "")" onclick=@(() => SetCategory("consumable"))>
						@if (currentCategory == "consumable") { <div class="category-indicator"></div> }
						<div class="category-dot dot-blue"></div>
						<span class="category-label">Consumables</span>
						<span class="category-count">@GetCategoryItemCount("consumable")</span>
					</div>
					<div class="category-item @(currentCategory == "relic" ? "active" : "")" onclick=@(() => SetCategory("relic"))>
						@if (currentCategory == "relic") { <div class="category-indicator"></div> }
						<div class="category-dot dot-purple"></div>
						<span class="category-label">Relics</span>
						<span class="category-count">@GetCategoryItemCount("relic")</span>
					</div>
					<div class="category-item @(currentCategory == "held" ? "active" : "")" onclick=@(() => SetCategory("held"))>
						@if (currentCategory == "held") { <div class="category-indicator"></div> }
						<div class="category-dot dot-green"></div>
						<span class="category-label">Held Items</span>
						<span class="category-count">@GetCategoryItemCount("held")</span>
					</div>
					<div class="category-item @(currentCategory == "boost" ? "active" : "")" onclick=@(() => SetCategory("boost"))>
						@if (currentCategory == "boost") { <div class="category-indicator"></div> }
						<div class="category-dot dot-amber"></div>
						<span class="category-label">Boosts</span>
						<span class="category-count">@GetCategoryItemCount("boost")</span>
					</div>
					<div class="category-item @(currentCategory == "quest" ? "active" : "")" onclick=@(() => SetCategory("quest"))>
						@if (currentCategory == "quest") { <div class="category-indicator"></div> }
						<div class="category-dot dot-red"></div>
						<span class="category-label">Quest</span>
						<span class="category-count">@GetCategoryItemCount("quest")</span>
					</div>
				</div>

				<!-- Sort Bar -->
				<div class="sort-bar">
					<span class="sort-label">Sort</span>
					<button class="sort-btn @(currentSort == "name" ? "active" : "")" onclick=@(() => SetSort("name"))><span>Name</span></button>
					<button class="sort-btn @(currentSort == "qty" ? "active" : "")" onclick=@(() => SetSort("qty"))><span>Qty</span></button>
					<button class="sort-btn @(currentSort == "rarity" ? "active" : "")" onclick=@(() => SetSort("rarity"))><span>Rarity</span></button>
				</div>

				<!-- Equipped Relics -->
				<div class="sidebar-relics">
					<span class="relics-title">Equipped Relics</span>
					<div class="relics-slots-row">
						@for (int i = 0; i < 3; i++)
						{
							var relicId = GetEquippedRelic(i);
							var relic = relicId != null ? ItemManager.Instance?.GetItem(relicId) : null;
							<div class="sidebar-relic-slot @(relic != null ? "filled" : "empty") @(selectedItem?.Id == relicId ? "selected" : "")"
								 onclick=@(() => OnRelicSlotClick(relicId))>
								@if (relic != null)
								{
									<div class="relic-icon-bg @GetRarityClass(relic.Rarity)">
										<img src="@relic.IconPath" onerror="this.style.display='none'" />
									</div>
									<span class="relic-slot-name">@relic.Name</span>
								}
								else
								{
									<span class="relic-slot-plus">+</span>
									<span class="relic-slot-empty">Empty</span>
								}
							</div>
						}
					</div>
				</div>
			</div>

			<!-- ====== MAIN CONTENT ====== -->
			<div class="inventory-main">

				<!-- Top Bar -->
				<div class="main-topbar">
					<div class="rarity-filters">
						<button class="rarity-pill @(currentRarityFilter == "all" ? "active" : "")" onclick=@(() => SetRarityFilter("all"))>
							<div class="rarity-pip pip-white"></div>
							<span>All</span>
						</button>
						<button class="rarity-pill @(currentRarityFilter == "common" ? "active" : "")" onclick=@(() => SetRarityFilter("common"))>
							<div class="rarity-pip pip-common"></div>
							<span>Common</span>
						</button>
						<button class="rarity-pill @(currentRarityFilter == "uncommon" ? "active" : "")" onclick=@(() => SetRarityFilter("uncommon"))>
							<div class="rarity-pip pip-uncommon"></div>
							<span>Uncommon</span>
						</button>
						<button class="rarity-pill @(currentRarityFilter == "rare" ? "active" : "")" onclick=@(() => SetRarityFilter("rare"))>
							<div class="rarity-pip pip-rare"></div>
							<span>Rare</span>
						</button>
						<button class="rarity-pill @(currentRarityFilter == "epic" ? "active" : "")" onclick=@(() => SetRarityFilter("epic"))>
							<div class="rarity-pip pip-epic"></div>
							<span>Epic</span>
						</button>
						<button class="rarity-pill @(currentRarityFilter == "legendary" ? "active" : "")" onclick=@(() => SetRarityFilter("legendary"))>
							<div class="rarity-pip pip-legendary"></div>
							<span>Legend</span>
						</button>
					</div>

					<div class="topbar-spacer"></div>

					<button class="close-btn" onclick=@Close>
						<img class="close-icon" src="ui/icons/buttons/close.svg" />
						<img class="close-icon-anim" src="ui/icons/animated/close.webp" />
					</button>
				</div>

				<!-- Items Scroll Area -->
				<div class="items-scroll-area">
					@if (currentCategory == "all")
					{
						@foreach (var group in GetGroupedItems())
						{
							<span class="section-label">@GetCategorySectionLabel(group.Key)</span>
							@foreach (var (itemId, quantity) in group.Value)
							{
								var item = ItemManager.Instance?.GetItem(itemId);
								if (item == null) continue;
								<div class="item-card @GetRarityClass(item.Rarity) @(selectedItem?.Id == itemId ? "selected" : "") @(IsEquipped(itemId) ? "equipped" : "")"
									 onclick=@(() => SelectItem(item))>
									<div class="item-rarity-bar @GetRarityClass(item.Rarity)"></div>
									<div class="item-icon-wrap">
										<img class="item-icon" src="@item.IconPath" onerror="this.style.display='none'" />
										@if (quantity > 1)
										{
											<div class="item-qty-badge"><span>x@(quantity)</span></div>
										}
									</div>
									<span class="item-card-name">@item.Name</span>
									<span class="item-card-type">@GetCategoryLabel(item.Category)</span>
									@if (IsEquipped(itemId))
									{
										<div class="equipped-badge"><span>EQUIPPED</span></div>
									}
								</div>
							}
						}
					}
					else
					{
						@foreach (var (itemId, quantity) in GetFilteredItems())
						{
							var item = ItemManager.Instance?.GetItem(itemId);
							if (item == null) continue;
							<div class="item-card @GetRarityClass(item.Rarity) @(selectedItem?.Id == itemId ? "selected" : "") @(IsEquipped(itemId) ? "equipped" : "")"
								 onclick=@(() => SelectItem(item))>
								<div class="item-rarity-bar @GetRarityClass(item.Rarity)"></div>
								<div class="item-icon-wrap">
									<img class="item-icon" src="@item.IconPath" onerror="this.style.display='none'" />
									@if (quantity > 1)
									{
										<div class="item-qty-badge"><span>x@(quantity)</span></div>
									}
								</div>
								<span class="item-card-name">@item.Name</span>
								<span class="item-card-type">@GetCategoryLabel(item.Category)</span>
								@if (IsEquipped(itemId))
								{
									<div class="equipped-badge"><span>EQUIPPED</span></div>
								}
							</div>
						}
					}

					@if (GetFilteredItems().Count == 0)
					{
						<div class="empty-inventory">
							<span class="empty-text">No items in this category</span>
							<span class="empty-hint">Complete expeditions to find items!</span>
						</div>
					}
				</div>

				<!-- Item Detail Bar (compact horizontal) -->
				@if (selectedItem != null)
				{
					<div class="item-detail @GetRarityClass(selectedItem.Rarity)">
						<div class="detail-main">
							<div class="detail-icon-container @GetRarityClass(selectedItem.Rarity)">
								<img class="detail-icon" src="@selectedItem.IconPath" onerror="this.style.display='none'" />
							</div>
							<div class="detail-body">
								<div class="detail-title-row">
									<span class="detail-name">@selectedItem.Name</span>
									<div class="detail-rarity @GetRarityClass(selectedItem.Rarity)"><span>@selectedItem.Rarity</span></div>
									@if (selectedItem.EffectDuration > 0)
									{
										<span class="detail-duration">@selectedItem.EffectDuration waves</span>
									}
									@if (GetItemQuantity(selectedItem.Id) > 0)
									{
										<span class="detail-owned">x@(GetItemQuantity(selectedItem.Id))</span>
									}
								</div>
								<div class="detail-effect">
									<span class="effect-label">Effect:</span>
									<span class="effect-value">@GetEffectDescription(selectedItem)</span>
								</div>
							</div>
						</div>
						<div class="detail-actions">
							@if (selectedItem.SellPrice > 0 && CanSellItem(selectedItem))
							{
								<button class="action-btn sell @(isHoldingSell ? "holding" : "")"
										onmousedown=@StartHoldSell
										onmouseup=@StopHold
										onmouseleave=@StopHold>
									<div class="btn-fill" style="width: @(isHoldingSell ? holdProgress * 100 : 0)%;"></div>
									<span>@(isHoldingSell ? "..." : $"{selectedItem.SellPrice}g")</span>
								</button>
							}
							@if (selectedItem.Category == ItemCategory.Consumable)
							{
								<button class="action-btn use @(CanUseConsumable(selectedItem) ? "" : "disabled")"
										onclick=@(() => UseConsumable(selectedItem))>
									<span>Use</span>
								</button>
							}
							else if (selectedItem.Category == ItemCategory.Relic)
							{
								@if (IsRelicEquipped(selectedItem.Id))
								{
									<button class="action-btn unequip" onclick=@(() => UnequipRelic(selectedItem))>
										<span>Unequip</span>
									</button>
								}
								else
								{
									<button class="action-btn equip @(CanEquipRelic() ? "" : "disabled")"
											onclick=@(() => EquipRelic(selectedItem))>
										<span>@(CanEquipRelic() ? "Equip" : "Full")</span>
									</button>
								}
							}
							else if (selectedItem.Category == ItemCategory.HeldItem)
							{
								<span class="held-item-hint">Monster Details</span>
							}
							else if (selectedItem.Category == ItemCategory.Boost)
							{
								<button class="action-btn use @(CanUseBoost(selectedItem) ? "" : "disabled")"
										onclick=@(() => UseBoost(selectedItem))>
									<span>Use</span>
								</button>
							}
							@if (!string.IsNullOrEmpty(boostMessage))
							{
								<div class="boost-message @(boostMessageSuccess ? "success" : "error")"><span>@boostMessage</span></div>
							}
						</div>
					</div>
				}
				else
				{
					<div class="detail-hint">
						<span class="hint-text">Click an item for details</span>
						<span class="hint-esc">Q to close</span>
					</div>
				}
			</div>

		</div>
	</div>

	<!-- Monster Picker for Consumables that need a target -->
	@if (showMonsterPicker && pendingConsumable != null)
	{
		<div class="monster-picker-overlay" onclick=@CloseMonsterPicker>
			<div class="monster-picker-panel" onclick:stopPropagation>
				<div class="picker-header">
					<span class="picker-title">Choose a Beast</span>
					<span class="picker-subtitle">Select which beast to use @pendingConsumable.Name on</span>
					<button class="close-btn" onclick=@CloseMonsterPicker><img class="close-icon" src="ui/icons/buttons/close.svg" /><img class="close-icon-anim" src="ui/icons/animated/close.webp" /></button>
				</div>
				<div class="picker-grid">
					@foreach (var monster in GetOwnedMonsters())
					{
						var species = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
						<div class="picker-monster" onclick=@(() => UseConsumableOnMonster(monster))>
							<div class="picker-monster-sprite">
								@if (species != null && !string.IsNullOrEmpty(species.IconPath))
								{
									<img src="@GetMonsterSprite(monster)" onerror="this.style.display='none'" />
								}
								else
								{
									<span class="sprite-placeholder">?</span>
								}
							</div>
							<div class="picker-monster-info">
								<span class="picker-monster-name">@monster.Nickname</span>
								<span class="picker-monster-level">Lv. @monster.Level</span>
							</div>
							<div class="picker-monster-xp">
								<div class="xp-bar-bg">
									<div class="xp-bar-fill" style="width: @((int)(monster.XPProgress * 100))%"></div>
								</div>
								<span class="xp-text">@monster.CurrentXP / @monster.XPForNextLevel XP</span>
							</div>
						</div>
					}
				</div>
			</div>
		</div>
	}

	<!-- Consumable Use Feedback -->
	@if (!string.IsNullOrEmpty(consumableMessage))
	{
		<div class="consumable-feedback @(consumableMessageSuccess ? "success" : "error")">
			<span>@consumableMessage</span>
		</div>
	}
</root>

@code {
	public static bool IsVisible { get; set; } = false;
	private string currentCategory = "all";
	private ItemDefinition selectedItem;
	private string currentRarityFilter = "all";
	private string currentSort = "default";

	// Hold-to-sell state
	private bool isHoldingSell = false;
	private float holdProgress = 0f;
	private const float HoldDuration = 0.5f;

	// Boost feedback message
	private string boostMessage = "";
	private bool boostMessageSuccess = false;
	private float boostMessageTimer = 0f;
	private const float BoostMessageDuration = 3f;

	// Monster picker for consumables
	private bool showMonsterPicker = false;
	private ItemDefinition pendingConsumable = null;

	// Consumable use feedback
	private string consumableMessage = "";
	private bool consumableMessageSuccess = false;
	private float consumableMessageTimer = 0f;

	public static void Show() { IsVisible = true; SoundManager.PlayPopup(); }
	public static void Close() { IsVisible = false; SoundManager.PlayPopdown(); }
	public static void Toggle() { IsVisible = !IsVisible; if (IsVisible) SoundManager.PlayPopup(); else SoundManager.PlayPopdown(); }

	private void SetCategory(string category)
	{
		currentCategory = category;
		selectedItem = null;
		SoundManager.PlayClick();
	}

	private void SetRarityFilter(string rarity)
	{
		currentRarityFilter = rarity;
		selectedItem = null;
		SoundManager.PlayClick();
	}

	private void SetSort(string sort)
	{
		currentSort = currentSort == sort ? "default" : sort;
		SoundManager.PlayClick();
	}

	private int GetTotalItemCount()
	{
		var inventory = TamerManager.Instance?.CurrentTamer?.Inventory;
		if (inventory == null) return 0;
		return inventory.Values.Sum();
	}

	private int GetCategoryItemCount(string category)
	{
		var inventory = TamerManager.Instance?.CurrentTamer?.Inventory;
		if (inventory == null) return 0;

		return inventory.Where(kvp => kvp.Value > 0)
			.Sum(kvp =>
			{
				var item = ItemManager.Instance?.GetItem(kvp.Key);
				if (item == null) return 0;
				bool matches = category switch
				{
					"consumable" => item.Category == ItemCategory.Consumable,
					"relic" => item.Category == ItemCategory.Relic,
					"held" => item.Category == ItemCategory.HeldItem,
					"boost" => item.Category == ItemCategory.Boost,
					"quest" => item.Category == ItemCategory.QuestItem,
					_ => false
				};
				return matches ? kvp.Value : 0;
			});
	}

	private List<(string ItemId, int Quantity)> GetFilteredItems()
	{
		var inventory = TamerManager.Instance?.CurrentTamer?.Inventory;
		if (inventory == null) return new();

		var items = inventory.Where(kvp => kvp.Value > 0).ToList();

		// Category filter
		if (currentCategory != "all")
		{
			items = items.Where(kvp =>
			{
				var item = ItemManager.Instance?.GetItem(kvp.Key);
				if (item == null) return false;
				return currentCategory switch
				{
					"consumable" => item.Category == ItemCategory.Consumable,
					"relic" => item.Category == ItemCategory.Relic,
					"held" => item.Category == ItemCategory.HeldItem,
					"boost" => item.Category == ItemCategory.Boost,
					"quest" => item.Category == ItemCategory.QuestItem,
					_ => true
				};
			}).ToList();
		}

		// Rarity filter
		if (currentRarityFilter != "all")
		{
			items = items.Where(kvp =>
			{
				var item = ItemManager.Instance?.GetItem(kvp.Key);
				if (item == null) return false;
				return item.Rarity.ToString().ToLower() == currentRarityFilter;
			}).ToList();
		}

		// Sorting
		var result = currentSort switch
		{
			"name" => items.OrderBy(x => ItemManager.Instance?.GetItem(x.Key)?.Name ?? "").ToList(),
			"qty" => items.OrderByDescending(x => x.Value).ToList(),
			"rarity" => items.OrderByDescending(x => (int)(ItemManager.Instance?.GetItem(x.Key)?.Rarity ?? 0)).ToList(),
			_ => items
		};

		return result.Select(kvp => (kvp.Key, kvp.Value)).ToList();
	}

	private List<KeyValuePair<ItemCategory, List<(string ItemId, int Quantity)>>> GetGroupedItems()
	{
		var filtered = GetFilteredItems();
		var grouped = new Dictionary<ItemCategory, List<(string, int)>>();

		// Define display order
		var categoryOrder = new[] { ItemCategory.Consumable, ItemCategory.Relic, ItemCategory.HeldItem, ItemCategory.Boost, ItemCategory.QuestItem };

		foreach (var (itemId, qty) in filtered)
		{
			var item = ItemManager.Instance?.GetItem(itemId);
			if (item == null) continue;
			if (!grouped.ContainsKey(item.Category))
				grouped[item.Category] = new();
			grouped[item.Category].Add((itemId, qty));
		}

		// Return in display order
		return categoryOrder
			.Where(c => grouped.ContainsKey(c))
			.Select(c => new KeyValuePair<ItemCategory, List<(string, int)>>(c, grouped[c]))
			.ToList();
	}

	private string GetEquippedRelic(int slot)
	{
		var relics = TamerManager.Instance?.CurrentTamer?.EquippedRelics;
		if (relics == null || slot >= relics.Count) return null;
		return relics[slot];
	}

	private bool IsEquipped(string itemId)
	{
		var item = ItemManager.Instance?.GetItem(itemId);
		if (item == null) return false;

		if (item.Category == ItemCategory.Relic)
		{
			return TamerManager.Instance?.CurrentTamer?.EquippedRelics?.Contains(itemId) ?? false;
		}

		return false;
	}

	private bool IsRelicEquipped(string itemId)
	{
		return TamerManager.Instance?.CurrentTamer?.EquippedRelics?.Contains(itemId) ?? false;
	}

	private void SelectItem(ItemDefinition item)
	{
		selectedItem = item;
		SoundManager.PlayClick();
	}

	private void OnRelicSlotClick(string relicId)
	{
		if (string.IsNullOrEmpty(relicId)) return;
		var item = ItemManager.Instance?.GetItem(relicId);
		if (item != null)
		{
			selectedItem = item;
			SoundManager.PlayClick();
		}
	}

	private int GetItemQuantity(string itemId)
	{
		return TamerManager.Instance?.CurrentTamer?.Inventory?.GetValueOrDefault(itemId, 0) ?? 0;
	}

	private string GetRarityClass(ItemRarity rarity)
	{
		return rarity.ToString().ToLower();
	}

	private string GetCategoryLabel(ItemCategory category)
	{
		return category switch
		{
			ItemCategory.Consumable => "Consumable",
			ItemCategory.Relic => "Relic",
			ItemCategory.HeldItem => "Held Item",
			ItemCategory.Boost => "Server Boost",
			ItemCategory.QuestItem => "Quest",
			_ => category.ToString()
		};
	}

	private string GetCategorySectionLabel(ItemCategory category)
	{
		return category switch
		{
			ItemCategory.Consumable => "Consumables",
			ItemCategory.Relic => "Relics",
			ItemCategory.HeldItem => "Held Items",
			ItemCategory.Boost => "Boosts",
			ItemCategory.QuestItem => "Quest Items",
			_ => category.ToString()
		};
	}

	private string GetEffectDescription(ItemDefinition item)
	{
		if (item == null) return "";
		return item.GetEffectDescription();
	}

	private bool CanUseConsumable(ItemDefinition item)
	{
		if (item.Category != ItemCategory.Consumable) return false;
		if (item.EffectType == ItemEffectType.MasterInk) return false;
		return GetItemQuantity(item.Id) > 0;
	}

	private bool NeedsTarget(ItemDefinition item)
	{
		return item.EffectType == ItemEffectType.XPGrant
			|| item.EffectType == ItemEffectType.NatureChange
			|| item.EffectType == ItemEffectType.TraitReroll
			|| item.EffectType == ItemEffectType.GeneBoost;
	}

	private void UseConsumable(ItemDefinition item)
	{
		if (!CanUseConsumable(item)) return;

		if (NeedsTarget(item))
		{
			pendingConsumable = item;
			showMonsterPicker = true;
			SoundManager.PlayClick();
			return;
		}

		if (ItemManager.Instance?.UseItem(item.Id, null) == true)
		{
			SoundManager.PlayForward();
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	private void CloseMonsterPicker()
	{
		showMonsterPicker = false;
		pendingConsumable = null;
		SoundManager.PlayBack();
	}

	private List<Monster> GetOwnedMonsters()
	{
		var monsters = MonsterManager.Instance?.OwnedMonsters;
		if (monsters == null) return new();
		return monsters.OrderByDescending(m => m.Level).ToList();
	}

	private string GetMonsterSprite(Monster monster)
	{
		var species = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
		if (species == null) return "";
		if (species.AnimationFrames != null && species.AnimationFrames.Count > 0)
			return species.AnimationFrames[0];
		return species.IconPath ?? "";
	}

	private void UseConsumableOnMonster(Monster monster)
	{
		if (pendingConsumable == null || monster == null) return;

		if (ItemManager.Instance?.UseItem(pendingConsumable.Id, monster) == true)
		{
			consumableMessage = $"Used {pendingConsumable.Name} on {monster.Nickname}!";
			consumableMessageSuccess = true;
			consumableMessageTimer = 3f;
			SoundManager.PlayForward();

			if (GetItemQuantity(pendingConsumable.Id) <= 0)
			{
				selectedItem = null;
			}
		}
		else
		{
			consumableMessage = "Failed to use item.";
			consumableMessageSuccess = false;
			consumableMessageTimer = 3f;
			SoundManager.PlayBack();
		}

		showMonsterPicker = false;
		pendingConsumable = null;
	}

	private bool CanUseBoost(ItemDefinition item)
	{
		if (item == null || item.Category != ItemCategory.Boost) return false;
		return GetItemQuantity(item.Id) > 0;
	}

	private void UseBoost(ItemDefinition item)
	{
		if (!CanUseBoost(item)) return;
		if (ItemManager.Instance == null) return;

		var result = ItemManager.Instance.UseBoost(item.Id);
		boostMessage = result.Message;
		boostMessageSuccess = result.Success;
		boostMessageTimer = BoostMessageDuration;

		if (result.Success)
		{
			SoundManager.PlayForward();
			if (GetItemQuantity(item.Id) <= 0)
			{
				selectedItem = null;
			}
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	private bool CanEquipRelic()
	{
		var relics = TamerManager.Instance?.CurrentTamer?.EquippedRelics;
		return relics == null || relics.Count < 3;
	}

	private void EquipRelic(ItemDefinition item)
	{
		if (item.Category != ItemCategory.Relic) return;
		if (!CanEquipRelic()) return;

		if (ItemManager.Instance?.EquipRelic(item.Id) == true)
		{
			SoundManager.PlayForward();
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	private void UnequipRelic(ItemDefinition item)
	{
		if (item.Category != ItemCategory.Relic) return;

		if (ItemManager.Instance?.UnequipRelic(item.Id) == true)
		{
			SoundManager.PlayForward();
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	private bool CanSellItem(ItemDefinition item)
	{
		if (item == null || item.SellPrice <= 0) return false;
		if (item.Category == ItemCategory.Relic && IsRelicEquipped(item.Id)) return false;
		return GetItemQuantity(item.Id) > 0;
	}

	private void StartHoldSell()
	{
		if (selectedItem == null || !CanSellItem(selectedItem)) return;
		isHoldingSell = true;
		holdProgress = 0f;
		SoundManager.PlayHover();
	}

	private void StopHold()
	{
		isHoldingSell = false;
		holdProgress = 0f;
	}

	private void SellSelectedItem()
	{
		if (selectedItem == null) return;

		if (ItemManager.Instance?.SellItem(selectedItem.Id, 1) == true)
		{
			SoundManager.PlayForward();
			if (GetItemQuantity(selectedItem.Id) <= 0)
			{
				selectedItem = null;
			}
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	public override void Tick()
	{
		base.Tick();

		if (IsVisible && Input.Pressed("Escape"))
		{
			Close();
		}

		if (isHoldingSell && selectedItem != null)
		{
			holdProgress += Time.Delta / HoldDuration;

			if (holdProgress >= 1f)
			{
				SellSelectedItem();
				StopHold();
			}
		}

		if (boostMessageTimer > 0)
		{
			boostMessageTimer -= Time.Delta;
			if (boostMessageTimer <= 0)
			{
				boostMessage = "";
			}
		}

		if (consumableMessageTimer > 0)
		{
			consumableMessageTimer -= Time.Delta;
			if (consumableMessageTimer <= 0)
			{
				consumableMessage = "";
			}
		}
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(IsVisible);
		hash.Add(currentCategory);
		hash.Add(currentRarityFilter);
		hash.Add(currentSort);
		hash.Add(selectedItem?.Id);
		hash.Add(GetTotalItemCount());
		hash.Add(isHoldingSell);
		hash.Add(holdProgress);
		hash.Add(boostMessage);
		hash.Add(showMonsterPicker);
		hash.Add(consumableMessage);

		var relics = TamerManager.Instance?.CurrentTamer?.EquippedRelics;
		if (relics != null)
		{
			foreach (var r in relics)
				hash.Add(r);
		}

		var inventory = TamerManager.Instance?.CurrentTamer?.Inventory;
		if (inventory != null)
		{
			foreach (var kvp in inventory)
			{
				hash.Add(kvp.Key);
				hash.Add(kvp.Value);
			}
		}

		return hash.ToHashCode();
	}
}
