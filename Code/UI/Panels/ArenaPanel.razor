@namespace Beastborne.UI.Panels
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@using Beastborne.UI.Components;
@inherits Panel

<div class="arena-panel" onclick=@OnPanelClicked>
	@if (currentView == "mode-select")
	{
		<!-- Section Header -->
		<div class="arena-section-header">
			<div class="arena-section-left">
				<span class="arena-section-title">Arena</span>
				<span class="arena-section-subtitle">Battle other tamers in ranked matches</span>
			</div>
			<button class="arena-back-btn" onclick=@OnBackToHub><span>Back</span></button>
		</div>

		<!-- Mode Select Screen -->
		<div class="mode-select-screen">
			<div class="mode-header">
				<span class="mode-title">ARENA</span>
				<span class="season-badge">SEASON @GetSeason()</span>
			</div>

			<div class="mode-cards">
				<div class="mode-card ranked" onclick=@(() => SelectMode(CompetitiveManager.ArenaMode.Ranked))>
					<span class="mode-icon">&#9876;</span>
					<span class="mode-name">RANKED</span>
					<span class="mode-desc">Compete for rank points in Best of 3</span>
					<div class="mode-rank" style="color: @GetRankColor()">
						<span class="mode-rank-icon">@GetRankIcon()</span>
						<span class="mode-rank-name">@GetRank()</span>
					</div>
					<span class="mode-rank-points">@GetArenaPoints() pts</span>
					<div class="mode-stats">
						<span class="mode-stat">@GetWins()W</span>
						<span class="mode-stat-divider">/</span>
						<span class="mode-stat">@GetLosses()L</span>
						<span class="mode-stat-divider">·</span>
						<span class="mode-stat">@GetWinRate()%</span>
					</div>
				</div>

				<div class="mode-card quickplay" onclick=@(() => SelectMode(CompetitiveManager.ArenaMode.QuickPlay))>
					<span class="mode-icon">&#9889;</span>
					<span class="mode-name">QUICK PLAY</span>
					<span class="mode-desc">Casual Bo3 — no rank points at stake</span>
					<span class="mode-casual-badge">CASUAL</span>
				</div>
			</div>

			<!-- Rules Summary Bar -->
			<div class="arena-rules-bar">
				<span class="rule-item">Bo3</span>
				<span class="rule-divider">|</span>
				<span class="rule-item">Lv.50 Normalized</span>
				<span class="rule-divider">|</span>
				<span class="rule-item">No Skill Tree</span>
				@if (GetBannedSpecies().Count > 0)
				{
					<span class="rule-divider">|</span>
					<span class="rule-item ban">@GetBannedSpecies().Count Banned</span>
				}
			</div>

			<!-- Side Actions -->
			<div class="side-actions">
				<button class="side-btn" onclick=@ViewLeaderboard>
					<span class="btn-icon">&#128142;</span>
					<span class="btn-text">LEADERBOARD</span>
				</button>
				@if (HasMatchHistory())
				{
					<button class="side-btn" onclick=@ViewMatchHistory>
						<span class="btn-icon">&#128196;</span>
						<span class="btn-text">HISTORY</span>
					</button>
				}
				<button class="side-btn" onclick=@ViewRules>
					<span class="btn-icon">&#128220;</span>
					<span class="btn-text">RULES</span>
				</button>
			</div>
		</div>
	}
	else if (currentView == "team-select")
	{
		<!-- Team Selection Screen (Expedition-style) -->
		<div class="team-select-screen">
			<div class="team-select-header">
				<button class="back-btn" onclick=@BackToModeSelect>&#8592;</button>
				<div class="header-titles">
					<span class="team-select-title">SELECT YOUR TEAM</span>
					<span class="team-select-subtitle">@(selectedMode == CompetitiveManager.ArenaMode.Ranked ? "Ranked" : "Quick Play") — Best of 3</span>
				</div>
				<div class="team-counter">
					<span class="count-current">@selectedTeam.Count</span>
					<span class="count-divider">/</span>
					<span class="count-max">3</span>
				</div>
			</div>

			<div class="team-selection-layout">
				<!-- Left: Filters + Monster Grid -->
				<div class="selection-left">
					<div class="selection-top">
						<FilterBar
							CurrentElement=@arenaFilter
							CurrentSort=@arenaSort
							CurrentRarity=@arenaRarity
							SortAscending=@arenaSortAscending
							ShowBeastiarySort=@true
							ShowRarityFilter=@true
							OnElementChanged=@OnArenaElementChanged
							OnSortChanged=@OnArenaSortChanged
							OnRarityChanged=@OnArenaRarityChanged
							OnNameFilterChanged=@OnArenaNameFilterChanged
							OnSortDirectionChanged=@OnArenaSortDirectionChanged
							AvailableNames=@GetArenaMonsterNames() />

						@{
							var hoveredMonster = GetHoveredMonster();
						}
						@if (hoveredMonster != null)
						{
							@{
								var hSpecies = MonsterManager.Instance?.GetSpecies(hoveredMonster.SpeciesId);
							}
							<div class="monster-hover-tooltip">
								<div class="tooltip-name">@hoveredMonster.Nickname</div>
								<div class="tooltip-level">Lv.@hoveredMonster.Level</div>
								<div class="tooltip-element @(hSpecies?.Element.ToString().ToLower() ?? "neutral")">@hSpecies?.Element</div>
								<div class="tooltip-stat"><span class="stat-name">HP</span><span class="stat-val">@hoveredMonster.MaxHP</span></div>
								<div class="tooltip-stat"><span class="stat-name">ATK</span><span class="stat-val">@hoveredMonster.ATK</span></div>
								<div class="tooltip-stat"><span class="stat-name">DEF</span><span class="stat-val">@hoveredMonster.DEF</span></div>
								<div class="tooltip-stat"><span class="stat-name">SpA</span><span class="stat-val">@hoveredMonster.SpA</span></div>
								<div class="tooltip-stat"><span class="stat-name">SpD</span><span class="stat-val">@hoveredMonster.SpD</span></div>
								<div class="tooltip-stat"><span class="stat-name">SPD</span><span class="stat-val">@hoveredMonster.SPD</span></div>
								<div class="tooltip-genes"><span class="genes-label">Genes</span><span class="genes-value">@GetTotalGenes(hoveredMonster)/186</span></div>
								<div class="tooltip-power"><span class="power-label">PWR</span><span class="power-val">@hoveredMonster.PowerRating</span></div>
								@if (hoveredMonster.Traits != null && hoveredMonster.Traits.Count > 0)
								{
									<div class="tooltip-traits">
										@foreach (var traitId in hoveredMonster.Traits)
										{
											var trait = TraitDatabase.GetTrait(traitId);
											if (trait != null)
											{
												<span class="trait-badge">@trait.Name</span>
											}
										}
									</div>
								}
							</div>
						}
					</div>

					<div class="available-monsters">
						@foreach (var monster in GetFilteredAvailableMonsters())
						{
							var m = monster;
							var isSelected = selectedTeam.Contains(m);
							var isBanned = CompetitiveManager.Instance?.IsSpeciesBanned(m.SpeciesId) == true;
							var isHovered = hoveredMonsterId.HasValue && hoveredMonsterId.Value == m.Id;
							<div class="monster-option @(isSelected ? "in-team" : "") @(isBanned ? "banned" : "")">
								<MonsterCard Monster=@m IsCompact=@true AnimateOnHover=@true
											 AnimationFrame=@SpriteAnimator.GlobalFrame
											 ShouldAnimate=@isHovered
											 ClickAction=@(() => { if (!isBanned) ToggleMonster(m); else SoundManager.PlayDeny(); })
											 HoverAction=@(() => OnMonsterHover(m.Id))
											 LeaveAction=@OnMonsterLeave />
								@if (isBanned)
								{
									<div class="banned-overlay">
										<span class="banned-text">BANNED</span>
									</div>
								}
							</div>
						}
					</div>
				</div>

				<!-- Right: Team Slots + Battle Buttons -->
				<div class="selection-right">
					<span class="team-label">YOUR TEAM</span>
					<div class="selected-team-slots">
						@for (int i = 0; i < 3; i++)
						{
							var index = i;
							var monster = selectedTeam.Count > index ? selectedTeam[index] : null;
							<div class="team-slot @(monster != null ? "filled" : "empty")"
								 onclick=@(() => { if (monster != null) RemoveFromTeam(monster); })>
								@if (monster != null)
								{
									<MonsterCard Monster=@monster IsCompact=@true AnimationFrame=@SpriteAnimator.GlobalFrame />
									<div class="level-badge">Lv.50</div>
								}
								else
								{
									<div class="slot-empty">
										<span class="slot-number">@(index + 1)</span>
									</div>
								}
							</div>
						}
					</div>

					<div class="battle-buttons">
						@if (IsOnlineAvailable())
						{
							<button class="battle-btn online @(selectedTeam.Count == 0 ? "disabled" : "")"
									onclick=@FindOnlineOpponent>
								<span class="btn-icon">&#9876;</span>
								<span class="btn-text">FIND OPPONENT</span>
								<span class="btn-sub">@GetPlayersSearching() online</span>
							</button>
						}
						@if (selectedMode != CompetitiveManager.ArenaMode.Ranked)
						{
							<button class="battle-btn ai @(selectedTeam.Count == 0 ? "disabled" : "")"
									onclick=@FindAIOpponent>
								<span class="btn-icon">&#9881;</span>
								<span class="btn-text">VS AI</span>
								<span class="btn-sub">Practice battle</span>
							</button>
						}
					</div>
				</div>
			</div>
		</div>
	}
	else if (currentView == "matchmaking")
	{
		<!-- Matchmaking View -->
		<div class="matchmaking-screen">
			<div class="mm-icon-container">
				<div class="mm-pulse-ring"></div>
				<div class="mm-pulse-ring mm-delay"></div>
				<div class="mm-icon">&#9876;</div>
			</div>
			@if (isOnlineMatchmaking)
			{
				<div class="mm-status">
					<span class="mm-title">SEARCHING FOR OPPONENT</span>
					<div class="mm-dots">
						<span class="mm-dot"></span>
						<span class="mm-dot"></span>
						<span class="mm-dot"></span>
					</div>
				</div>
				<span class="mm-timer">@GetQueueTime()</span>
				<span class="mm-queue">@GetPlayersSearching() players in queue</span>
				<button class="mm-cancel-btn" onclick=@CancelOnlineSearch>
					<span>CANCEL</span>
				</button>
			}
			else
			{
				<div class="mm-status">
					<span class="mm-title">FINDING OPPONENT</span>
					<div class="mm-dots">
						<span class="mm-dot"></span>
						<span class="mm-dot"></span>
						<span class="mm-dot"></span>
					</div>
				</div>
			}
		</div>
	}
	else if (currentView == "vs-splash")
	{
		<!-- VS Splash Screen -->
		<div class="vs-splash-screen">
			<div class="vs-side player">
				<span class="vs-name">@GetPlayerName()</span>
				<span class="vs-rank" style="color: @GetRankColor()">@GetRank()</span>
				<div class="vs-team">
					@foreach (var monster in selectedTeam)
					{
						<div class="vs-monster">
							<MonsterCard Monster=@monster IsCompact=@true AnimationFrame=@SpriteAnimator.GlobalFrame />
						</div>
					}
				</div>
			</div>

			<div class="vs-center">
				<span class="vs-text">VS</span>
			</div>

			<div class="vs-side opponent">
				<span class="vs-name">@(currentOpponent?.Name ?? "Opponent")</span>
				<span class="vs-rank" style="color: @CompetitiveManager.GetRankColor(currentOpponent?.Rank ?? "")">
					@(currentOpponent?.Rank ?? "")
				</span>
				<div class="vs-team">
					@foreach (var monster in currentOpponent?.Team ?? new())
					{
						<div class="vs-monster">
							<MonsterCard Monster=@monster IsCompact=@true AnimationFrame=@SpriteAnimator.GlobalFrame />
						</div>
					}
				</div>
			</div>
		</div>
	}
	else if (currentView == "opponent-found")
	{
		<!-- Opponent Found View (online ready-check) -->
		<div class="opponent-screen">
			<div class="opponent-header">
				@if (currentOpponent?.IsRealPlayer == true)
				{
					<span class="real-player-badge">REAL PLAYER</span>
				}
				<span class="bo3-label-text">BEST OF 3</span>
			</div>

			<div class="matchup">
				<div class="matchup-side player">
					<span class="matchup-name">@GetPlayerName()</span>
					<span class="matchup-rank" style="color: @GetRankColor()">@GetRank()</span>
					<div class="matchup-team">
						@foreach (var monster in selectedTeam)
						{
							<div class="matchup-monster">
								<MonsterCard Monster=@monster IsCompact=@true UseStaticImage=@true />
							</div>
						}
					</div>
				</div>

				<span class="matchup-vs">VS</span>

				<div class="matchup-side opponent">
					<span class="matchup-name">@currentOpponent?.Name</span>
					<span class="matchup-rank" style="color: @CompetitiveManager.GetRankColor(currentOpponent?.Rank ?? "")">
						@currentOpponent?.Rank
					</span>
					<div class="matchup-team">
						@foreach (var monster in currentOpponent?.Team ?? new())
						{
							<div class="matchup-monster">
								<MonsterCard Monster=@monster IsCompact=@true UseStaticImage=@true />
							</div>
						}
					</div>
				</div>
			</div>

			<span class="bo3-label">First to 2 wins — Lv.50 Normalized</span>

			<div class="opponent-actions">
				@if (isWaitingForOpponent)
				{
					<div class="waiting-indicator">
						<span class="waiting-text">Waiting for opponent...</span>
					</div>
					<button class="action-btn cancel" onclick=@CancelMatch>
						<span class="cancel-text">CANCEL</span>
					</button>
				}
				else
				{
					<button class="action-btn battle" onclick=@StartBattle>
						<span class="battle-text">BEGIN SET</span>
					</button>
					<button class="action-btn cancel" onclick=@CancelMatch>
						<span class="cancel-text">CANCEL</span>
					</button>
				}
			</div>
		</div>
	}
	else if (currentView == "battle")
	{
		<!-- Battle View -->
		<div class="battle-container">
			<div class="battle-view-wrapper">
				<BattleView OnBattleEnd=@OnGameComplete OnArenaRetire=@OnArenaRetire IsArenaBattle=@true
					ArenaPlayerName=@GetPlayerName()
					ArenaOpponentName=@(currentOpponent?.Name ?? "Opponent")
					ArenaPlayerWins=@(CompetitiveManager.Instance?.SetScorePlayer ?? 0)
					ArenaOpponentWins=@(CompetitiveManager.Instance?.SetScoreOpponent ?? 0)
					ArenaGameNumber=@(CompetitiveManager.Instance?.CurrentGameNumber ?? 1) />
			</div>
		</div>
	}
	else if (currentView == "between-games")
	{
		<!-- Between Games Screen -->
		<div class="between-games-screen">
			<!-- Score Display -->
			<div class="between-score-card">
				<div class="between-score-side player">
					<span class="between-name">@GetPlayerName()</span>
					<span class="between-wins">@(CompetitiveManager.Instance?.SetScorePlayer ?? 0)</span>
				</div>
				<div class="between-vs-divider">
					<span class="between-vs-text">VS</span>
				</div>
				<div class="between-score-side opponent">
					<span class="between-name">@(currentOpponent?.Name ?? "Opponent")</span>
					<span class="between-wins">@(CompetitiveManager.Instance?.SetScoreOpponent ?? 0)</span>
				</div>
			</div>

			<!-- Game Results -->
			<div class="between-game-results">
				@{
					var totalGames = 3;
					var results = CompetitiveManager.Instance?.GameResults;
				}
				@for (int i = 0; i < totalGames; i++)
				{
					if (results != null && i < results.Count)
					{
						var won = results[i];
						<div class="game-pip @(won ? "win" : "loss")">
							<span class="game-pip-icon">@(won ? "W" : "L")</span>
						</div>
					}
					else
					{
						<div class="game-pip upcoming">
							<span class="game-pip-icon">-</span>
						</div>
					}
				}
			</div>

			<!-- Info Section -->
			<div class="between-info">
				<div class="healed-badge">
					<span class="healed-icon">+</span>
					<span class="healed-text">Teams fully healed</span>
				</div>
				<span class="between-countdown">@GetBetweenGamesCountdown()</span>
				<span class="countdown-label">seconds until next game</span>
			</div>

			<!-- Ready Button -->
			<button class="between-ready-btn" onclick=@SkipCountdown>
				<span class="ready-text">READY</span>
			</button>
		</div>
	}
	else if (currentView == "result")
	{
		<!-- Set Result View -->
		<div class="result-screen @(lastSetWon ? "victory" : "defeat")">
			<!-- Title -->
			<div class="arena-result-title-wrap" style="background-color: @(lastSetWon ? "rgba(74, 222, 128, 0.1)" : "rgba(239, 68, 68, 0.1)"); border-bottom: 2px solid @(lastSetWon ? "rgba(74, 222, 128, 0.3)" : "rgba(239, 68, 68, 0.3)")">
				<span class="arena-result-title" style="color: @(lastSetWon ? "#4ade80" : "#ef4444")">@(lastSetWon ? "VICTORY" : "DEFEAT")</span>
			</div>

			<!-- Score Card -->
			<div class="result-score-card">
				<div class="result-score-side @(lastSetWon ? "winner" : "")">
					<span class="result-score-name">@GetPlayerName()</span>
					<span class="result-score-num">@(CompetitiveManager.Instance?.SetScorePlayer ?? 0)</span>
				</div>
				<div class="result-score-divider">
					<span class="result-score-dash">-</span>
				</div>
				<div class="result-score-side @(!lastSetWon ? "winner" : "")">
					<span class="result-score-name">@(currentOpponent?.Name ?? "Opponent")</span>
					<span class="result-score-num">@(CompetitiveManager.Instance?.SetScoreOpponent ?? 0)</span>
				</div>
			</div>

			<!-- Game-by-Game Pips -->
			<div class="result-games">
				@for (int i = 0; i < (CompetitiveManager.Instance?.GameResults?.Count ?? 0); i++)
				{
					var won = CompetitiveManager.Instance.GameResults[i];
					<div class="result-game-pip @(won ? "win" : "loss")">
						<span class="result-game-label">G@(i + 1)</span>
						<span class="result-game-result">@(won ? "W" : "L")</span>
					</div>
				}
			</div>

			<!-- Points Change -->
			@if (selectedMode == CompetitiveManager.ArenaMode.Ranked)
			{
				<div class="result-points @(lastPointsChange >= 0 ? "gain" : "loss")">
					<span class="result-points-value">@(lastPointsChange >= 0 ? "+" : "")@lastPointsChange</span>
					<span class="result-points-label">Rating</span>
				</div>
			}
			else
			{
				<div class="result-points casual">
					<span class="result-points-casual">Quick Play — No rank change</span>
				</div>
			}

			<!-- Rank Display -->
			<div class="result-rank-card">
				<span class="result-rank-label">Current Rank</span>
				<span class="result-rank-title" style="color: @GetRankColor()">@GetRank()</span>
				<span class="result-rank-pts">@GetArenaPoints() Points</span>
			</div>

			<!-- Rank-Up Celebration -->
			@if (showRankUp && selectedMode == CompetitiveManager.ArenaMode.Ranked)
			{
				<div class="rank-up-overlay" onclick=@DismissRankUp>
					<div class="rank-up-content">
						<span class="rank-up-old" style="color: @CompetitiveManager.GetRankColor(previousRank)">@previousRank</span>
						<span class="rank-up-arrow">&#8593;</span>
						<span class="rank-up-new" style="color: @GetRankColor()">@GetRank()</span>
						<span class="rank-up-text">RANK UP!</span>
					</div>
				</div>
			}

			<!-- Continue Button -->
			<button class="result-continue-btn" onclick=@ReturnToModeSelect>
				<span class="result-continue-text">CONTINUE</span>
			</button>
		</div>
	}
	else if (currentView == "leaderboard")
	{
		<LeaderboardPanel OnBack=@ReturnToModeSelect FilterMode="arena" />
	}
	else if (currentView == "history")
	{
		<!-- Match History View -->
		<div class="history-screen">
			<div class="history-header">
				<span class="history-title">MATCH HISTORY</span>
				<button class="close-btn" onclick=@ReturnToModeSelect>
					<span class="close-text">x</span>
				</button>
			</div>
			<div class="history-list">
				@foreach (var entry in GetMatchHistory())
				{
					<div class="history-entry @(entry.Won ? "win" : "loss")">
						<span class="history-result">@(entry.Won ? "W" : "L")</span>
						<div class="history-info">
							<span class="history-opponent">vs @entry.OpponentName</span>
							<span class="history-score">@entry.GamesWon - @entry.GamesLost</span>
						</div>
						<span class="history-mode">@(entry.IsRanked ? "Ranked" : "Casual")</span>
						<span class="history-points @(entry.PointsChange >= 0 ? "gain" : "loss")">
							@(entry.IsRanked ? (entry.PointsChange >= 0 ? "+" : "") + entry.PointsChange.ToString() : "—")
						</span>
						<span class="history-date">@entry.PlayedAt.ToString("MMM dd")</span>
					</div>
				}
				@if (!HasMatchHistory())
				{
					<span class="history-empty">No matches played yet.</span>
				}
			</div>
		</div>
	}
	else if (currentView == "rules")
	{
		<!-- Rules View -->
		<div class="rules-screen">
			<div class="rules-header">
				<span class="rules-title">ARENA RULES</span>
				<button class="close-btn" onclick=@ReturnToModeSelect>
					<span class="close-text">x</span>
				</button>
			</div>

			<div class="rules-content">
				<div class="rule-section">
					<span class="rule-section-title">FORMAT</span>
					<div class="rule-item">
						<span class="rule-icon">&#9876;</span>
						<span class="rule-text">Best of 3 — First to 2 wins</span>
					</div>
					<div class="rule-item">
						<span class="rule-icon">&#127991;</span>
						<span class="rule-text">All monsters normalized to Level 50</span>
					</div>
					<div class="rule-item">
						<span class="rule-icon">&#128683;</span>
						<span class="rule-text">Skill tree, relic, and veteran bonuses are stripped</span>
					</div>
					<div class="rule-item">
						<span class="rule-icon">&#128296;</span>
						<span class="rule-text">Teams fully healed between games</span>
					</div>
				</div>

				<div class="rule-section">
					<span class="rule-section-title">SEASON @GetSeason() BANS</span>
					@if (GetBannedSpecies().Count > 0)
					{
						<div class="ban-grid">
							@foreach (var speciesId in GetBannedSpecies())
							{
								<div class="ban-entry">
									<span class="ban-name">@GetSpeciesName(speciesId)</span>
								</div>
							}
						</div>
					}
					else
					{
						<span class="no-bans">No species are banned this season</span>
					}
				</div>

				<div class="rule-section">
					<span class="rule-section-title">RANKING</span>
					<div class="rule-item">
						<span class="rule-text">Ranked: Points gained/lost based on opponent rating</span>
					</div>
					<div class="rule-item">
						<span class="rule-text">Quick Play: No rank points at stake</span>
					</div>
					<div class="rule-item">
						<span class="rule-text">First 10 sets have 2x point swings (placement)</span>
					</div>
				</div>
			</div>
		</div>
	}
</div>

@code {
	public Action OnBack { get; set; }

	private string currentView = "mode-select";
	private CompetitiveManager.ArenaMode selectedMode = CompetitiveManager.ArenaMode.Ranked;
	private List<Monster> selectedTeam = new();
	private ArenaOpponent currentOpponent;

	private bool lastSetWon = false;
	private int lastPointsChange = 0;

	// Rank-up state
	private bool showRankUp = false;
	private string previousRank = "";

	// Online matchmaking state
	private bool isOnlineMatchmaking = false;
	private DateTime queueStartTime;
	private string matchmakingError = null;
	private bool isWaitingForOpponent = false;

	// Team selection state (expedition-style)
	private string arenaFilter = "all";
	private string arenaSort = "power";
	private string arenaRarity = "all";
	private string arenaNameFilter = "";
	private bool arenaSortAscending = false;
	private Guid? hoveredMonsterId = null;

	// Keyboard navigation
	private int selectedMonsterIndex = 0;
	private int selectedModeIndex = 0;

	private void OnPanelClicked()
	{
		GameHUD.EnterPanel();
	}

	protected override void OnAfterTreeRender( bool firstTime )
	{
		if ( firstTime )
		{
			SubscribeEvents();
		}
	}

	private void SubscribeEvents()
	{
		if ( CompetitiveManager.Instance == null ) return;

		CompetitiveManager.Instance.OnOpponentFound -= OnOnlineOpponentFound;
		CompetitiveManager.Instance.OnOpponentFound += OnOnlineOpponentFound;
		CompetitiveManager.Instance.OnMatchmakingError -= OnMatchmakingError;
		CompetitiveManager.Instance.OnMatchmakingError += OnMatchmakingError;
		CompetitiveManager.Instance.OnOpponentDisconnected -= OnOpponentDisconnected;
		CompetitiveManager.Instance.OnOpponentDisconnected += OnOpponentDisconnected;
		CompetitiveManager.Instance.OnBothPlayersReady -= OnBothPlayersReady;
		CompetitiveManager.Instance.OnBothPlayersReady += OnBothPlayersReady;
		CompetitiveManager.Instance.OnGameEnd -= OnGameEndEvent;
		CompetitiveManager.Instance.OnGameEnd += OnGameEndEvent;
		CompetitiveManager.Instance.OnBetweenGamesStart -= OnBetweenGamesStart;
		CompetitiveManager.Instance.OnBetweenGamesStart += OnBetweenGamesStart;
		CompetitiveManager.Instance.OnNextGameStart -= OnNextGameStartEvent;
		CompetitiveManager.Instance.OnNextGameStart += OnNextGameStartEvent;
		CompetitiveManager.Instance.OnSetComplete -= OnSetCompleteEvent;
		CompetitiveManager.Instance.OnSetComplete += OnSetCompleteEvent;
	}

	private float lastMatchmakingUpdate = 0f;

	public override void Tick()
	{
		base.Tick();

		// Force UI refresh during dynamic views so timers/animations update without mouse input
		// Note: vs-splash is excluded because StateHasChanged resets CSS animations (beasts disappear)
		if ( (currentView == "matchmaking" || currentView == "between-games" || currentView == "opponent-found")
			&& RealTime.Now - lastMatchmakingUpdate >= 1f )
		{
			lastMatchmakingUpdate = RealTime.Now;
			StateHasChanged();
		}
	}

	public void TickInput()
	{
		HandleKeyboardInput();
	}

	// ═══════════════════════════════════════════════════════════════
	// KEYBOARD NAVIGATION
	// ═══════════════════════════════════════════════════════════════

	private void HandleKeyboardInput()
	{
		if (currentView == "mode-select")
		{
			if (Input.Pressed("Up"))
			{
				GameHUD.ExitPanel();
				return;
			}
			if (Input.Pressed("Left") || Input.Pressed("Right"))
			{
				selectedModeIndex = selectedModeIndex == 0 ? 1 : 0;
				SoundManager.PlayHover();
			}
			else if (Input.Pressed("attack1") || Input.Pressed("jump") || Input.Pressed("Down"))
			{
				var mode = selectedModeIndex == 0 ? CompetitiveManager.ArenaMode.Ranked : CompetitiveManager.ArenaMode.QuickPlay;
				SelectMode(mode);
			}
			else if (Input.Pressed("reload"))
			{
				ViewLeaderboard();
			}
		}
		else if (currentView == "team-select")
		{
			var monsters = GetFilteredAvailableMonsters();
			if (monsters.Count > 0)
			{
				selectedMonsterIndex = Math.Clamp(selectedMonsterIndex, 0, monsters.Count - 1);
				int columns = 4;

				if (Input.Pressed("Left"))
				{
					selectedMonsterIndex = Math.Max(0, selectedMonsterIndex - 1);
					SoundManager.PlayHover();
				}
				else if (Input.Pressed("Right"))
				{
					selectedMonsterIndex = Math.Min(monsters.Count - 1, selectedMonsterIndex + 1);
					SoundManager.PlayHover();
				}
				else if (Input.Pressed("Up"))
				{
					if (selectedMonsterIndex < columns)
					{
						BackToModeSelect();
					}
					else
					{
						selectedMonsterIndex = Math.Max(0, selectedMonsterIndex - columns);
						SoundManager.PlayHover();
					}
				}
				else if (Input.Pressed("Down"))
				{
					selectedMonsterIndex = Math.Min(monsters.Count - 1, selectedMonsterIndex + columns);
					SoundManager.PlayHover();
				}
				else if (Input.Pressed("attack1") || Input.Pressed("jump"))
				{
					var monster = monsters[selectedMonsterIndex];
					if (CompetitiveManager.Instance?.IsSpeciesBanned(monster.SpeciesId) != true)
					{
						ToggleMonster(monster);
					}
					else
					{
						SoundManager.PlayDeny();
					}
				}
			}

			if (Input.Pressed("reload") && selectedTeam.Count > 0)
			{
				FindAIOpponent();
			}
			if (Input.Pressed("Menu") || Input.Pressed("run"))
			{
				BackToModeSelect();
			}
			// Quick-remove from team slots
			if (Input.Pressed("Slot1") && selectedTeam.Count > 0) RemoveFromTeam(selectedTeam[0]);
			else if (Input.Pressed("Slot2") && selectedTeam.Count > 1) RemoveFromTeam(selectedTeam[1]);
			else if (Input.Pressed("Slot3") && selectedTeam.Count > 2) RemoveFromTeam(selectedTeam[2]);
		}
		else if (currentView == "opponent-found")
		{
			if (Input.Pressed("attack1") || Input.Pressed("jump"))
			{
				StartBattle();
			}
			else if (Input.Pressed("Menu") || Input.Pressed("run") || Input.Pressed("Up"))
			{
				CancelMatch();
			}
		}
		else if (currentView == "between-games")
		{
			if (Input.Pressed("attack1") || Input.Pressed("jump"))
			{
				SkipCountdown();
			}
		}
		else if (currentView == "result")
		{
			if (Input.Pressed("attack1") || Input.Pressed("jump") || Input.Pressed("Menu"))
			{
				if (showRankUp)
					DismissRankUp();
				else
					ReturnToModeSelect();
			}
		}
		else if (currentView == "leaderboard" || currentView == "history" || currentView == "rules")
		{
			if (Input.Pressed("Menu") || Input.Pressed("run") || Input.Pressed("Up"))
			{
				ReturnToModeSelect();
			}
		}
	}

	// ═══════════════════════════════════════════════════════════════
	// MODE SELECTION
	// ═══════════════════════════════════════════════════════════════

	private void SelectMode(CompetitiveManager.ArenaMode mode)
	{
		selectedMode = mode;
		CompetitiveManager.Instance?.SetMode(mode);
		SoundManager.PlaySelect();
		currentView = "team-select";
	}

	private void OnBackToHub()
	{
		SoundManager.PlayBack();
		OnBack?.Invoke();
	}

	private void BackToModeSelect()
	{
		SoundManager.PlayBack();
		currentView = "mode-select";
	}

	// ═══════════════════════════════════════════════════════════════
	// TEAM MANAGEMENT (Expedition-style)
	// ═══════════════════════════════════════════════════════════════

	private void ToggleMonster(Monster monster)
	{
		if (selectedTeam.Contains(monster))
		{
			selectedTeam.Remove(monster);
			SoundManager.PlayBack();
		}
		else if (selectedTeam.Count < 3)
		{
			selectedTeam.Add(monster);
			SoundManager.PlaySelect();
		}
		else
		{
			SoundManager.PlayDeny();
		}
	}

	private void RemoveFromTeam(Monster monster)
	{
		SoundManager.PlayBack();
		selectedTeam.Remove(monster);
	}

	// ═══════════════════════════════════════════════════════════════
	// FILTER & MONSTER LIST
	// ═══════════════════════════════════════════════════════════════

	private void OnArenaElementChanged(string element) { arenaFilter = element; }
	private void OnArenaSortChanged(string sort) { arenaSort = sort; }
	private void OnArenaRarityChanged(string rarity) { arenaRarity = rarity; }
	private void OnArenaNameFilterChanged(string name) { arenaNameFilter = name; }
	private void OnArenaSortDirectionChanged(bool ascending) { arenaSortAscending = ascending; }

	private List<string> GetArenaMonsterNames()
	{
		return MonsterManager.Instance?.OwnedMonsters
			?.Select(m => m.Nickname)
			?.Distinct()
			?.OrderBy(n => n)
			?.ToList() ?? new();
	}

	private Monster GetHoveredMonster()
	{
		if (!hoveredMonsterId.HasValue) return null;
		return MonsterManager.Instance?.OwnedMonsters?.FirstOrDefault(m => m.Id == hoveredMonsterId.Value);
	}

	private void OnMonsterHover(Guid id) { hoveredMonsterId = id; }
	private void OnMonsterLeave() { hoveredMonsterId = null; }

	private int GetTotalGenes(Monster m)
	{
		if (m?.Genetics == null) return 0;
		return m.Genetics.HPGene + m.Genetics.ATKGene + m.Genetics.DEFGene +
			   m.Genetics.SpAGene + m.Genetics.SpDGene + m.Genetics.SPDGene;
	}

	private List<Monster> GetFilteredAvailableMonsters()
	{
		var monsters = MonsterManager.Instance?.OwnedMonsters;
		if (monsters == null) return new();

		var filtered = monsters.Where(m => !selectedTeam.Contains(m));

		// Element filter
		if (arenaFilter != "all")
		{
			filtered = filtered.Where(m =>
			{
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				if (species == null) return false;
				return species.Element.ToString().ToLower() == arenaFilter;
			});
		}

		// Rarity filter
		if (arenaRarity != "all")
		{
			filtered = filtered.Where(m =>
			{
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				if (species == null) return false;
				return species.BaseRarity.ToString().ToLower() == arenaRarity;
			});
		}

		// Name filter
		if (!string.IsNullOrEmpty(arenaNameFilter))
		{
			filtered = filtered.Where(m =>
				m.Nickname?.Contains(arenaNameFilter, StringComparison.OrdinalIgnoreCase) == true);
		}

		// Sorting
		var list = filtered.ToList();

		list = arenaSort switch
		{
			"power" => arenaSortAscending ? list.OrderBy(m => m.PowerRating).ToList() : list.OrderByDescending(m => m.PowerRating).ToList(),
			"level" => arenaSortAscending ? list.OrderBy(m => m.Level).ToList() : list.OrderByDescending(m => m.Level).ToList(),
			"genes" => arenaSortAscending ? list.OrderBy(m => m.Genetics?.TotalValue ?? 0).ToList() : list.OrderByDescending(m => m.Genetics?.TotalValue ?? 0).ToList(),
			"basestats" => arenaSortAscending
				? list.OrderBy(m => { var s = MonsterManager.Instance?.GetSpecies(m.SpeciesId); return s != null ? s.BaseHP + s.BaseATK + s.BaseDEF + s.BaseSpA + s.BaseSpD + s.BaseSPD : 0; }).ToList()
				: list.OrderByDescending(m => { var s = MonsterManager.Instance?.GetSpecies(m.SpeciesId); return s != null ? s.BaseHP + s.BaseATK + s.BaseDEF + s.BaseSpA + s.BaseSpD + s.BaseSPD : 0; }).ToList(),
			"rarity" => arenaSortAscending
				? list.OrderBy(m => MonsterManager.Instance?.GetSpecies(m.SpeciesId)?.BaseRarity ?? 0).ToList()
				: list.OrderByDescending(m => MonsterManager.Instance?.GetSpecies(m.SpeciesId)?.BaseRarity ?? 0).ToList(),
			"recent" => arenaSortAscending ? list.OrderBy(m => m.CaughtAt).ToList() : list.OrderByDescending(m => m.CaughtAt).ToList(),
			"name" => arenaSortAscending ? list.OrderByDescending(m => m.Nickname).ToList() : list.OrderBy(m => m.Nickname).ToList(),
			"fav" => list.OrderByDescending(m => m.IsFavorite ? 1 : 0).ThenByDescending(m => m.PowerRating).ToList(),
			"beastiary" => arenaSortAscending
				? list.OrderByDescending(m => MonsterManager.Instance?.GetSpecies(m.SpeciesId)?.BeastiaryNumber ?? 9999).ToList()
				: list.OrderBy(m => MonsterManager.Instance?.GetSpecies(m.SpeciesId)?.BeastiaryNumber ?? 9999).ToList(),
			_ => arenaSortAscending ? list.OrderBy(m => m.PowerRating).ToList() : list.OrderByDescending(m => m.PowerRating).ToList()
		};

		return list;
	}

	// ═══════════════════════════════════════════════════════════════
	// HELPERS
	// ═══════════════════════════════════════════════════════════════

	private string GetRank() => CompetitiveManager.GetRankFromPoints(GetArenaPoints());
	private string GetRankColor() => CompetitiveManager.GetRankColor(GetRank());
	private string GetRankIcon() => CompetitiveManager.GetRankIcon(GetRank());
	private int GetArenaPoints() => TamerManager.Instance?.CurrentTamer?.ArenaPoints ?? 0;
	private int GetWins() => TamerManager.Instance?.CurrentTamer?.ArenaWins ?? 0;
	private int GetLosses() => TamerManager.Instance?.CurrentTamer?.ArenaLosses ?? 0;
	private int GetWinStreak() => TamerManager.Instance?.CurrentTamer?.ArenaWinStreak ?? 0;
	private int GetSeason() => CompetitiveManager.Instance?.Season ?? 0;
	private List<string> GetBannedSpecies() => CompetitiveManager.Instance?.BannedSpecies ?? new();

	private int GetWinRate()
	{
		var total = GetWins() + GetLosses();
		if (total == 0) return 0;
		return (int)((float)GetWins() / total * 100);
	}

	private string GetPlayerName() => TamerManager.Instance?.CurrentTamer?.Name ?? "Player";

	private string GetSpeciesName(string speciesId)
	{
		return MonsterManager.Instance?.GetSpecies(speciesId)?.Name ?? speciesId;
	}

	private bool HasSprite(Monster monster)
	{
		var species = MonsterManager.Instance?.GetSpecies(monster?.SpeciesId);
		if (species == null) return false;
		if (species.AnimationFrames != null && species.AnimationFrames.Count > 0) return true;
		if (!string.IsNullOrEmpty(species.IconPath)) return true;
		return false;
	}

	private string GetIconPath(Monster monster)
	{
		var species = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
		return species?.IconPath ?? "";
	}

	private string GetBetweenGamesCountdown()
	{
		var timer = CompetitiveManager.Instance?.BetweenGamesTimer ?? 0;
		return Math.Max(0, (int)Math.Ceiling(timer)).ToString();
	}

	private bool HasMatchHistory()
	{
		return TamerManager.Instance?.CurrentTamer?.MatchHistory?.Count > 0;
	}

	private List<MatchHistoryEntry> GetMatchHistory()
	{
		return TamerManager.Instance?.CurrentTamer?.MatchHistory ?? new();
	}

	// ═══════════════════════════════════════════════════════════════
	// AI OPPONENT
	// ═══════════════════════════════════════════════════════════════

	private async void FindAIOpponent()
	{
		if (selectedTeam.Count == 0)
		{
			SoundManager.PlayDeny();
			return;
		}

		SoundManager.PlayForward();
		currentView = "matchmaking";
		isOnlineMatchmaking = false;
		CompetitiveManager.Instance?.SetArenaTeam(selectedTeam);

		await Task.Delay(1500);

		CompetitiveManager.Instance?.FindOpponent();
		currentOpponent = CompetitiveManager.Instance?.CurrentOpponent;
		SoundManager.PlaySelect();
		currentView = "vs-splash";
		StateHasChanged();

		// Auto-transition from VS splash to battle
		await Task.Delay(3000);
		if (currentView == "vs-splash")
		{
			CompetitiveManager.Instance?.StartArenaSet();
			currentView = "battle";
			StateHasChanged();
		}
	}

	// ═══════════════════════════════════════════════════════════════
	// ONLINE MATCHMAKING
	// ═══════════════════════════════════════════════════════════════

	private bool IsOnlineAvailable() => CompetitiveManager.Instance?.IsNetworkActive ?? false;
	private int GetPlayersSearching() => CompetitiveManager.Instance?.PlayersInQueue ?? 0;

	private string GetQueueTime()
	{
		if (!isOnlineMatchmaking) return "";
		var elapsed = DateTime.UtcNow - queueStartTime;
		return $"{(int)elapsed.TotalMinutes}:{elapsed.Seconds:D2}";
	}

	private void FindOnlineOpponent()
	{
		if (selectedTeam.Count == 0)
		{
			SoundManager.PlayDeny();
			return;
		}

		SoundManager.PlayForward();
		currentView = "matchmaking";
		isOnlineMatchmaking = true;
		queueStartTime = DateTime.UtcNow;
		matchmakingError = null;

		CompetitiveManager.Instance?.SetArenaTeam(selectedTeam);
		SubscribeEvents();
		CompetitiveManager.Instance?.JoinOnlineQueue(selectedMode);
	}

	// ═══════════════════════════════════════════════════════════════
	// EVENT HANDLERS
	// ═══════════════════════════════════════════════════════════════

	private void OnOnlineOpponentFound(ArenaOpponent opponent)
	{
		currentOpponent = opponent;
		SoundManager.PlaySelect();
		currentView = "opponent-found";
		StateHasChanged();
	}

	private void OnMatchmakingError(string error)
	{
		matchmakingError = error;
		SoundManager.PlayDeny();
		currentView = "team-select";
		isOnlineMatchmaking = false;
		StateHasChanged();
	}

	private void OnOpponentDisconnected()
	{
		SoundManager.PlayDeny();
		if (currentView != "battle" && currentView != "between-games")
		{
			currentView = "team-select";
			currentOpponent = null;
			isWaitingForOpponent = false;
			StateHasChanged();
		}
	}

	private async void OnBothPlayersReady()
	{
		Log.Info("[ArenaPanel] Both players ready, showing VS splash");
		isWaitingForOpponent = false;
		currentView = "vs-splash";
		StateHasChanged();

		// Auto-transition from VS splash to battle
		await Task.Delay(3000);
		if (currentView == "vs-splash")
		{
			currentView = "battle";
			StateHasChanged();
		}
	}

	private void OnGameEndEvent(int playerScore, int opponentScore)
	{
		Log.Info($"[ArenaPanel] Game ended: {playerScore}-{opponentScore}");
	}

	private void OnBetweenGamesStart()
	{
		Log.Info("[ArenaPanel] Between games");
		BattleManager.Instance?.ExitBattle();
		currentView = "between-games";
	}

	private void OnNextGameStartEvent()
	{
		Log.Info("[ArenaPanel] Next game starting");
		currentView = "battle";
	}

	private void OnSetCompleteEvent(bool won, int pointsChange)
	{
		Log.Info($"[ArenaPanel] Set complete: won={won}, points={pointsChange}");
		lastSetWon = won;
		lastPointsChange = pointsChange;

		// Detect rank-up
		showRankUp = CompetitiveManager.Instance?.DidRankUp == true && selectedMode == CompetitiveManager.ArenaMode.Ranked;
		previousRank = CompetitiveManager.Instance?.PreviousRank ?? "";

		if (won) SoundManager.PlayVictory();
		else SoundManager.PlayDefeat();

		if (isOnlineMatchmaking)
		{
			CompetitiveManager.Instance?.OnOnlineBattleComplete(won);
		}

		isOnlineMatchmaking = false;
		isWaitingForOpponent = false;
		currentView = "result";
	}

	// ═══════════════════════════════════════════════════════════════
	// BATTLE FLOW
	// ═══════════════════════════════════════════════════════════════

	private void StartBattle()
	{
		Log.Info($"[ArenaPanel] StartBattle: isOnline={isOnlineMatchmaking}, IsRealPlayer={currentOpponent?.IsRealPlayer}");
		SoundManager.PlayBattleStart();

		if (isOnlineMatchmaking && currentOpponent?.IsRealPlayer == true)
		{
			isWaitingForOpponent = true;
			CompetitiveManager.Instance?.SignalReady();
		}
		else
		{
			CompetitiveManager.Instance?.StartArenaSet();
			currentView = "battle";
		}
	}

	private void OnGameComplete(bool playerWon)
	{
		Log.Info($"[ArenaPanel] Game complete: playerWon={playerWon}");
		CompetitiveManager.Instance?.RecordGameResult(playerWon);
	}

	private void OnArenaRetire()
	{
		Log.Info("[ArenaPanel] Player retired from arena match");
		CompetitiveManager.Instance?.ForfeitSet();
	}

	private void SkipCountdown()
	{
		SoundManager.PlayClick();
		CompetitiveManager.Instance?.SkipBetweenGamesTimer();
	}

	private void CancelOnlineSearch()
	{
		SoundManager.PlayBack();
		CompetitiveManager.Instance?.LeaveOnlineQueue();
		isOnlineMatchmaking = false;
		isWaitingForOpponent = false;
		currentView = "team-select";
	}

	private void CancelMatch()
	{
		SoundManager.PlayBack();
		if (isOnlineMatchmaking)
		{
			CompetitiveManager.Instance?.LeaveOnlineQueue();
		}
		CompetitiveManager.Instance?.ResetToIdle();
		isOnlineMatchmaking = false;
		isWaitingForOpponent = false;
		currentOpponent = null;
		currentView = "team-select";
	}

	private void ReturnToModeSelect()
	{
		SoundManager.PlayClick();
		CompetitiveManager.Instance?.ResetToIdle();
		currentOpponent = null;
		isOnlineMatchmaking = false;
		isWaitingForOpponent = false;
		showRankUp = false;
		currentView = "mode-select";
	}

	private void DismissRankUp()
	{
		showRankUp = false;
	}

	private void ViewLeaderboard()
	{
		SoundManager.PlayForward();
		currentView = "leaderboard";
	}

	private void ViewMatchHistory()
	{
		SoundManager.PlayForward();
		currentView = "history";
	}

	private void ViewRules()
	{
		SoundManager.PlayForward();
		currentView = "rules";
	}
}
