@namespace Beastborne.UI.Panels
@using System;
@using System.Linq;
@using Sandbox;
@using Sandbox.UI;
@using Sandbox.Network;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@using Beastborne.UI.Components;
@inherits Panel

<div class="online-hub" onclick=@OnPanelClicked>
	<div class="online-hub-overlay"></div>
	@if ( currentSection == "hub" && !IsArenaActive() )
	{
		<!-- Hub Landing -->
		<div class="hub-header">
			<div class="hub-header-left">
				<div class="hub-title">Online</div>
				<div class="hub-subtitle">Connect, compete, and trade with other tamers</div>
			</div>
			<div class="hub-status">
				<span class="status-dot @(IsConnected() ? "connected" : "")"></span>
				<span class="status-text">@GetConnectionStatus()</span>
			</div>
		</div>

		<div class="hub-grid">
			<div class="hub-row">
				<!-- Players Online -->
				<div class="hub-card players" onclick=@(() => Navigate("players"))>
					<div class="card-accent players-accent"></div>
					<div class="card-bg" style="background-image: url('ui/menus/bg_players.png')"></div>
					<div class="hub-card-header">
						<div class="card-title">PLAYERS</div>
						<div class="card-desc">See who's online and send trade requests</div>
					</div>
					<div class="card-hero">
						<span class="card-hero-value">@GetOnlineCount()</span>
						<span class="card-hero-label">@(IsConnected() ? "online" : "offline")</span>
					</div>
					<div class="card-footer">
						<span class="card-stat-badge players-badge">@(IsConnected() ? "Connected" : "Offline")</span>
					</div>
				</div>

				<!-- Arena -->
				<div class="hub-card ranked" onclick=@(() => Navigate("ranked"))>
					<div class="card-accent ranked-accent"></div>
					<div class="card-bg" style="background-image: url('ui/menus/arena_background.png')"></div>
					<div class="hub-card-header">
						<div class="card-title">ARENA</div>
						<div class="card-desc">Battle other tamers in ranked or quick play</div>
					</div>
					<div class="card-hero">
						<span class="card-hero-value" style="color: @GetRankColor()">@GetArenaRank()</span>
						<span class="card-hero-label">@GetArenaPoints() pts</span>
					</div>
					<div class="card-footer">
						<span class="card-stat-badge ranked-badge">@GetArenaWins() wins</span>
						<span class="card-stat-hint">Best of 3</span>
					</div>
				</div>
			</div>

			<div class="hub-row">
				<!-- Leaderboards -->
				<div class="hub-card leaderboards" style="width: 38%" onclick=@(() => Navigate("leaderboards"))>
					<div class="card-accent leaderboards-accent"></div>
					<div class="card-bg" style="background-image: url('ui/menus/bg_leaderboards.png')"></div>
					<div class="hub-card-header">
						<div class="card-title">LEADERBOARDS</div>
						<div class="card-desc">Compare stats against other tamers</div>
					</div>
					<div class="card-hero">
						<span class="card-hero-value">12</span>
						<span class="card-hero-label">categories</span>
					</div>
					<div class="card-footer">
						<span class="card-stat-badge leaderboards-badge">@GetArenaWins() wins</span>
						<span class="card-stat-hint">View rankings</span>
					</div>
				</div>

				<!-- Tamer Card -->
				<div class="hub-card tamer-card" style="width: 38%" onclick=@(() => Navigate("card"))>
					<div class="card-accent tamer-card-accent"></div>
					<div class="card-bg" style="background-image: url('ui/menus/bg_tamercard.png')"></div>
					<div class="hub-card-header">
						<div class="card-title">TAMER CARD</div>
						<div class="card-desc">View and share your profile card</div>
					</div>
					<div class="card-hero">
						<span class="card-hero-value">@GetCollectedCount()</span>
						<span class="card-hero-label">collected</span>
					</div>
					<div class="card-footer">
						<span class="card-stat-badge tamer-card-badge">Share in chat</span>
						<span class="card-stat-hint">@GetFavoriteName()</span>
					</div>
				</div>

				<!-- Voice Rooms -->
				<div class="hub-card voice" style="width: 22%" onclick=@(() => Navigate("voice"))>
					<div class="card-bg" style="background-image: url(ui/menus/bg_voice.png)"></div>
					<div class="card-accent voice-accent"></div>
					<div class="hub-card-header">
						<div class="card-title">VOICE</div>
						<div class="card-desc">Voice chat rooms</div>
					</div>
					<div class="card-hero">
						<span class="card-hero-value">@GetVoiceRoomCount()</span>
						<span class="card-hero-label">@(GetVoiceRoomCount() == 1 ? "room" : "rooms")</span>
					</div>
					<div class="card-footer">
						<span class="card-stat-badge voice-badge">@(IsInVoiceRoom() ? "Connected" : "Join")</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Quick Stats -->
		<div class="quick-stats">
			<div class="quick-stat">
				<span class="qs-value" style="color: @GetRankColor()">@GetArenaRank()</span>
				<div class="qs-label-row">
					<span class="qs-dot ranked-dot"></span>
					<span class="qs-label">Rank</span>
				</div>
			</div>
			<div class="quick-stat">
				<span class="qs-value">@GetArenaWins()</span>
				<div class="qs-label-row">
					<span class="qs-dot wins-dot"></span>
					<span class="qs-label">Wins</span>
				</div>
			</div>
			<div class="quick-stat">
				<span class="qs-value">@GetTradesCompleted()</span>
				<div class="qs-label-row">
					<span class="qs-dot trades-dot"></span>
					<span class="qs-label">Trades</span>
				</div>
			</div>
			<div class="quick-stat">
				<span class="qs-value">@GetCollectedCount()</span>
				<div class="qs-label-row">
					<span class="qs-dot cards-dot"></span>
					<span class="qs-label">Cards</span>
				</div>
			</div>
		</div>
	}
	else if ( currentSection == "players" && !IsArenaActive() )
	{
		<!-- Players Online Section -->
		<div class="oh-section-header">
			<div class="oh-header-left">
				<div class="oh-section-title">Players Online</div>
				<div class="oh-section-subtitle">See who's connected and send trade requests</div>
			</div>
			<div class="oh-header-right">
				<button class="back-btn" onclick=@BackToHub><img class="back-icon" src="ui/icons/buttons/back.svg" /><img class="back-icon-anim" src="ui/icons/animated/back.webp" /></button>
			</div>
		</div>

		<div class="players-content">
			<!-- Connection status -->
			<div class="connection-bar">
				<span class="server-dot @(IsConnected() ? "connected" : "")"></span>
				<span class="server-label">@(IsConnected() ? "Connected" : "Offline")</span>
				@if ( IsConnected() )
				{
					<span class="server-sep">Â·</span>
					<span class="server-count">@GetOnlineCount() player@(GetOnlineCount() != 1 ? "s" : "") online</span>
				}
			</div>

			<!-- Unified player grid -->
			@{
				var otherPlayers = IsConnected() ? GetOnlinePlayers().Where( p => !p.IsLocal ).ToList() : new();
			}
			<div class="player-grid">
				<!-- You (first tile) -->
				<div class="player-tile you-tile">
					@{
						var expBg = GetFavoriteExpeditionBg();
					}
					@if ( expBg != null )
					{
						<div class="tile-bg" style="background-image: url('@expBg')"></div>
					}
					<div class="tile-avatar @GetTamerGender()">
						<img src="@GetGenderAvatar()" />
					</div>
					<div class="tile-info">
						@if ( IsDev() )
						{
							<span class="dev-badge">DEV</span>
						}
						<span class="tile-name @(IsDev() ? "dev" : "")">@GetPlayerName()</span>
						<span class="tile-role" style="color: @GetLocalTitleColor()">@GetLocalTitle()</span>
					</div>
					<span class="tile-you-badge">YOU</span>
				</div>

				<!-- Other players -->
				@foreach ( var player in otherPlayers )
				{
					<div class="player-tile @(player.HasProfile ? "" : "no-profile")">
						@{
							var playerExpBg = GetPlayerExpeditionBg( player );
						}
						@if ( playerExpBg != null )
						{
							<div class="tile-bg" style="background-image: url('@playerExpBg')"></div>
						}
						@if ( player.HasProfile )
						{
							<div class="tile-avatar @player.GenderClass">
								<img src="@player.AvatarPath" />
							</div>
						}
						else
						{
							<div class="tile-indicator"></div>
						}
						<div class="tile-info">
							@if ( player.IsDev )
							{
								<span class="dev-badge">DEV</span>
							}
							<span class="tile-name @(player.IsDev ? "dev" : "")">@player.Name</span>
							<span class="tile-role" style="color: @player.TitleColor">@player.Title</span>
						</div>
						<button class="tile-trade" onclick=@(() => RequestTrade( player ))>
							Trade
						</button>
					</div>
				}
			</div>

			@if ( IsConnected() && otherPlayers.Count == 0 )
			{
				<div class="alone-notice">
					<span class="alone-text">You're the only one here</span>
					<span class="alone-hint">Other tamers will appear when they connect</span>
				</div>
			}
		</div>
	}
	else if ( currentSection == "ranked" || IsArenaActive() )
	{
		<!-- Ranked Battle - Embeds the full ArenaPanel -->
		<ArenaPanel @ref="arenaPanel" OnBack=@BackToHub />
	}
	else if ( currentSection == "leaderboards" )
	{
		<!-- Leaderboards Section -->
		<LeaderboardPanel OnBack=@BackToHub />
	}
	else if ( currentSection == "voice" )
	{
		<!-- Voice Rooms Section -->
		<div class="oh-section-header">
			<div class="oh-header-left">
				<div class="oh-section-title">Voice Rooms</div>
				<div class="oh-section-subtitle">Join a lobby or create a private voice room</div>
			</div>
			<div class="oh-header-right">
				<button class="back-btn" onclick=@BackToHub><img class="back-icon" src="ui/icons/buttons/back.svg" /><img class="back-icon-anim" src="ui/icons/animated/back.webp" /></button>
			</div>
		</div>

		<VoiceChatPanel Mode="browser" />
	}
	else if ( currentSection == "card" )
	{
		<!-- Tamer Card Section -->
		<div class="oh-section-header">
			<div class="oh-header-left">
				<div class="oh-section-title">Tamer Card</div>
				<div class="oh-section-subtitle">View and share your profile card</div>
			</div>
			<div class="oh-header-right">
				<button class="share-btn" onclick=@ShowcaseCard>Share in Chat</button>
				<button class="back-btn" onclick=@BackToHub><img class="back-icon" src="ui/icons/buttons/back.svg" /><img class="back-icon-anim" src="ui/icons/animated/back.webp" /></button>
			</div>
		</div>

		<div class="card-page">
			<!-- Left Column: Your Profile Card -->
			<div class="card-page-left">
				<!-- Hero Zone: Avatar + Name + Level -->
				<div class="cp-zone cp-hero-zone">
					@{
						var heroExpBg = GetFavoriteExpeditionBg();
					}
					@if ( heroExpBg != null )
					{
						<div class="cp-hero-bg" style="background-image: url(@heroExpBg)"></div>
					}
					<div class="cp-hero-content">
						<div class="cp-avatar @GetTamerGender()">
							<img src="@GetGenderAvatar()" />
						</div>
						<div class="cp-hero-info">
							@if ( IsDev() )
							{
								<span class="dev-badge">DEV</span>
							}
							<span class="cp-hero-name @(IsDev() ? "dev" : "")">@GetPlayerName()</span>
							<span class="cp-hero-title" style="color: @GetLocalTitleColor()">@GetLocalTitle()</span>
						</div>
						<div class="cp-hero-level">
							<span class="cp-level-num" style="color: @GetRankColor()">@GetPlayerLevel()</span>
							<span class="cp-level-label">LV</span>
						</div>
					</div>
				</div>

				<!-- Arena Zone: Rank + Points + Win Rate -->
				<div class="cp-zone cp-arena-zone" style="border-left: 3px solid @GetRankColor()">
					<div class="cp-arena-row">
						<div class="cp-arena-rank">
							<span class="cp-rank-icon" style="color: @GetRankColor()">@GetRankIcon()</span>
							<span class="cp-rank-name" style="color: @GetRankColor()">@GetArenaRank()</span>
						</div>
						<div class="cp-arena-points">
							<span class="cp-points-value">@GetArenaPoints().ToString("N0")</span>
							<span class="cp-points-label">pts</span>
						</div>
						<div class="cp-arena-winrate">
							<span class="cp-winrate-value">@GetArenaWinRatePercent()%</span>
							<span class="cp-winrate-label">Win Rate</span>
						</div>
					</div>
				</div>

				<!-- Stats Zone: Key Stats -->
				<div class="cp-zone cp-stats-zone">
					<div class="cp-stats-row">
						<div class="cp-stat">
							<span class="cp-stat-value">@GetArenaWins()</span>
							<span class="cp-stat-label">Wins</span>
						</div>
						<div class="cp-stat">
							<span class="cp-stat-value">@GetAchievementCount()</span>
							<span class="cp-stat-label">Achv</span>
						</div>
						<div class="cp-stat">
							<span class="cp-stat-value">@GetPlayTimeForCard()</span>
							<span class="cp-stat-label">Time</span>
						</div>
						<div class="cp-stat">
							<span class="cp-stat-value">@GetMonstersCaught()</span>
							<span class="cp-stat-label">Caught</span>
						</div>
					</div>
				</div>

				<!-- Favorites Zone -->
				<div class="cp-favorites-zone">
					<!-- Favorite Beast -->
					@{
						var favBeastSpecies = GetFavoriteSpeciesForDisplay();
						var beastElementClass = favBeastSpecies?.Element.ToString().ToLower() ?? "";
					}
					<div class="cp-fav-box cp-fav-beast @beastElementClass">
						<span class="card-field-label">FAVORITE BEAST</span>
						@if ( showFavSelector )
						{
							<div class="card-field-dropdown">
								<div class="card-field-opt" onclick=@(() => SetFavorite( null ))>
									<span class="card-field-opt-name">None</span>
								</div>
								@foreach ( var species in GetDiscoveredSpeciesList() )
								{
									<div class="card-field-opt" onclick=@(() => SetFavorite( species.Id ))>
										@if ( !string.IsNullOrEmpty( species.IconPath ) )
										{
											<img class="card-field-opt-icon" src="@species.IconPath" />
										}
										<span class="card-field-opt-name">@species.Name</span>
									</div>
								}
							</div>
						}
						else
						{
							<div class="card-field-display" onclick=@OpenFavSelector>
								@if ( favBeastSpecies != null && !string.IsNullOrEmpty( favBeastSpecies.IconPath ) )
								{
									<div class="cp-beast-portrait">
										<img class="cp-beast-portrait-img" src="@favBeastSpecies.IconPath" style="margin-left: @(favBeastSpecies.IconOffsetX - 18)px; margin-top: @(favBeastSpecies.IconOffsetY)px" />
									</div>
								}
								<span class="card-field-display-name">@GetFavoriteName()</span>
								<span class="card-field-change">Change</span>
							</div>
						}
					</div>

					<!-- Favorite Expedition -->
					@{
						var favExpBg = GetFavoriteExpeditionBg();
					}
					<div class="cp-fav-box cp-fav-expedition">
						@if ( favExpBg != null )
						{
							<div class="cp-fav-exp-bg" style="background-image: url(@favExpBg)"></div>
						}
						<span class="card-field-label">FAVORITE EXPEDITION</span>
						@if ( showExpSelector )
						{
							<div class="card-field-dropdown">
								<div class="card-field-opt" onclick=@(() => SetFavoriteExpedition( null ))>
									<span class="card-field-opt-name">None</span>
								</div>
								@foreach ( var exp in GetClearedExpeditions() )
								{
									<div class="card-field-opt cp-exp-opt" onclick=@(() => SetFavoriteExpedition( exp.Id ))>
										@if ( !string.IsNullOrEmpty( exp.BackgroundImage ) )
										{
											<div class="cp-exp-opt-bg" style="background-image: url(@exp.BackgroundImage)"></div>
										}
										<span class="card-field-opt-name">@exp.Name</span>
									</div>
								}
							</div>
						}
						else
						{
							<div class="card-field-display" onclick=@OpenExpSelector>
								<span class="card-field-display-name">@GetFavoriteExpeditionName()</span>
								<span class="card-field-change">Change</span>
							</div>
						}
					</div>
				</div>

				<!-- Share Button -->
				<div class="cp-share-btn" onclick=@ShowcaseCard>
					<span class="cp-share-icon">ðŸ’¬</span>
					<span class="cp-share-text">Share in Chat</span>
				</div>
			</div>

			<!-- Right Column: Collected Cards as Horizontal Tiles -->
			<div class="card-page-right">
				<div class="cp-collected-header">
					<span class="cp-zone-label">COLLECTED CARDS</span>
					<span class="cp-collected-count">@GetCollectedCount()</span>
				</div>

				@if ( GetCollectedCards().Count == 0 )
				{
					<div class="cp-collected-empty">
						<span class="cp-collected-empty-text">Trade or battle to collect other tamers' cards!</span>
						<span class="cp-collected-empty-hint">Collected cards will appear here</span>
					</div>
				}
				else
				{
					<div class="cp-collected-grid">
						@{
							var allCards = GetCollectedCards();
							var cardChunks = new List<List<CollectedTamerCard>>();
							for ( int i = 0; i < allCards.Count; i += 3 )
							{
								cardChunks.Add( allCards.Skip( i ).Take( 3 ).ToList() );
							}
						}
						@foreach ( var chunk in cardChunks )
						{
							<div class="cp-card-row">
								@foreach ( var card in chunk )
								{
									@{
										var cardExpBg = GetCardExpeditionBg( card );
										var cardGenderClass = (card.Gender?.ToLower() ?? "male") == "female" ? "female" : "male";
										var cardAvatarPath = cardGenderClass == "female"
											? "ui/characters/female/female_tamer.png"
											: "ui/characters/male/male_tamer.png";
										var cardRankColor = CompetitiveManager.GetRankColor( card.ArenaRank ?? "Unranked" );
										var cardFavSpecies = !string.IsNullOrEmpty( card.FavoriteMonsterSpeciesId )
											? MonsterManager.Instance?.GetSpecies( card.FavoriteMonsterSpeciesId )
											: null;
										var cardTitle = !string.IsNullOrEmpty( card.Title ) ? card.Title : "Tamer";
										var cardTitleColor = !string.IsNullOrEmpty( card.TitleColor ) ? card.TitleColor : "#a78bfa";
									}
									<div class="cp-card-tile" onclick=@(() => OpenCardDetail( card ))>
										<div class="cp-tile-bg" style="background-image: url(@(cardExpBg ?? ""))"></div>
										<div class="cp-tile-content">
											<div class="tile-avatar @cardGenderClass">
												<img src="@cardAvatarPath" />
											</div>
											<div class="cp-tile-info">
												<span class="cp-tile-name">@card.Name</span>
												<span class="cp-tile-title" style="color: @cardTitleColor">@cardTitle</span>
												<span class="cp-tile-level">Lv. @card.Level</span>
											</div>
										</div>
										@if ( cardFavSpecies != null && !string.IsNullOrEmpty( cardFavSpecies.IconPath ) )
										{
											<img class="cp-tile-beast-sprite" src="@cardFavSpecies.IconPath" />
										}
									</div>
								}
							</div>
						}
					</div>

					@if ( GetCollectedCards().Count > 6 )
					{
						<div class="card-view-all-btn" onclick=@ViewCardCollection>
							<span class="card-view-all-text">View All @GetCollectedCount() Cards</span>
						</div>
					}
				}
			</div>
		</div>

		<!-- Detail View Overlay -->
		@if ( selectedCardDetail != null )
		{
			@{
				var dc = selectedCardDetail;
				var dcGender = (dc.Gender?.ToLower() ?? "male") == "female" ? "female" : "male";
				var dcAvatar = dcGender == "female" ? "ui/characters/female/female_tamer.png" : "ui/characters/male/male_tamer.png";
				var dcRankColor = CompetitiveManager.GetRankColor( dc.ArenaRank ?? "Unranked" );
				var dcRankIcon = CompetitiveManager.GetRankIcon( dc.ArenaRank ?? "Unranked" );
				var dcExpBg = GetCardExpeditionBg( dc );
				var dcFavSpecies = !string.IsNullOrEmpty( dc.FavoriteMonsterSpeciesId )
					? MonsterManager.Instance?.GetSpecies( dc.FavoriteMonsterSpeciesId ) : null;
				var dcElementClass = dcFavSpecies?.Element.ToString().ToLower() ?? "";
				var dcExpName = !string.IsNullOrEmpty( dc.FavoriteExpeditionId )
					? (ExpeditionManager.Instance?.GetExpedition( dc.FavoriteExpeditionId )?.Name ?? dc.FavoriteExpeditionId) : null;
				var dcWinRate = (dc.ArenaWins + dc.ArenaLosses) > 0
					? (int)((float)dc.ArenaWins / (dc.ArenaWins + dc.ArenaLosses) * 100) : 0;
				var dcTitle = !string.IsNullOrEmpty( dc.Title ) ? dc.Title : "Tamer";
				var dcTitleColor = !string.IsNullOrEmpty( dc.TitleColor ) ? dc.TitleColor : "#a78bfa";
			}
			<div class="card-detail-overlay" onclick=@CloseCardDetail>
				<div class="cd-modal">
					<button class="cd-close" onclick=@CloseCardDetail>Ã—</button>

					<!-- Hero Banner -->
					<div class="cd-hero">
						@if ( dcExpBg != null )
						{
							<div class="cd-hero-bg" style="background-image: url(@dcExpBg)"></div>
						}
						<div class="cd-hero-content">
							<div class="cd-avatar @dcGender">
								<img src="@dcAvatar" />
							</div>
							<div class="cd-hero-level">
								<span class="cd-level-label">LEVEL</span>
								<span class="cd-level-num">@dc.Level</span>
							</div>
							<div class="cd-hero-info">
								<span class="cd-name">@dc.Name</span>
								<span class="cd-title" style="color: @dcTitleColor">@dcTitle</span>
								<span class="cd-rank-pill" style="border-color: @dcRankColor">@dcRankIcon @(dc.ArenaRank ?? "Unranked")</span>
							</div>
						</div>
					</div>

					<div class="cd-content">
						<!-- Arena Showcase -->
						<div class="cd-arena" style="border-left: 3px solid @dcRankColor">
							<div class="cd-arena-top">
								<div class="cd-arena-rank">
									<span class="cd-rank-icon" style="color: @dcRankColor">@dcRankIcon</span>
									<div class="cd-rank-details">
										<span class="cd-rank-name" style="color: @dcRankColor">@(dc.ArenaRank ?? "Unranked")</span>
										<span class="cd-rank-pts">@dc.ArenaPoints.ToString("N0") pts</span>
									</div>
								</div>
								<div class="cd-winrate" style="color: @dcRankColor">
									<span class="cd-winrate-val">@dcWinRate%</span>
									<span class="cd-winrate-label">Win Rate</span>
								</div>
							</div>
							<div class="cd-arena-pills">
								<div class="cd-arena-pill">
									<span class="cd-pill-val">@dc.ArenaWins.ToString("N0")</span>
									<span class="cd-pill-label">Wins</span>
								</div>
								<div class="cd-arena-pill">
									<span class="cd-pill-val">@dc.ArenaLosses.ToString("N0")</span>
									<span class="cd-pill-label">Losses</span>
								</div>
							</div>
						</div>

						<!-- Stats Grid -->
						<div class="cd-stats">
							<div class="cd-stats-row">
								<div class="cd-stat">
									<span class="cd-stat-val">@dc.MonstersCaught.ToString("N0")</span>
									<span class="cd-stat-label">CAUGHT</span>
								</div>
								<div class="cd-stat">
									<span class="cd-stat-val">@dc.MonstersBred.ToString("N0")</span>
									<span class="cd-stat-label">BRED</span>
								</div>
								<div class="cd-stat">
									<span class="cd-stat-val">@dc.MonstersEvolved.ToString("N0")</span>
									<span class="cd-stat-label">EVOLVED</span>
								</div>
							</div>
							<div class="cd-stats-row">
								<div class="cd-stat">
									<span class="cd-stat-val">@dc.BattlesWon.ToString("N0")</span>
									<span class="cd-stat-label">BATTLES WON</span>
								</div>
								<div class="cd-stat">
									<span class="cd-stat-val">@dc.AchievementCount.ToString("N0")</span>
									<span class="cd-stat-label">ACHIEVEMENTS</span>
								</div>
								<div class="cd-stat">
									<span class="cd-stat-val">@dc.HighestExpedition.ToString("N0")</span>
									<span class="cd-stat-label">HIGHEST STAGE</span>
								</div>
							</div>
						</div>

						<!-- Favorites -->
						<div class="cd-favorites">
							@if ( dcFavSpecies != null )
							{
								<div class="cd-fav-beast @dcElementClass">
									<span class="cd-fav-label">FAVORITE BEAST</span>
									<div class="cd-fav-row">
										<div class="cd-fav-portrait">
											<img class="cd-fav-portrait-img" src="@dcFavSpecies.IconPath" style="margin-left: @(dcFavSpecies.IconOffsetX - 18)px; margin-top: @(dcFavSpecies.IconOffsetY)px" />
										</div>
										<span class="cd-fav-name">@dcFavSpecies.Name</span>
									</div>
								</div>
							}
							@if ( dcExpName != null )
							{
								<div class="cd-fav-exp">
									@if ( dcExpBg != null )
									{
										<div class="cd-fav-exp-bg" style="background-image: url(@dcExpBg)"></div>
									}
									<span class="cd-fav-label">FAVORITE EXPEDITION</span>
									<span class="cd-fav-name">@dcExpName</span>
								</div>
							}
						</div>

						<!-- Footer -->
						<div class="cd-footer">
							<span class="cd-footer-text">Collected @FormatDetailDate( dc.CollectedAt )</span>
							@if ( dc.LastUpdated > dc.CollectedAt )
							{
								<span class="cd-footer-text">Updated @FormatDetailDate( dc.LastUpdated )</span>
							}
						</div>
					</div>
				</div>
			</div>
		}
	}
</div>

@code {
	private string currentSection = "hub";
	private ArenaPanel arenaPanel;
	private bool showFavSelector = false;
	private bool showExpSelector = false;
	private CollectedTamerCard selectedCardDetail = null;

	private void OnPanelClicked()
	{
		GameHUD.EnterPanel();
	}

	public void TickInput()
	{
		if ( currentSection == "ranked" || IsArenaActive() )
		{
			arenaPanel?.TickInput();
		}
	}

	private void Navigate( string section )
	{
		SoundManager.PlayForward();
		currentSection = section;
		showFavSelector = false;
		showExpSelector = false;
		selectedCardDetail = null;
	}

	private void BackToHub()
	{
		SoundManager.PlayBack();
		currentSection = "hub";
		showFavSelector = false;
		showExpSelector = false;
		selectedCardDetail = null;
	}

	private bool IsConnected() => GameNetworkSystem.IsActive;
	private int GetOnlineCount() => IsConnected() ? Connection.All.Count : 0;

	private string GetConnectionStatus()
	{
		if ( !IsConnected() ) return "Offline";
		return $"{Connection.All.Count} player{(Connection.All.Count != 1 ? "s" : "")} online";
	}

	private bool IsArenaActive()
	{
		var state = CompetitiveManager.Instance?.CurrentState ?? CompetitiveManager.ArenaState.Idle;
		return state != CompetitiveManager.ArenaState.Idle;
	}

	// Player info
	private string GetArenaRank() => TamerManager.Instance?.CurrentTamer?.ArenaRank ?? "Unranked";
	private int GetArenaPoints() => TamerManager.Instance?.CurrentTamer?.ArenaPoints ?? 0;
	private int GetArenaWins() => TamerManager.Instance?.CurrentTamer?.ArenaWins ?? 0;
	private int GetTradesCompleted() => TamerManager.Instance?.CurrentTamer?.TotalTradesCompleted ?? 0;
	private int GetCollectedCount() => TamerManager.Instance?.CurrentTamer?.CollectedCards?.Count ?? 0;

	private string GetRankColor() => CompetitiveManager.GetRankColor( GetArenaRank() );

	// Local player helpers
	private bool IsDev()
	{
		var devIds = new HashSet<long> { 76561198088759073 };
		var steamId = Connection.Local?.SteamId ?? 0;
		return devIds.Contains( steamId );
	}

	private string GetPlayerName() => TamerManager.Instance?.CurrentTamer?.Name ?? "Tamer";
	private int GetPlayerLevel() => TamerManager.Instance?.CurrentTamer?.Level ?? 1;

	private string GetLocalTitle()
	{
		var connId = ChatManager.Instance?.LocalConnectionId.ToString();
		if ( connId != null && ChatManager.Instance?.PlayerProfiles?.TryGetValue( connId, out var profile ) == true )
			return profile.Title;
		return "Tamer";
	}

	private string GetLocalTitleColor()
	{
		var connId = ChatManager.Instance?.LocalConnectionId.ToString();
		if ( connId != null && ChatManager.Instance?.PlayerProfiles?.TryGetValue( connId, out var profile ) == true )
			return profile.TitleColor;
		return "#a78bfa";
	}

	private string GetTamerGender() => (TamerManager.Instance?.CurrentTamer?.Gender ?? TamerGender.Male) == TamerGender.Female ? "female" : "male";

	private string GetGenderAvatar()
	{
		var gender = TamerManager.Instance?.CurrentTamer?.Gender ?? TamerGender.Male;
		return gender == TamerGender.Female
			? "ui/characters/female/female_tamer.png"
			: "ui/characters/male/male_tamer.png";
	}

	private string GetFavoriteExpeditionBg()
	{
		var expId = TamerManager.Instance?.CurrentTamer?.FavoriteExpeditionId;
		if ( string.IsNullOrEmpty( expId ) ) return null;
		var expedition = ExpeditionManager.Instance?.GetExpedition( expId );
		return expedition?.BackgroundImage;
	}

	private string GetFavoriteExpeditionName()
	{
		var expId = TamerManager.Instance?.CurrentTamer?.FavoriteExpeditionId;
		if ( string.IsNullOrEmpty( expId ) ) return "Select...";
		return ExpeditionManager.Instance?.GetExpedition( expId )?.Name ?? expId;
	}

	private List<Expedition> GetClearedExpeditions()
	{
		var highest = TamerManager.Instance?.CurrentTamer?.HighestExpeditionCleared ?? 0;
		return ExpeditionManager.Instance?.Expeditions?
			.Where( ( e, i ) => i < highest )
			.ToList() ?? new();
	}

	private void SetFavoriteExpedition( string expId )
	{
		SoundManager.PlaySelect();
		var tamer = TamerManager.Instance?.CurrentTamer;
		if ( tamer != null )
		{
			tamer.FavoriteExpeditionId = expId;
			TamerManager.Instance?.SaveToCloud();
			// Re-broadcast profile so other players see the updated background
			ChatManager.Instance?.SendPlayerProfile();
		}
		showExpSelector = false;
	}

	// Online players
	private List<OnlinePlayerInfo> GetOnlinePlayers()
	{
		if ( !IsConnected() ) return new();

		try
		{
			var devIds = new HashSet<long> { 76561198088759073 };
			var localId = Connection.Local?.Id ?? Guid.Empty;
			var profiles = ChatManager.Instance?.PlayerProfiles;

			return Connection.All
				.Where( c => c != null )
				.Select( c =>
				{
					var connId = c.Id.ToString();
					PlayerProfileData profile = null;
					profiles?.TryGetValue( connId, out profile );

					return new OnlinePlayerInfo
					{
						ConnectionId = connId,
						SteamId = c.SteamId,
						Name = c.DisplayName ?? "Player",
						IsLocal = c.Id == localId,
						IsDev = devIds.Contains( c.SteamId ),
						HasProfile = profile != null,
						GenderClass = profile != null
							? (profile.Gender == "Female" ? "female" : "male")
							: "male",
						AvatarPath = profile != null
							? (profile.Gender == "Female"
								? "ui/characters/female/female_tamer.png"
								: "ui/characters/male/male_tamer.png")
							: "ui/characters/male/male_tamer.png",
						FavoriteExpeditionId = profile?.FavoriteExpeditionId,
						Title = profile?.Title ?? "Tamer",
						TitleColor = profile?.TitleColor ?? "#a78bfa"
					};
				} )
				.OrderBy( p => p.IsLocal ? 1 : 0 )
				.ThenBy( p => p.Name )
				.ToList();
		}
		catch ( Exception e )
		{
			Log.Warning( $"GetOnlinePlayers error: {e.Message}" );
			return new();
		}
	}

	private string GetPlayerExpeditionBg( OnlinePlayerInfo player )
	{
		if ( string.IsNullOrEmpty( player.FavoriteExpeditionId ) ) return null;
		var expedition = ExpeditionManager.Instance?.GetExpedition( player.FavoriteExpeditionId );
		return expedition?.BackgroundImage;
	}

	// Trading
	private void RequestTrade( OnlinePlayerInfo player )
	{
		SoundManager.PlayClick();
		if ( player == null ) return;

		if ( TradingManager.Instance == null )
		{
			NotificationManager.Instance?.AddNotification(
				NotificationType.Info,
				"Trading Unavailable",
				"Trading system is not ready yet. Try again in a moment.",
				3f
			);
			return;
		}

		var success = TradingManager.Instance.SendTradeRequest( player.ConnectionId, player.Name );
		if ( success )
		{
			NotificationManager.Instance?.AddNotification(
				NotificationType.Info,
				"Trade Request Sent",
				$"Waiting for {player.Name} to respond...",
				5f
			);
		}
		else if ( TradingManager.Instance.IsOnCooldown )
		{
			NotificationManager.Instance?.AddNotification(
				NotificationType.Info,
				"Trade Cooldown",
				$"Please wait {TradingManager.Instance.CooldownRemaining:F0}s before trading again.",
				3f
			);
		}
		else if ( TradingManager.Instance.IsInTrade )
		{
			NotificationManager.Instance?.AddNotification(
				NotificationType.Info,
				"Already Trading",
				"You're already in an active trade.",
				3f
			);
		}
	}

	// Card section
	private string GetFavoriteName()
	{
		var speciesId = TamerManager.Instance?.CurrentTamer?.FavoriteMonsterSpeciesId;
		if ( string.IsNullOrEmpty( speciesId ) ) return "Select...";
		var species = MonsterManager.Instance?.GetSpecies( speciesId );
		return species?.Name ?? speciesId;
	}

	private List<MonsterSpecies> GetDiscoveredSpeciesList()
	{
		var discovered = BeastiaryManager.Instance?.DiscoveredSpecies;
		if ( discovered == null || discovered.Count == 0 ) return new();
		return discovered
			.Select( id => MonsterManager.Instance?.GetSpecies( id ) )
			.Where( s => s != null )
			.OrderBy( s => s.Name )
			.ToList();
	}

	private MonsterSpecies GetFavoriteSpeciesForDisplay()
	{
		var speciesId = TamerManager.Instance?.CurrentTamer?.FavoriteMonsterSpeciesId;
		if ( string.IsNullOrEmpty( speciesId ) ) return null;
		return MonsterManager.Instance?.GetSpecies( speciesId );
	}

	private void SetFavorite( string speciesId )
	{
		SoundManager.PlaySelect();
		var tamer = TamerManager.Instance?.CurrentTamer;
		if ( tamer != null )
		{
			tamer.FavoriteMonsterSpeciesId = speciesId;
			TamerManager.Instance?.SaveToCloud();
		}
		showFavSelector = false;
	}

	private void ShowcaseCard()
	{
		SoundManager.PlayClick();
		ChatManager.Instance?.SendTamerCardShowcase();
	}

	private List<CollectedTamerCard> GetCollectedCards()
	{
		return TamerManager.Instance?.CurrentTamer?.CollectedCards?
			.OrderByDescending( c => c.LastUpdated )
			.ToList() ?? new();
	}

	private void ViewCardCollection()
	{
		SoundManager.PlayForward();
		CardCollectionPanel.Show();
	}

	private void OpenFavSelector()
	{
		SoundManager.PlayClick();
		showFavSelector = true;
	}

	private void OpenExpSelector()
	{
		SoundManager.PlayClick();
		showExpSelector = true;
	}

	private void OpenCardDetail( CollectedTamerCard card )
	{
		SoundManager.PlayPopup();
		selectedCardDetail = card;
	}

	private void CloseCardDetail()
	{
		SoundManager.PlayBack();
		selectedCardDetail = null;
	}

	private int GetArenaWinRatePercent()
	{
		var tamer = TamerManager.Instance?.CurrentTamer;
		if ( tamer == null ) return 0;
		var total = tamer.ArenaWins + tamer.ArenaLosses;
		return total > 0 ? (int)((float)tamer.ArenaWins / total * 100) : 0;
	}

	private int GetAchievementCount()
	{
		var tamer = TamerManager.Instance?.CurrentTamer;
		return tamer?.Achievements?.Values.Count( p => p.IsUnlocked ) ?? 0;
	}

	private string GetPlayTimeForCard()
	{
		var time = TamerManager.Instance?.CurrentTamer?.TotalPlayTime ?? TimeSpan.Zero;
		var minutes = (int)time.TotalMinutes;
		if ( minutes <= 0 ) return "-";
		if ( minutes < 60 ) return $"{minutes}m";
		int hours = minutes / 60;
		if ( hours < 24 ) return $"{hours}h";
		return $"{hours / 24}d";
	}

	private int GetMonstersCaught()
	{
		return TamerManager.Instance?.CurrentTamer?.TotalMonstersCaught ?? 0;
	}

	private string GetCardExpeditionBg( CollectedTamerCard card )
	{
		if ( string.IsNullOrEmpty( card?.FavoriteExpeditionId ) ) return null;
		return ExpeditionManager.Instance?.GetExpedition( card.FavoriteExpeditionId )?.BackgroundImage;
	}

	private string GetRankIcon()
	{
		return CompetitiveManager.GetRankIcon( GetArenaRank() );
	}

	private string FormatDetailDate( DateTime date )
	{
		return date.ToLocalTime().ToString( "MMM d, yyyy" );
	}

	// Voice helpers
	private int GetVoiceRoomCount()
	{
		var rooms = VoiceChatManager.Instance?.Rooms;
		if ( rooms == null ) return 0;
		return rooms.Count( r => !r.IsLobby );
	}

	private bool IsInVoiceRoom()
	{
		return VoiceChatManager.Instance?.IsInRoom ?? false;
	}

	private class OnlinePlayerInfo
	{
		public string ConnectionId { get; set; }
		public long SteamId { get; set; }
		public string Name { get; set; }
		public bool IsLocal { get; set; }
		public bool IsDev { get; set; }
		public bool HasProfile { get; set; }
		public string GenderClass { get; set; } = "male";
		public string AvatarPath { get; set; } = "ui/characters/male/male_tamer.png";
		public string FavoriteExpeditionId { get; set; }
		public string Title { get; set; } = "Tamer";
		public string TitleColor { get; set; } = "#a78bfa";
	}
}
