@namespace Beastborne.UI.Panels
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@using Beastborne.UI.Components;
@inherits Panel

<div class="breeding-panel">
	<div class="breeding-header">
		<div class="breeding-title">Fusion Chamber</div>
		<div class="breeding-subtitle">Select two monsters of the same species to fuse</div>
	</div>

	<div class="breeding-content">
		<!-- Fusion Material Selection -->
		<div class="parents-section">
			<div class="parent-slot @(Parent1 != null ? "filled" : "")"
				 onclick=@(() => OpenMonsterSelect(1))>
				@if (Parent1 != null)
				{
					<MonsterCard Monster=@Parent1 IsCompact=@true AnimationFrame=@SpriteAnimator.GlobalFrame />
					<button class="remove-btn" onclick=@(() => ClearParent(1))>x</button>
				}
				else
				{
					<div class="empty-slot">
						<div class="empty-icon">+</div>
						<div class="empty-text">Select Source 1</div>
					</div>
				}
			</div>

			<div class="breed-connector">
				<div class="fusion-icon">‚ö°</div>
			</div>

			<div class="parent-slot @(Parent2 != null ? "filled" : "")"
				 onclick=@(() => OpenMonsterSelect(2))>
				@if (Parent2 != null)
				{
					<MonsterCard Monster=@Parent2 IsCompact=@true AnimationFrame=@SpriteAnimator.GlobalFrame />
					<button class="remove-btn" onclick=@(() => ClearParent(2))>x</button>
				}
				else
				{
					<div class="empty-slot">
						<div class="empty-icon">+</div>
						<div class="empty-text">Select Source 2</div>
					</div>
				}
			</div>
		</div>

		<!-- Compatibility Status -->
		@if (Parent1 != null && Parent2 != null)
		{
			var compatibility = GeneticsCalculator.CheckCompatibility(Parent1, Parent2);
			@if (!compatibility.CanBreed)
			{
				<div class="compatibility-warning">
					<span class="warning-icon">‚ö†</span>
					<span class="warning-text">@compatibility.Reason</span>
				</div>
			}
			else
			{
				@{
					var preview = GeneticsCalculator.PreviewOffspring(Parent1, Parent2, lockedGenes.Count > 0 ? lockedGenes : null);
					var p1Genes = Parent1.Genetics;
					var p2Genes = Parent2.Genetics;
					var p1Total = p1Genes.HPGene + p1Genes.ATKGene + p1Genes.DEFGene + p1Genes.SPDGene;
					var p2Total = p2Genes.HPGene + p2Genes.ATKGene + p2Genes.DEFGene + p2Genes.SPDGene;
					var parentAvgTotal = (p1Total + p2Total) / 2;
					var offspringAvgTotal = preview.AvgHP + preview.AvgATK + preview.AvgDEF + preview.AvgSPD;
					var maxLocks = preview.GeneLockSlots;
					var hasLockSkill = maxLocks > 0;
				}

				<!-- Genetics Comparison -->
				<div class="genes-comparison">
					<div class="comparison-title">Genetics Comparison</div>
					<div class="comparison-header">
						<span class="gene-lock-header"></span>
						<span class="gene-label"></span>
						<span class="parent-label">S1</span>
						<span class="parent-label">S2</span>
						<span class="parent-label offspring">Result</span>
					</div>

					<div class="comparison-row @(lockedGenes.Contains("HP") ? "gene-locked" : "")">
						<div class="gene-lock-btn @(hasLockSkill ? "" : "no-skill") @(lockedGenes.Contains("HP") ? "locked" : "") @(hasLockSkill && lockedGenes.Count >= maxLocks && !lockedGenes.Contains("HP") ? "disabled" : "")"
								onclick=@(() => ToggleGeneLock("HP"))>
							@(lockedGenes.Contains("HP") ? "üîí" : "üîì")
						</div>
						<span class="gene-label hp">HP</span>
						<span class="gene-value @(p1Genes.HPGene >= p2Genes.HPGene ? "better" : "")">@p1Genes.HPGene</span>
						<span class="gene-value @(p2Genes.HPGene >= p1Genes.HPGene ? "better" : "")">@p2Genes.HPGene</span>
						<span class="gene-value predicted">@preview.AvgHP</span>
					</div>
					<div class="comparison-row @(lockedGenes.Contains("ATK") ? "gene-locked" : "")">
						<div class="gene-lock-btn @(hasLockSkill ? "" : "no-skill") @(lockedGenes.Contains("ATK") ? "locked" : "") @(hasLockSkill && lockedGenes.Count >= maxLocks && !lockedGenes.Contains("ATK") ? "disabled" : "")"
								onclick=@(() => ToggleGeneLock("ATK"))>
							@(lockedGenes.Contains("ATK") ? "üîí" : "üîì")
						</div>
						<span class="gene-label atk">ATK</span>
						<span class="gene-value @(p1Genes.ATKGene >= p2Genes.ATKGene ? "better" : "")">@p1Genes.ATKGene</span>
						<span class="gene-value @(p2Genes.ATKGene >= p1Genes.ATKGene ? "better" : "")">@p2Genes.ATKGene</span>
						<span class="gene-value predicted">@preview.AvgATK</span>
					</div>
					<div class="comparison-row @(lockedGenes.Contains("DEF") ? "gene-locked" : "")">
						<div class="gene-lock-btn @(hasLockSkill ? "" : "no-skill") @(lockedGenes.Contains("DEF") ? "locked" : "") @(hasLockSkill && lockedGenes.Count >= maxLocks && !lockedGenes.Contains("DEF") ? "disabled" : "")"
								onclick=@(() => ToggleGeneLock("DEF"))>
							@(lockedGenes.Contains("DEF") ? "üîí" : "üîì")
						</div>
						<span class="gene-label def">DEF</span>
						<span class="gene-value @(p1Genes.DEFGene >= p2Genes.DEFGene ? "better" : "")">@p1Genes.DEFGene</span>
						<span class="gene-value @(p2Genes.DEFGene >= p1Genes.DEFGene ? "better" : "")">@p2Genes.DEFGene</span>
						<span class="gene-value predicted">@preview.AvgDEF</span>
					</div>
					<div class="comparison-row @(lockedGenes.Contains("SPD") ? "gene-locked" : "")">
						<div class="gene-lock-btn @(hasLockSkill ? "" : "no-skill") @(lockedGenes.Contains("SPD") ? "locked" : "") @(hasLockSkill && lockedGenes.Count >= maxLocks && !lockedGenes.Contains("SPD") ? "disabled" : "")"
								onclick=@(() => ToggleGeneLock("SPD"))>
							@(lockedGenes.Contains("SPD") ? "üîí" : "üîì")
						</div>
						<span class="gene-label spd">SPD</span>
						<span class="gene-value @(p1Genes.SPDGene >= p2Genes.SPDGene ? "better" : "")">@p1Genes.SPDGene</span>
						<span class="gene-value @(p2Genes.SPDGene >= p1Genes.SPDGene ? "better" : "")">@p2Genes.SPDGene</span>
						<span class="gene-value predicted">@preview.AvgSPD</span>
					</div>

					<div class="comparison-row total-row">
						<span class="gene-lock-header"></span>
						<span class="gene-label">TOTAL</span>
						<span class="gene-value total">@p1Total<span class="max-indicator">/200</span></span>
						<span class="gene-value total">@p2Total<span class="max-indicator">/200</span></span>
						<span class="gene-value total predicted">@offspringAvgTotal<span class="max-indicator">/200</span></span>
					</div>

					<div class="comparison-row quality-row">
						<span class="gene-lock-header"></span>
						<span class="gene-label">Quality</span>
						<span class="gene-value quality @p1Genes.QualityRating.ToLower()">@p1Genes.QualityRating</span>
						<span class="gene-value quality @p2Genes.QualityRating.ToLower()">@p2Genes.QualityRating</span>
						<span class="gene-value quality @preview.PredictedQuality.ToLower()">@preview.PredictedQuality</span>
					</div>

					<div class="gene-lock-info">
						@if (hasLockSkill)
						{
							<span class="lock-icon">üîí</span>
							<span class="lock-text">Gene Locks: @lockedGenes.Count / @maxLocks</span>
						}
						else
						{
							<span class="lock-text inactive">Gene Lock: Requires Fusion skill</span>
						}
					</div>
				</div>

				<!-- Preview Section -->
				<div class="preview-section">
					<div class="preview-title">Offspring Gene Ranges</div>
					<div class="preview-subtitle">Possible outcomes (min - max, line shows average)</div>

					<div class="preview-stats">
						<div class="preview-stat">
							<span class="stat-name hp">HP</span>
							<div class="stat-range">
								<span class="range-min">@preview.MinHP</span>
								<div class="range-bar">
									<div class="range-fill hp" style="left: @(preview.MinHP / 50f * 100)%; right: @((50 - preview.MaxHP) / 50f * 100)%"></div>
									<div class="range-avg" style="left: @(preview.AvgHP / 50f * 100)%"></div>
								</div>
								<span class="range-max">@preview.MaxHP</span>
							</div>
						</div>

						<div class="preview-stat">
							<span class="stat-name atk">ATK</span>
							<div class="stat-range">
								<span class="range-min">@preview.MinATK</span>
								<div class="range-bar">
									<div class="range-fill atk" style="left: @(preview.MinATK / 50f * 100)%; right: @((50 - preview.MaxATK) / 50f * 100)%"></div>
									<div class="range-avg" style="left: @(preview.AvgATK / 50f * 100)%"></div>
								</div>
								<span class="range-max">@preview.MaxATK</span>
							</div>
						</div>

						<div class="preview-stat">
							<span class="stat-name def">DEF</span>
							<div class="stat-range">
								<span class="range-min">@preview.MinDEF</span>
								<div class="range-bar">
									<div class="range-fill def" style="left: @(preview.MinDEF / 50f * 100)%; right: @((50 - preview.MaxDEF) / 50f * 100)%"></div>
									<div class="range-avg" style="left: @(preview.AvgDEF / 50f * 100)%"></div>
								</div>
								<span class="range-max">@preview.MaxDEF</span>
							</div>
						</div>

						<div class="preview-stat">
							<span class="stat-name spd">SPD</span>
							<div class="stat-range">
								<span class="range-min">@preview.MinSPD</span>
								<div class="range-bar">
									<div class="range-fill spd" style="left: @(preview.MinSPD / 50f * 100)%; right: @((50 - preview.MaxSPD) / 50f * 100)%"></div>
									<div class="range-avg" style="left: @(preview.AvgSPD / 50f * 100)%"></div>
								</div>
								<span class="range-max">@preview.MaxSPD</span>
							</div>
						</div>
					</div>

					<div class="preview-info">
						<div class="info-row">
							<span class="info-label">Twin Chance</span>
							<span class="info-value">@((preview.TwinChance * 100).ToString("F1"))%</span>
						</div>
						<div class="info-row">
							<span class="info-label">Mutation Chance</span>
							<span class="info-value">5% (+3 to +8 if lucky!)</span>
						</div>
					</div>
				</div>

				<!-- Breed Button -->
				<div class="breed-action">
					@{
						var cost = GeneticsCalculator.CalculateBreedingCost(Parent1, Parent2);
						var canAfford = TamerManager.Instance?.CurrentTamer?.Gold >= cost;
					}
					<div class="breed-cost @(canAfford == true ? "" : "insufficient")">
						<img class="currency-icon" src="ui/icons/currency/money.svg" />
						<span class="cost-value">@cost Gold</span>
					</div>
					<button class="breed-btn @(canAfford == true ? "" : "disabled")" onclick=@OnBreedClicked>
						<span class="breed-icon">ü•ö</span>
						<span class="breed-text">BREED</span>
					</button>
					<div class="breed-warning">Both parents will be consumed!</div>
				</div>
			}
		}
		else
		{
			<!-- Tips shown when no parents selected -->
			<div class="tips-section">
				<div class="tips-title">How to Get Better Genes</div>
				<div class="tips-list">
					<div class="tip-item">
						<span class="tip-icon">üß¨</span>
						<span class="tip-text">Each gene ranges from 0-30. Total genes = sum of all 6 stats (max 180)</span>
					</div>
					<div class="tip-item">
						<span class="tip-icon">üìà</span>
						<span class="tip-text">70% chance to inherit the better parent's gene - pair strong monsters!</span>
					</div>
					<div class="tip-item">
						<span class="tip-icon">üé∞</span>
						<span class="tip-text">15% mutation chance - 90% are positive boosts (+2 to +5)</span>
					</div>
					<div class="tip-item">
						<span class="tip-icon">üîÑ</span>
						<span class="tip-text">Keep breeding the best offspring to gradually improve genetics over generations</span>
					</div>
					<div class="tip-item">
						<span class="tip-icon">üíù</span>
						<span class="tip-text">Bred monsters are always loyal - no contract demands!</span>
					</div>
					<div class="tip-item">
						<span class="tip-icon">üìñ</span>
						<span class="tip-text">Tamer skills bias selection toward the better parent's genes!</span>
					</div>
				</div>
			</div>
		}
	</div>

	<!-- Monster Selection Modal -->
	@if (showMonsterSelect)
	{
		<div class="select-overlay" onclick=@CloseMonsterSelect>
			<div class="select-panel" onclick:stopPropagation>
				<div class="select-header">
					<div class="select-title">Select Monster</div>
					<button class="close-btn" onclick=@CloseMonsterSelect><img class="close-icon" src="ui/icons/buttons/close.svg" /></button>
				</div>
				<div class="select-filters">
					<FilterBar @ref="breedingFilterBar"
							   CurrentElement=@breedingFilter
							   CurrentSort=@breedingSort
							   ShowBeastiarySort=@true
							   OnElementChanged=@OnBreedingElementChanged
							   OnSortChanged=@OnBreedingSortChanged
							   OnNameFilterChanged=@OnBreedingNameFilterChanged
							   AvailableNames=@GetBreedingMonsterNames() />
				</div>
				<div class="select-grid">
					@foreach (var monster in GetAvailableMonsters())
					{
						<div class="select-monster-wrapper">
							<MonsterCard Monster=@monster
										 IsCompact=@true
										 IsSelected=@(selectedForSlot == 1 ? Parent1?.Id == monster.Id : Parent2?.Id == monster.Id)
										 AnimationFrame=@SpriteAnimator.GlobalFrame
										 ClickAction=@(() => SelectMonster(monster)) />
							<div class="monster-genes-badge">
								<span class="genes-total">@GetTotalGenes(monster)/200</span>
							</div>
						</div>
					}
				</div>
			</div>
		</div>
	}

	<!-- Breeding Result Modal -->
	@if (showResult && breedingResult != null)
	{
		<div class="result-overlay">
			<div class="result-panel">
				<div class="result-title">Breeding Successful!</div>
				<div class="result-content">
					<MonsterCard Monster=@breedingResult IsCompact=@false AnimationFrame=@SpriteAnimator.GlobalFrame />
					<div class="result-info">
						<div class="info-row">
							<span class="info-label">Genetics Quality</span>
							<span class="info-value quality @breedingResult.Genetics.QualityRating.ToLower()">@breedingResult.Genetics.QualityRating</span>
						</div>
						<div class="info-row">
							<span class="info-label">Total Genes</span>
							<span class="info-value">@GetTotalGenes(breedingResult) / 200</span>
						</div>
						<div class="info-row">
							<span class="info-label">Nature</span>
							<span class="info-value">@breedingResult.Genetics.Nature</span>
						</div>
					</div>
					<div class="result-genes">
						<div class="result-gene hp">
							<span class="gene-name">HP</span>
							<span class="gene-val">@breedingResult.Genetics.HPGene</span>
						</div>
						<div class="result-gene atk">
							<span class="gene-name">ATK</span>
							<span class="gene-val">@breedingResult.Genetics.ATKGene</span>
						</div>
						<div class="result-gene def">
							<span class="gene-name">DEF</span>
							<span class="gene-val">@breedingResult.Genetics.DEFGene</span>
						</div>
						<div class="result-gene spd">
							<span class="gene-name">SPD</span>
							<span class="gene-val">@breedingResult.Genetics.SPDGene</span>
						</div>
					</div>
				</div>
				<button class="result-btn" onclick=@CloseResult>CONTINUE</button>
			</div>
		</div>
	}
</div>

@code {
	public Monster Parent1 { get; set; }
	public Monster Parent2 { get; set; }

	private bool showMonsterSelect = false;
	private int selectedForSlot = 0;
	private bool showResult = false;
	private Monster breedingResult = null;

	// Gene Lock state
	private HashSet<string> lockedGenes = new();
	private int GetMaxGeneLocks() => (int)(TamerManager.Instance?.GetSkillBonus( SkillEffectType.GeneLock ) ?? 0);
	private bool HasGeneLockSkill() => GetMaxGeneLocks() > 0;

	// Filter/sort state
	private string breedingFilter = "all";
	private string breedingSort = "genes";
	private string breedingNameFilter = "";
	private FilterBar breedingFilterBar;

	private int GetTotalGenes(Monster m)
	{
		if (m?.Genetics == null) return 0;
		return m.Genetics.HPGene + m.Genetics.ATKGene + m.Genetics.DEFGene + m.Genetics.SPDGene;
	}

	private void OpenMonsterSelect(int slot)
	{
		SoundManager.PlayForward();
		selectedForSlot = slot;
		showMonsterSelect = true;
	}

	private void CloseMonsterSelect()
	{
		SoundManager.PlayBack();
		showMonsterSelect = false;
	}

	private void ClearParent(int slot)
	{
		SoundManager.PlayBack();
		if (slot == 1) Parent1 = null;
		else Parent2 = null;
		lockedGenes.Clear();
	}

	private void ToggleGeneLock(string geneName)
	{
		int maxLocks = GetMaxGeneLocks();
		if (maxLocks <= 0)
		{
			SoundManager.PlayDeny();
			return;
		}

		if (lockedGenes.Contains(geneName))
		{
			lockedGenes.Remove(geneName);
			SoundManager.PlayBack();
		}
		else if (lockedGenes.Count < maxLocks)
		{
			lockedGenes.Add(geneName);
			SoundManager.PlayForward();
		}
		else
		{
			SoundManager.PlayDeny();
		}
	}

	private List<Monster> GetAvailableMonsters()
	{
		var monsters = MonsterManager.Instance?.OwnedMonsters ?? new List<Monster>();

		// Filter out the other selected parent if applicable
		if (selectedForSlot == 1 && Parent2 != null)
		{
			monsters = monsters.Where(m => m.Id != Parent2.Id).ToList();
		}
		else if (selectedForSlot == 2 && Parent1 != null)
		{
			// Also filter to only show same species if parent 1 is selected
			monsters = monsters.Where(m => m.Id != Parent1.Id && m.SpeciesId == Parent1.SpeciesId).ToList();
		}

		// Element filter
		if (breedingFilter != "all")
		{
			var elementType = breedingFilter switch
			{
				"fire" => ElementType.Fire,
				"water" => ElementType.Water,
				"earth" => ElementType.Earth,
				"wind" => ElementType.Wind,
				"electric" => ElementType.Electric,
				"ice" => ElementType.Ice,
				"nature" => ElementType.Nature,
				"metal" => ElementType.Metal,
				"shadow" => ElementType.Shadow,
				"spirit" => ElementType.Spirit,
				"neutral" => ElementType.Neutral,
				_ => ElementType.Neutral
			};

			monsters = monsters.Where(m =>
			{
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return species?.Element == elementType;
			}).ToList();
		}

		// Name filter
		if (breedingSort == "name" && !string.IsNullOrEmpty(breedingNameFilter))
		{
			monsters = monsters.Where(m =>
			{
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return species?.Name?.Equals(breedingNameFilter, StringComparison.OrdinalIgnoreCase) == true ||
					   m.Nickname?.Equals(breedingNameFilter, StringComparison.OrdinalIgnoreCase) == true;
			}).ToList();
		}

		// Sorting
		monsters = breedingSort switch
		{
			"fav" => monsters.OrderByDescending(m => m.IsFavorite)
							.ThenByDescending(m => GetTotalGenes(m)).ToList(),
			"genes" => monsters.OrderByDescending(m => GetTotalGenes(m)).ToList(),
			"power" => monsters.OrderByDescending(m => m.PowerRating).ToList(),
			"level" => monsters.OrderByDescending(m => m.Level).ToList(),
			"rarity" => monsters.OrderByDescending(m => {
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return (int)(species?.BaseRarity ?? Rarity.Common);
			}).ThenByDescending(m => GetTotalGenes(m)).ToList(),
			"recent" => monsters.OrderByDescending(m => m.CaughtAt).ToList(),
			"beastiary" => monsters.OrderBy(m => {
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return species?.BeastiaryNumber ?? 9999;
			}).ToList(),
			"name" => monsters.OrderBy(m => m.Nickname ?? MonsterManager.Instance?.GetSpecies(m.SpeciesId)?.Name ?? "").ToList(),
			_ => monsters.OrderByDescending(m => GetTotalGenes(m)).ToList()
		};

		return monsters;
	}

	// FilterBar callback handlers
	private void OnBreedingElementChanged(string element)
	{
		breedingFilter = element;
	}

	private void OnBreedingSortChanged(string sort)
	{
		breedingSort = sort;
	}

	private void OnBreedingNameFilterChanged(string name)
	{
		breedingNameFilter = name;
	}

	private List<string> GetBreedingMonsterNames()
	{
		var monsters = MonsterManager.Instance?.OwnedMonsters ?? new List<Monster>();
		var names = new HashSet<string>();

		foreach (var monster in monsters)
		{
			if (!string.IsNullOrEmpty(monster.Nickname))
				names.Add(monster.Nickname);

			var species = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
			if (species != null && !string.IsNullOrEmpty(species.Name))
				names.Add(species.Name);
		}

		return names.OrderBy(n => n).ToList();
	}

	private void SelectMonster(Monster monster)
	{
		SoundManager.PlaySelect();
		lockedGenes.Clear();
		if (selectedForSlot == 1)
		{
			Parent1 = monster;
			// If parent 2 is incompatible, clear it
			if (Parent2 != null && Parent2.SpeciesId != monster.SpeciesId)
			{
				Parent2 = null;
			}
		}
		else
		{
			Parent2 = monster;
		}

		showMonsterSelect = false;
	}

	private void OnBreedClicked()
	{
		if (Parent1 == null || Parent2 == null)
		{
			SoundManager.PlayDeny();
			return;
		}

		var compatibility = GeneticsCalculator.CheckCompatibility(Parent1, Parent2);
		if (!compatibility.CanBreed)
		{
			SoundManager.PlayDeny();
			return;
		}

		var cost = GeneticsCalculator.CalculateBreedingCost(Parent1, Parent2);
		if (!TamerManager.Instance.SpendGold(cost))
		{
			SoundManager.PlayDeny();
			return;
		}

		// Create the offspring (pass locked genes for guaranteed inheritance)
		breedingResult = MonsterManager.Instance?.BreedMonsters(Parent1, Parent2, lockedGenes.Count > 0 ? lockedGenes : null);

		if (breedingResult != null)
		{
			SoundManager.PlayMonsterCatch(); // Celebration sound for new monster
			showResult = true;
			// Clear parents after breeding
			Parent1 = null;
			Parent2 = null;
		}
	}

	private void CloseResult()
	{
		SoundManager.PlayClick();
		showResult = false;
		breedingResult = null;
	}
}
