@namespace Beastborne.UI.Panels
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@inherits Panel

@if (Monster != null)
{
	<div class="detail-panel">
		<div class="detail-header">
			<div class="back-btn" onclick=@OnBackClicked><img class="back-icon" src="ui/icons/buttons/back.svg" /><img class="back-icon-anim" src="ui/icons/animated/back.webp" /></div>
			<div class="header-actions">
				<div class="pill-btn" onclick=@ShowOffBeast>
					<span class="pill-icon">üì£</span>
					<span class="pill-text">Show Off</span>
				</div>
				<div class="pill-btn @(Monster.IsFavorite ? "active" : "")" onclick=@ToggleFavorite>
					<span class="pill-icon">@(Monster.IsFavorite ? "‚òÖ" : "‚òÜ")</span>
					<span class="pill-text">Favorite</span>
				</div>
				@if (Monster.Journal != null && Monster.Journal.Count > 0)
				{
					<div class="pill-btn" onclick=@OpenJournal>
						<span class="pill-icon">üìñ</span>
						<span class="pill-text">Journal</span>
					</div>
				}
			</div>
		</div>

		<div class="detail-content">
			<!-- Monster Portrait -->
			<div class="portrait-section">
				<div class="portrait-container @GetRarityClass() @GetEvolutionClass()">
					<div class="rarity-glow"></div>
					<div class="evolution-glow"></div>
					<div class="evolution-particles">
						<div class="particle p1"></div>
						<div class="particle p2"></div>
						<div class="particle p3"></div>
						<div class="particle p4"></div>
						<div class="particle p5"></div>
						<div class="particle p6"></div>
						<div class="particle p7"></div>
						<div class="particle p8"></div>
					</div>
					@if (HasSprite())
					{
						<img class="monster-portrait @(evolutionPhase == "transform" || evolutionPhase == "burst" ? "hidden" : "")" src="@GetIconPath()" />
						@if (!string.IsNullOrEmpty(evolvedIconPath) && (evolutionPhase == "transform" || evolutionPhase == "burst"))
						{
							<img class="monster-portrait evolved-portrait" src="@evolvedIconPath" />
						}
					}
					else
					{
						<div class="monster-portrait-placeholder">?</div>
					}
					<div class="element-tag @GetElementClass()">
						<img class="element-tag-icon" src="ui/icons/elements/transparent/@(GetElementClass()).svg" />
						<span>@GetElementName()</span>
					</div>
				</div>
				<div class="monster-name-section">
					<input class="nickname-input" value="@Monster.Nickname"
						   onchange=@OnNicknameChanged />
					<div class="species-name">@GetSpeciesName()</div>
				</div>
			</div>

			<!-- Quick Info Row -->
			<div class="quick-info-row">
				<div class="info-badge level">
					<span class="info-label">LV</span>
					<span class="info-value">@Monster.Level</span>
				</div>
				<div class="info-badge power">
					<span class="info-label">PWR</span>
					<span class="info-value">@Monster.PowerRating</span>
				</div>
			</div>

			<!-- Stats Section -->
			<div class="stats-section">
				<div class="section-title">Stats</div>
				<div class="stats-grid">
					<div class="stat-item">
						<div class="stat-header">
							<span class="stat-name">HP</span>
							<span class="stat-value">@Monster.MaxHP</span>
						</div>
						<div class="stat-bar-bg">
							<div class="stat-bar-fill hp" style="width: @(GetStatPercent(Monster.MaxHP, 300))%"></div>
						</div>
						<div class="stat-breakdown">
							<span class="gene-value">Gene: @(GetGene("HP"))/30</span>
						</div>
					</div>

					<div class="stat-item">
						<div class="stat-header">
							<span class="stat-name">Attack</span>
							<span class="stat-value">@Monster.ATK</span>
						</div>
						<div class="stat-bar-bg">
							<div class="stat-bar-fill atk" style="width: @(GetStatPercent(Monster.ATK, 200))%"></div>
						</div>
						<div class="stat-breakdown">
							<span class="gene-value">Gene: @(GetGene("ATK"))/30</span>
						</div>
					</div>

					<div class="stat-item">
						<div class="stat-header">
							<span class="stat-name">Defense</span>
							<span class="stat-value">@Monster.DEF</span>
						</div>
						<div class="stat-bar-bg">
							<div class="stat-bar-fill def" style="width: @(GetStatPercent(Monster.DEF, 200))%"></div>
						</div>
						<div class="stat-breakdown">
							<span class="gene-value">Gene: @(GetGene("DEF"))/30</span>
						</div>
					</div>

					<div class="stat-item">
						<div class="stat-header">
							<span class="stat-name">Sp. Attack</span>
							<span class="stat-value">@Monster.SpA</span>
						</div>
						<div class="stat-bar-bg">
							<div class="stat-bar-fill spa" style="width: @(GetStatPercent(Monster.SpA, 200))%"></div>
						</div>
						<div class="stat-breakdown">
							<span class="gene-value">Gene: @(GetGene("SpA"))/30</span>
						</div>
					</div>

					<div class="stat-item">
						<div class="stat-header">
							<span class="stat-name">Sp. Defense</span>
							<span class="stat-value">@Monster.SpD</span>
						</div>
						<div class="stat-bar-bg">
							<div class="stat-bar-fill spd" style="width: @(GetStatPercent(Monster.SpD, 200))%"></div>
						</div>
						<div class="stat-breakdown">
							<span class="gene-value">Gene: @(GetGene("SpD"))/30</span>
						</div>
					</div>

					<div class="stat-item">
						<div class="stat-header">
							<span class="stat-name">Speed</span>
							<span class="stat-value">@Monster.SPD</span>
						</div>
						<div class="stat-bar-bg">
							<div class="stat-bar-fill spd" style="width: @(GetStatPercent(Monster.SPD, 200))%"></div>
						</div>
						<div class="stat-breakdown">
							<span class="gene-value">Gene: @(GetGene("SPD"))/30</span>
						</div>
					</div>
				</div>

				<div class="power-display">
					<span class="power-label">Total Power</span>
					<span class="power-value">@Monster.PowerRating</span>
				</div>
			</div>

			<!-- Moves Section -->
			<div class="moves-section">
				<div class="section-title">
					Moves
					@if (GetAvailableMovesCount() > 0)
					{
						<span class="moves-available-badge">@GetAvailableMovesCount() available</span>
					}
				</div>
				<div class="moves-grid">
					@{
						var moves = Monster.Moves ?? new List<MonsterMove>();
						for (int i = 0; i < 4; i++)
						{
							var slotIndex = i;
							if (i < moves.Count)
							{
								var move = moves[i];
								var moveDef = MoveDatabase.GetMove(move.MoveId);
								if (moveDef != null)
								{
									var elementClass = moveDef.Element.ToString().ToLower();
									<div class="move-slot @elementClass @(GetAvailableMovesCount() > 0 ? "swappable" : "")" onclick="@(() => OpenMoveSwap(slotIndex))">
										<div class="move-info">
											<img class="move-element-icon" src="ui/icons/elements/transparent/@(GetElementIconName(moveDef.Element)).svg" />
											<span class="move-name">@moveDef.Name</span>
											@if (GetAvailableMovesCount() > 0)
											{
												<span class="swap-hint">TAP TO SWAP</span>
											}
										</div>
										<div class="move-details">
											<span class="move-category @moveDef.Category.ToString().ToLower()">@moveDef.Category</span>
											@if (moveDef.BasePower > 0)
											{
												<span class="move-power">PWR @moveDef.BasePower</span>
											}
											<span class="move-pp">PP @move.CurrentPP/@moveDef.MaxPP</span>
										</div>
									</div>
								}
							}
							else
							{
								<div class="move-slot empty @(GetAvailableMovesCount() > 0 ? "swappable" : "")" onclick="@(() => OpenMoveSwap(slotIndex))">
									<span class="empty-slot-text">@(GetAvailableMovesCount() > 0 ? "+ Learn Move" : "---")</span>
								</div>
							}
						}
					}
				</div>
			</div>

			<!-- Genetics Section -->
			<div class="genetics-section">
				<div class="section-title">Genetics</div>
				<div class="genetics-info">
					<div class="genetics-row">
						<span class="genetics-label">Quality</span>
						<span class="genetics-value @GetGeneticsClass()">@(Monster.Genetics?.QualityRating ?? "Unknown")</span>
					</div>
					<div class="genetics-row">
						<span class="genetics-label">Nature</span>
						<span class="genetics-value">@GetNatureDescription()</span>
					</div>
					<div class="genetics-row">
						<span class="genetics-label">Total Genes</span>
						<span class="genetics-value">@GetTotalGenes()/180</span>
					</div>
				</div>
			</div>

				<!-- Lineage Section -->
			<div class="lineage-section">
				<div class="section-title">Info</div>
				<div class="lineage-info">
					<div class="lineage-row">
						<span class="lineage-label">Level</span>
						<span class="lineage-value">@Monster.Level</span>
					</div>
					<div class="xp-row">
						<span class="lineage-label">Experience</span>
						<div class="xp-bar-container">
							<div class="xp-bar">
								<div class="xp-fill" style="width: @(GetXPPercent())%"></div>
							</div>
							<span class="xp-text">@Monster.CurrentXP / @Monster.XPForNextLevel</span>
						</div>
					</div>
					<div class="lineage-row">
						<span class="lineage-label">Generation</span>
						<span class="lineage-value">@(Monster.Generation == 0 ? "Wild" : $"Gen {Monster.Generation}")</span>
					</div>
					@if (!string.IsNullOrEmpty(Monster.OriginalTrainerName))
					{
						<div class="lineage-row">
							<span class="lineage-label">OT</span>
							<span class="lineage-value">@Monster.OriginalTrainerName</span>
						</div>
					}
					<div class="lineage-row">
						<span class="lineage-label">Obtained</span>
						<span class="lineage-value">@Monster.CaughtAt.ToString("MMM d, yyyy")</span>
					</div>
				</div>
			</div>

			<!-- Battle Mastery Section -->
			<div class="veteran-section">
				<div class="section-title">Battle Mastery</div>
				<div class="veteran-info">
					<div class="veteran-rank @GetVeteranRankClass()">
						<span class="rank-icon">@GetVeteranRankIcon()</span>
						<span class="rank-name">@GetVeteranRankName()</span>
						@if (GetVeteranBonusPercent() > 0)
						{
							<span class="rank-bonus">+@GetVeteranBonusPercent()% Stats</span>
						}
					</div>
					<div class="veteran-progress">
						<div class="progress-bar">
							<div class="progress-fill" style="width: @GetVeteranProgress()%"></div>
						</div>
						@if (Monster.BattlesToNextRank() > 0)
						{
							<span class="progress-text">@Monster.BattlesToNextRank() battles to next rank</span>
						}
						else
						{
							<span class="progress-text">Max rank achieved!</span>
						}
					</div>
					<div class="veteran-stats">
						<div class="vet-stat">
							<span class="vet-stat-value">@Monster.BattlesFought</span>
							<span class="vet-stat-label">Battles</span>
						</div>
						<div class="vet-stat">
							<span class="vet-stat-value">@Monster.TotalKnockouts</span>
							<span class="vet-stat-label">KOs</span>
						</div>
						<div class="vet-stat">
							<span class="vet-stat-value">@FormatDamage(Monster.TotalDamageDealt)</span>
							<span class="vet-stat-label">Damage</span>
						</div>
						<div class="vet-stat">
							<span class="vet-stat-value">@Monster.BossesDefeated</span>
							<span class="vet-stat-label">Bosses</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Journal Section -->
			@if (Monster.Journal != null && Monster.Journal.Count > 0)
			{
				<div class="journal-section">
					<div class="section-title">Journal</div>
					<div class="journal-entries">
						@foreach (var entry in Monster.Journal.OrderByDescending(e => e.Timestamp).Take(5))
						{
							<div class="journal-entry @GetJournalEntryClass(entry.Type)">
								<span class="entry-icon">@GetJournalEntryIcon(entry.Type)</span>
								<span class="entry-content">@entry.Content</span>
								<span class="entry-date">@GetRelativeTime(entry.Timestamp)</span>
							</div>
						}
					</div>
				</div>
			}
		</div>

		<div class="detail-actions">
			@if (CanEvolve())
			{
				<button class="action-btn evolve" onclick=@OnEvolveClicked>
					<span class="action-icon">‚ú¶</span>
					<span class="action-text">Evolve to @GetEvolutionSpeciesName()</span>
				</button>
			}
			<button class="action-btn fuse" onclick=@OnBreedClicked>
				<span class="action-icon">‚öó</span>
				<span class="action-text">Fuse</span>
			</button>
			<button class="action-btn item @(HasHeldItem() ? "has-item" : "") @GetHeldItemRarityClass()" onclick=@OpenItemPicker>
				@if (HasHeldItem())
				{
					<img class="action-item-icon" src="@GetHeldItemIconPath()" onerror="this.style.display='none'" />
					<span class="action-text">@GetHeldItemName()</span>
				}
				else
				{
					<span class="action-icon">‚öî</span>
					<span class="action-text">Item</span>
				}
			</button>
			<button class="action-btn team">
				<span class="action-icon">üë•</span>
				<span class="action-text">Team</span>
			</button>
			<button class="action-btn release @(CanReleaseMonster() ? "" : "disabled")" onclick=@OnReleaseClicked>
				<span class="action-icon">‚Üó</span>
				<span class="action-text">@(CanReleaseMonster() ? "Release" : "Last Monster")</span>
			</button>
		</div>
	</div>

	<!-- Journal Modal -->
	@if (showJournalModal && Monster.Journal != null)
	{
		<div class="journal-modal-overlay" onclick=@CloseJournalModal>
			<div class="journal-modal" onclick="@((e) => e.StopPropagation())">
				<div class="journal-modal-header">
					<div class="journal-header-left">
						<span class="journal-icon">üìñ</span>
						<span class="journal-name">@(string.IsNullOrEmpty(Monster.Nickname) ? GetSpeciesName() : Monster.Nickname)'s Journal</span>
					</div>
					<button class="journal-close-btn" onclick=@CloseJournalModal><img class="close-icon" src="ui/icons/buttons/close.svg" /></button>
				</div>
				<div class="journal-modal-content">
					@if (Monster.Journal.Count > 0)
					{
						@foreach (var entry in Monster.Journal.OrderByDescending(e => e.Timestamp))
						{
							<div class="journal-modal-entry @GetJournalEntryClass(entry.Type)">
								<span class="entry-icon">@GetJournalEntryIcon(entry.Type)</span>
								<div class="entry-body">
									<div class="entry-text">@entry.Content</div>
									<div class="entry-meta">
										<div class="entry-badge @GetJournalEntryClass(entry.Type)">
											<span class="badge-text">@GetJournalEntryBadge(entry.Type)</span>
										</div>
										<div class="entry-timestamp">@entry.Timestamp.ToString("MMM d, yyyy") at @entry.Timestamp.ToString("h:mm tt")</div>
									</div>
								</div>
							</div>
						}
					}
					else
					{
						<div class="journal-empty">No journal entries yet.</div>
					}
				</div>
			</div>
		</div>
	}

	<!-- Item Picker Modal -->
	@if (showItemPicker)
	{
		<div class="item-picker-overlay" onclick=@CloseItemPicker>
			<div class="item-picker-modal" onclick="@((e) => e.StopPropagation())">
				<div class="item-picker-header">
					<span class="picker-title">Held Item</span>
					<button class="picker-close-btn" onclick=@CloseItemPicker><img class="close-icon" src="ui/icons/buttons/close.svg" /></button>
				</div>
				@if (HasHeldItem())
				{
					<div class="current-item-section">
						<span class="section-label">Currently Equipped</span>
						<div class="current-item @GetHeldItemRarityClass()">
							<img class="item-icon" src="@GetHeldItemIconPath()" onerror="this.style.display='none'" />
							<div class="item-info">
								<span class="item-name">@GetHeldItemName()</span>
								<span class="item-effect">@GetHeldItemDescription()</span>
							</div>
							<button class="unequip-btn" onclick=@UnequipCurrentItem>Unequip</button>
						</div>
					</div>
				}
				<div class="item-picker-content">
					<div class="available-items-section">
						<span class="section-label">Available Items (@GetAvailableHeldItems().Count)</span>
						<div class="items-grid">
							@foreach (var item in GetAvailableHeldItems())
							{
								<div class="item-option @GetItemRarityClass(item)" onclick="@(() => EquipItem(item.Id))">
									<img class="item-icon" src="@item.IconPath" onerror="this.style.display='none'" />
									<div class="item-info">
										<span class="item-name">@item.Name</span>
										<span class="item-rarity">@item.Rarity</span>
										<span class="item-effect">@item.Description</span>
									</div>
									<span class="item-qty">x@(GetItemQuantity(item.Id))</span>
								</div>
							}
							@if (GetAvailableHeldItems().Count == 0)
							{
								<div class="no-items">
									<span class="no-items-icon">üì¶</span>
									<span class="no-items-text">No held items in inventory</span>
								</div>
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	}

	<!-- Move Picker Modal -->
	@if (showMovePicker)
	{
		<div class="move-picker-overlay" onclick=@CloseMoveSwap>
			<div class="move-picker-modal" onclick="@((e) => e.StopPropagation())">
				<div class="move-picker-header">
					<span class="picker-title">@(selectedMoveSlot < (Monster.Moves?.Count ?? 0) ? "Swap Move" : "Learn Move")</span>
					<button class="picker-close-btn" onclick=@CloseMoveSwap><img class="close-icon" src="ui/icons/buttons/close.svg" /></button>
				</div>
				@if (selectedMoveSlot < (Monster.Moves?.Count ?? 0))
				{
					var currentMove = Monster.Moves[selectedMoveSlot];
					var currentDef = MoveDatabase.GetMove(currentMove.MoveId);
					@if (currentDef != null)
					{
						<div class="current-move-section">
							<span class="section-label">Replacing</span>
							<div class="current-move @currentDef.Element.ToString().ToLower()">
								<img class="move-element-icon" src="ui/icons/elements/transparent/@(GetElementIconName(currentDef.Element)).svg" />
								<div class="move-info-col">
									<span class="move-name">@currentDef.Name</span>
									<div class="move-meta">
										<span class="move-category @currentDef.Category.ToString().ToLower()">@currentDef.Category</span>
										@if (currentDef.BasePower > 0)
										{
											<span class="move-power">PWR @currentDef.BasePower</span>
										}
										<span class="move-pp">PP @currentDef.MaxPP</span>
									</div>
								</div>
							</div>
						</div>
					}
				}
				<div class="move-picker-content">
					<span class="section-label">Available Moves (@GetAvailableMovesForPicker().Count)</span>
					<div class="moves-list">
						@foreach (var lm in GetAvailableMovesForPicker())
						{
							var moveDef = MoveDatabase.GetMove(lm.MoveId);
							if (moveDef != null)
							{
								<div class="move-option @moveDef.Element.ToString().ToLower()" onclick="@(() => SwapMoveSlot(lm.MoveId))">
									<img class="move-element-icon" src="ui/icons/elements/transparent/@(GetElementIconName(moveDef.Element)).svg" />
									<div class="move-info-col">
										<label class="move-name">@moveDef.Name</label>
										<div class="move-desc-wrap">
											<label class="move-desc">@moveDef.Description</label>
										</div>
										<div class="move-meta">
											<span class="move-category @moveDef.Category.ToString().ToLower()">@moveDef.Category</span>
											@if (moveDef.BasePower > 0)
											{
												<span class="move-power">PWR @moveDef.BasePower</span>
											}
											@if (moveDef.Accuracy < 100)
											{
												<span class="move-acc">ACC @moveDef.Accuracy%</span>
											}
											<span class="move-pp">PP @moveDef.MaxPP</span>
										</div>
									</div>
									<span class="move-level">Lv @lm.LearnLevel</span>
								</div>
							}
						}
						@if (GetAvailableMovesForPicker().Count == 0)
						{
							<div class="no-items">
								<span class="no-items-icon">‚öî</span>
								<span class="no-items-text">No other moves available</span>
							</div>
						}
					</div>
				</div>
			</div>
		</div>
	}
}

@code {
	public Monster Monster { get; set; }
	public Action OnBack { get; set; }
	public Action<Monster> OnBreed { get; set; }
	public Action<Monster> OnRelease { get; set; }
	public Action<Monster> OnEvolve { get; set; }
	public Action<Monster> OnJournal { get; set; }

	// Evolution animation state
	private bool isEvolving = false;
	private string evolutionPhase = ""; // "shake", "glow", "transform", "burst"
	private string evolvedIconPath = "";

	// Journal modal state
	private bool showJournalModal = false;

	// Item picker state
	private bool showItemPicker = false;

	// Move picker state
	private bool showMovePicker = false;
	private int selectedMoveSlot = -1;

	private void OnBackClicked()
	{
		OnBack?.Invoke();
	}

	private void OpenJournal()
	{
		// If external handler exists, use it; otherwise show local modal
		if (OnJournal != null)
		{
			OnJournal.Invoke(Monster);
		}
		else
		{
			showJournalModal = true;
		}
	}

	private void CloseJournalModal()
	{
		showJournalModal = false;
	}

	private string GetJournalEntryBadge(JournalEntryType type)
	{
		return type switch
		{
			JournalEntryType.Caught => "CAUGHT",
			JournalEntryType.Bred => "BRED",
			JournalEntryType.Evolution => "EVOLVED",
			JournalEntryType.BossDefeat => "BOSS",
			JournalEntryType.Milestone => "MILESTONE",
			JournalEntryType.Expedition => "EXPEDITION",
			_ => "NOTE"
		};
	}

	private async void OnEvolveClicked()
	{
		if (!CanEvolve() || isEvolving)
		{
			SoundManager.PlayDeny();
			return;
		}

		// Get the evolved species icon before starting
		var currentSpecies = MonsterManager.Instance?.GetSpecies(Monster?.SpeciesId);
		var evolvedSpecies = MonsterManager.Instance?.GetSpecies(currentSpecies?.EvolvesTo);
		evolvedIconPath = evolvedSpecies?.IconPath ?? "";

		// Start evolution animation sequence
		isEvolving = true;
		SoundManager.PlayClick();
		StateHasChanged();

		// Phase 1: Shake (600ms)
		evolutionPhase = "shake";
		StateHasChanged();
		await Task.Delay(600);

		// Phase 2: Glow builds up (500ms)
		evolutionPhase = "glow";
		StateHasChanged();
		await Task.Delay(500);

		// Phase 3: Transform - bright flash and swap sprite (400ms)
		evolutionPhase = "transform";
		StateHasChanged();
		await Task.Delay(400);

		// Phase 4: Burst - particle effect while revealing new form (500ms)
		evolutionPhase = "burst";
		StateHasChanged();
		await Task.Delay(500);

		// Reset animation state and trigger actual evolution
		evolutionPhase = "";
		isEvolving = false;
		evolvedIconPath = "";
		StateHasChanged();

		// Now actually evolve the monster
		OnEvolve?.Invoke(Monster);
	}

	private string GetEvolutionClass()
	{
		if (!isEvolving) return "";
		return $"evolving evolving-{evolutionPhase}";
	}

	private bool CanEvolve()
	{
		if (Monster == null) return false;
		var species = MonsterManager.Instance?.GetSpecies(Monster.SpeciesId);
		if (species == null) return false;
		return Monster.CanEvolve(species);
	}

	private string GetEvolutionSpeciesName()
	{
		var species = MonsterManager.Instance?.GetSpecies(Monster?.SpeciesId);
		if (species == null || string.IsNullOrEmpty(species.EvolvesTo)) return "???";
		var evolvedSpecies = MonsterManager.Instance?.GetSpecies(species.EvolvesTo);
		return evolvedSpecies?.Name ?? "???";
	}

	private void ToggleFavorite()
	{
		if (Monster != null)
		{
			Monster.IsFavorite = !Monster.IsFavorite;
		}
	}

	private void ShowOffBeast()
	{
		if (Monster == null) return;

		var species = MonsterManager.Instance?.GetSpecies(Monster.SpeciesId);
		if (species == null) return;

		ChatManager.Instance?.SendBeastShowcase(Monster, species);
		SoundManager.PlayNotification();

		var name = string.IsNullOrEmpty(Monster.Nickname) ? species.Name : Monster.Nickname;
		NotificationManager.Instance?.AddNotification(NotificationType.Info, "Beast Shared!", $"Shared {name} in chat");
	}

	private void OnNicknameChanged(PanelEvent e)
	{
		// Would update the nickname from input
	}

	private void OnBreedClicked()
	{
		OnBreed?.Invoke(Monster);
	}

	private void OnReleaseClicked()
	{
		if (!CanReleaseMonster())
		{
			SoundManager.PlayDeny();
			return;
		}
		OnRelease?.Invoke(Monster);
	}

	private bool CanReleaseMonster()
	{
		// Must have more than 1 monster to release one
		return (MonsterManager.Instance?.OwnedMonsters?.Count ?? 0) > 1;
	}

	private bool HasSprite()
	{
		var species = MonsterManager.Instance?.GetSpecies(Monster?.SpeciesId);
		if (species == null) return false;

		if (species.AnimationFrames != null && species.AnimationFrames.Count > 0)
			return true;
		if (!string.IsNullOrEmpty(species.IconPath))
			return true;

		return false;
	}

	private string GetIconPath()
	{
		var species = MonsterManager.Instance?.GetSpecies(Monster.SpeciesId);
		return species?.IconPath ?? "";
	}

	private string GetSpeciesName()
	{
		var species = MonsterManager.Instance?.GetSpecies(Monster.SpeciesId);
		return species?.Name ?? "Unknown";
	}

	private string GetRarityClass()
	{
		var species = MonsterManager.Instance?.GetSpecies(Monster.SpeciesId);
		return $"rarity-{species?.BaseRarity.ToString().ToLower() ?? "common"}";
	}

	private string GetElementClass()
	{
		var species = MonsterManager.Instance?.GetSpecies(Monster.SpeciesId);
		return species?.Element.ToString().ToLower() ?? "neutral";
	}

	private string GetElementName()
	{
		var species = MonsterManager.Instance?.GetSpecies(Monster.SpeciesId);
		return species?.Element.ToString().ToUpper() ?? "NEUTRAL";
	}

	private float GetStatPercent(int value, int max)
	{
		return Math.Min(100, (float)value / max * 100);
	}

	private string GetGeneticsClass()
	{
		if (Monster?.Genetics == null) return "average";
		return Monster.Genetics.QualityRating.ToLower() switch
		{
			"perfect" => "perfect",
			"excellent" => "excellent",
			"great" => "great",
			"good" => "good",
			_ => "average"
		};
	}

	private string GetNatureDescription()
	{
		if (Monster.Genetics == null) return "Unknown";
		return Monster.Genetics.Nature switch
		{
			NatureType.Balanced => "Balanced (No effect)",
			NatureType.Ferocious => "Ferocious (+ATK, -DEF)",
			NatureType.Stalwart => "Stalwart (+DEF, -ATK)",
			NatureType.Restless => "Restless (+SPD, -HP)",
			NatureType.Enduring => "Enduring (+HP, -SPD)",
			NatureType.Reckless => "Reckless (+ATK, -SPD)",
			NatureType.Stoic => "Stoic (+DEF, -SPD)",
			NatureType.Skittish => "Skittish (+SPD, -DEF)",
			NatureType.Vigorous => "Vigorous (+HP, -ATK)",
			NatureType.Ruthless => "Ruthless (+ATK, -HP)",
			NatureType.Nimble => "Nimble (+SPD, -ATK)",
			NatureType.Mystical => "Mystical (+SpA, -ATK)",
			NatureType.Resolute => "Resolute (+SpD, -SpA)",
			NatureType.Arcane => "Arcane (+SpA, -DEF)",
			NatureType.Warded => "Warded (+SpD, -SPD)",
			NatureType.Cunning => "Cunning (+SpA, -HP)",
			NatureType.Serene => "Serene (+SpD, -ATK)",
			_ => "Unknown"
		};
	}

	private int GetTotalGenes()
	{
		if (Monster.Genetics == null) return 0;
		return Monster.Genetics.HPGene + Monster.Genetics.ATKGene +
			   Monster.Genetics.DEFGene + Monster.Genetics.SPDGene +
			   Monster.Genetics.SpAGene + Monster.Genetics.SpDGene;
	}

	private int GetGene(string stat)
	{
		if (Monster?.Genetics == null) return 0;
		return stat switch
		{
			"HP" => Monster.Genetics.HPGene,
			"ATK" => Monster.Genetics.ATKGene,
			"DEF" => Monster.Genetics.DEFGene,
			"SpA" => Monster.Genetics.SpAGene,
			"SpD" => Monster.Genetics.SpDGene,
			"SPD" => Monster.Genetics.SPDGene,
			_ => 0
		};
	}

	private string GetElementIconName(ElementType element)
	{
		return element.ToString().ToLower();
	}

	private float GetXPPercent()
	{
		if (Monster == null || Monster.XPForNextLevel <= 0) return 0;
		return (float)Monster.CurrentXP / Monster.XPForNextLevel * 100f;
	}

	// Veteran status helpers
	private string GetVeteranRankName()
	{
		return Monster?.GetVeteranRank().ToString() ?? "Rookie";
	}

	private string GetVeteranRankClass()
	{
		return Monster?.GetVeteranRank().ToString().ToLower() ?? "rookie";
	}

	private string GetVeteranRankIcon()
	{
		return Monster?.GetVeteranRank() switch
		{
			VeteranRank.Rookie => "üå±",
			VeteranRank.Trained => "‚öî",
			VeteranRank.Seasoned => "üõ°",
			VeteranRank.Veteran => "üéñ",
			VeteranRank.Elite => "‚≠ê",
			VeteranRank.Champion => "üëë",
			VeteranRank.Legend => "üèÜ",
			_ => "üå±"
		};
	}

	private int GetVeteranBonusPercent()
	{
		if (Monster == null) return 0;
		return (int)(Monster.GetVeteranBonusPercent() * 100);
	}

	private float GetVeteranProgress()
	{
		if (Monster == null) return 0;
		var rank = Monster.GetVeteranRank();
		int current = Monster.BattlesFought;
		int nextThreshold = rank switch
		{
			VeteranRank.Rookie => 25,
			VeteranRank.Trained => 100,
			VeteranRank.Seasoned => 200,
			VeteranRank.Veteran => 400,
			VeteranRank.Elite => 750,
			VeteranRank.Champion => 1500,
			VeteranRank.Legend => 1500, // Max rank
			_ => 25
		};
		int prevThreshold = rank switch
		{
			VeteranRank.Rookie => 0,
			VeteranRank.Trained => 25,
			VeteranRank.Seasoned => 100,
			VeteranRank.Veteran => 200,
			VeteranRank.Elite => 400,
			VeteranRank.Champion => 750,
			VeteranRank.Legend => 1500,
			_ => 0
		};
		if (rank == VeteranRank.Legend) return 100;
		float progress = (float)(current - prevThreshold) / (nextThreshold - prevThreshold) * 100f;
		return Math.Clamp(progress, 0, 100);
	}

	private string FormatDamage(int damage)
	{
		if (damage >= 1000000) return $"{damage / 1000000f:F1}M";
		if (damage >= 1000) return $"{damage / 1000f:F1}K";
		return damage.ToString();
	}

	// Journal helpers
	private string GetJournalEntryClass(JournalEntryType type)
	{
		return type.ToString().ToLower();
	}

	private string GetJournalEntryIcon(JournalEntryType type)
	{
		return type switch
		{
			JournalEntryType.Caught => "üìú",
			JournalEntryType.Bred => "ü•ö",
			JournalEntryType.Evolution => "‚ú®",
			JournalEntryType.BossDefeat => "üíÄ",
			JournalEntryType.Milestone => "üéñ",
			JournalEntryType.Expedition => "üó∫",
			_ => "üìù"
		};
	}

	private string GetRelativeTime(DateTime timestamp)
	{
		var diff = DateTime.UtcNow - timestamp;
		if (diff.TotalMinutes < 1) return "Just now";
		if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
		if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
		if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
		return timestamp.ToString("MMM d");
	}

	// Held item helpers - updated to use PNG icons
	private bool HasHeldItem()
	{
		return !string.IsNullOrEmpty(Monster?.HeldItemId);
	}

	private string GetHeldItemIconPath()
	{
		if (!HasHeldItem()) return "";
		var item = ItemManager.Instance?.GetItem(Monster.HeldItemId);
		var path = item?.IconPath ?? "";
		Log.Info($"[HeldItem] Icon path for {Monster.HeldItemId}: {path}");
		return path;
	}

	private string GetHeldItemName()
	{
		if (!HasHeldItem()) return "";
		var item = ItemManager.Instance?.GetItem(Monster.HeldItemId);
		return item?.Name ?? "Unknown Item";
	}

	private string GetHeldItemDescription()
	{
		if (!HasHeldItem()) return "";
		var item = ItemManager.Instance?.GetItem(Monster.HeldItemId);
		return item?.Description ?? "";
	}

	private string GetHeldItemTooltip()
	{
		if (!HasHeldItem()) return "Click to equip a held item";
		var item = ItemManager.Instance?.GetItem(Monster.HeldItemId);
		return item != null ? $"{item.Name}: {item.Description}" : "Unknown Item";
	}

	private string GetHeldItemRarityClass()
	{
		if (!HasHeldItem()) return "";
		var item = ItemManager.Instance?.GetItem(Monster.HeldItemId);
		return item != null ? $"rarity-{item.Rarity.ToString().ToLower()}" : "";
	}

	private string GetItemRarityClass(ItemDefinition item)
	{
		return $"rarity-{item.Rarity.ToString().ToLower()}";
	}

	private void OpenItemPicker()
	{
		showItemPicker = true;
		SoundManager.PlayClick();
	}

	private void CloseItemPicker()
	{
		showItemPicker = false;
	}

	private List<ItemDefinition> GetAvailableHeldItems()
	{
		var items = new List<ItemDefinition>();
		var inventory = TamerManager.Instance?.CurrentTamer?.Inventory;
		if (inventory == null) return items;

		foreach (var kvp in inventory)
		{
			if (kvp.Value <= 0) continue;
			var item = ItemManager.Instance?.GetItem(kvp.Key);
			if (item != null && item.Category == ItemCategory.HeldItem)
			{
				items.Add(item);
			}
		}

		return items.OrderBy(i => i.Rarity).ThenBy(i => i.Name).ToList();
	}

	private int GetItemQuantity(string itemId)
	{
		return TamerManager.Instance?.CurrentTamer?.Inventory?.GetValueOrDefault(itemId, 0) ?? 0;
	}

	private void EquipItem(string itemId)
	{
		if (Monster == null) return;

		var success = ItemManager.Instance?.EquipHeldItem(Monster, itemId) ?? false;
		if (success)
		{
			SoundManager.PlayNotification();
			var item = ItemManager.Instance?.GetItem(itemId);
			NotificationManager.Instance?.AddNotification(NotificationType.Success, "Item Equipped", $"Equipped {item?.Name ?? "item"} to {Monster.Nickname ?? GetSpeciesName()}");
			showItemPicker = false;
			// Save both tamer inventory and monster data
			TamerManager.Instance?.SaveToCloud();
			MonsterManager.Instance?.SaveMonsters();
		}
		else
		{
			SoundManager.PlayDeny();
		}
	}

	private void UnequipCurrentItem()
	{
		if (Monster == null || !HasHeldItem()) return;

		var itemName = GetHeldItemName();
		var success = ItemManager.Instance?.UnequipHeldItem(Monster) ?? false;
		if (success)
		{
			SoundManager.PlayClick();
			NotificationManager.Instance?.AddNotification(NotificationType.Info, "Item Unequipped", $"Removed {itemName} from {Monster.Nickname ?? GetSpeciesName()}");
			// Save both tamer inventory and monster data
			TamerManager.Instance?.SaveToCloud();
			MonsterManager.Instance?.SaveMonsters();
		}
	}

	// Move swap helpers
	private void OpenMoveSwap(int slot)
	{
		if (Monster == null) return;
		var available = MonsterManager.Instance?.GetAvailableMoves(Monster);
		if (available == null || available.Count == 0)
		{
			SoundManager.PlayDeny();
			return;
		}
		selectedMoveSlot = slot;
		showMovePicker = true;
		SoundManager.PlayClick();
	}

	private void CloseMoveSwap()
	{
		showMovePicker = false;
		selectedMoveSlot = -1;
	}

	private void SwapMoveSlot(string newMoveId)
	{
		if (Monster == null) return;

		var moves = Monster.Moves ?? new List<MonsterMove>();
		if (selectedMoveSlot >= moves.Count)
		{
			// Learning into an empty slot
			var moveDef = MoveDatabase.GetMove(newMoveId);
			if (moveDef == null) return;
			Monster.Moves ??= new List<MonsterMove>();
			Monster.Moves.Add(new MonsterMove { MoveId = newMoveId, CurrentPP = moveDef.MaxPP });
			MonsterManager.Instance?.SaveMonsters();
			MonsterManager.Instance?.OnMonsterUpdated?.Invoke(Monster);
			SoundManager.PlayNotification();
			var name = string.IsNullOrEmpty(Monster.Nickname) ? GetSpeciesName() : Monster.Nickname;
			NotificationManager.Instance?.AddNotification(NotificationType.Success, "Move Learned!", $"{name} learned {moveDef.Name}!");
		}
		else
		{
			var success = MonsterManager.Instance?.SwapMove(Monster, selectedMoveSlot, newMoveId) ?? false;
			if (success)
			{
				SoundManager.PlayNotification();
				var moveDef = MoveDatabase.GetMove(newMoveId);
				var name = string.IsNullOrEmpty(Monster.Nickname) ? GetSpeciesName() : Monster.Nickname;
				NotificationManager.Instance?.AddNotification(NotificationType.Success, "Move Swapped!", $"{name} learned {moveDef?.Name ?? "a new move"}!");
			}
			else
			{
				SoundManager.PlayDeny();
			}
		}

		showMovePicker = false;
		selectedMoveSlot = -1;
	}

	private int GetAvailableMovesCount()
	{
		if (Monster == null) return 0;
		return MonsterManager.Instance?.GetAvailableMoves(Monster)?.Count ?? 0;
	}

	private List<LearnableMove> GetAvailableMovesForPicker()
	{
		if (Monster == null) return new List<LearnableMove>();
		return MonsterManager.Instance?.GetAvailableMoves(Monster) ?? new List<LearnableMove>();
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(Monster?.Id);
		hash.Add(Monster?.Nickname);
		hash.Add(Monster?.Level);
		hash.Add(Monster?.IsFavorite);
		hash.Add(Monster?.HeldItemId);
		hash.Add(isEvolving);
		hash.Add(evolutionPhase);
		hash.Add(evolvedIconPath);
		hash.Add(showItemPicker);
		hash.Add(showMovePicker);
		hash.Add(selectedMoveSlot);
		return hash.ToHashCode();
	}
}
