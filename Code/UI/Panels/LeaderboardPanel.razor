@namespace Beastborne.UI.Panels
@using System;
@using System.Linq;
@using System.Collections.Generic;
@using System.Threading.Tasks;
@using Sandbox;
@using Sandbox.Services;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Systems;
@inherits Panel

<div class="leaderboard-panel">
	<div class="leaderboard-header">
		<div class="header-left">
			<div class="leaderboard-title">Leaderboards</div>
			<div class="leaderboard-subtitle">Compare your stats against other tamers</div>
		</div>
		<div class="header-right">
			<button class="refresh-btn" onclick=@RefreshAll><span>Refresh</span></button>
			<button class="lb-back-btn" onclick=@OnBackClicked><span>Back</span></button>
		</div>
	</div>

	<div class="leaderboard-scroll @(FilterMode == "arena" ? "arena-filter" : "")">
		@if ( isLoading )
		{
			<div class="loading-state">
				<div class="loading-spinner"></div>
				<span>Loading leaderboards...</span>
			</div>
		}
		else
		{
			@foreach ( var cat in GetVisibleCategories() )
			{
				var catEntries = GetEntries( cat.Key );
				var rank = GetPlayerRank( cat.Key );
				var playerValue = GetPlayerValue( cat.Key );
				var isExpanded = expanded.ContainsKey( cat.Key ) && expanded[cat.Key];
				var displayEntries = isExpanded ? catEntries.Take( 20 ) : catEntries.Take( 10 );

				<div class="lb-section" style="border-color: @ColorWithAlpha( cat.Color, 0.25 ); box-shadow: 0 4px 20px @ColorWithAlpha( cat.Color, 0.1 )">
					<!-- Section Header -->
					<div class="lb-section-header" style="border-left: 4px solid @cat.Color; background-color: @ColorWithAlpha( cat.Color, 0.12 )">
						<div class="lb-section-left">
							<span class="lb-section-icon" style="color: @cat.Color">@cat.Icon</span>
							<span class="lb-section-name">@cat.Label</span>
						</div>
						<div class="lb-section-right">
							<span class="lb-section-value" style="color: @cat.Color">@FormatValue( playerValue, cat.Key )</span>
							@if ( cat.Key == "arena-score" )
							{
								<span class="lb-section-tier" style="color: @GetPlayerRankColor()">@GetPlayerRankTitle()</span>
							}
							<div class="lb-rank-pill" style="background-color: @ColorWithAlpha( cat.Color, 0.3 ); border-color: @cat.Color">
								<span class="lb-rank-label">Rank</span>
								<span class="lb-rank-number">#@rank</span>
							</div>
						</div>
					</div>

					<!-- Entries -->
					@if ( catEntries.Count == 0 )
					{
						<div class="lb-empty">No entries yet</div>
					}
					else
					{
						<div class="lb-entries">
							@foreach ( var entry in displayEntries )
							{
								<div class="lb-entry @(entry.Rank <= 3 ? $"top-{entry.Rank}" : "") @(IsPlayerEntry( entry ) ? "player" : "")">
									<div class="lb-entry-rank">
										@if ( entry.Rank == 1 )
										{
											<span class="rank-medal gold">ðŸ¥‡</span>
										}
										else if ( entry.Rank == 2 )
										{
											<span class="rank-medal silver">ðŸ¥ˆ</span>
										}
										else if ( entry.Rank == 3 )
										{
											<span class="rank-medal bronze">ðŸ¥‰</span>
										}
										else
										{
											<span class="rank-number">#@entry.Rank</span>
										}
									</div>
									<div class="lb-entry-name">@entry.Name</div>
									@if ( cat.Key == "arena-score" && !string.IsNullOrEmpty( entry.RankTitle ) )
									{
										<div class="lb-entry-tier" style="color: @CompetitiveManager.GetRankColor( entry.RankTitle )">
											@entry.RankTitle
										</div>
									}
									<div class="lb-entry-score" style="color: @cat.Color">@FormatValue( entry.Score, cat.Key )</div>
								</div>
							}
						</div>

						@if ( catEntries.Count > 10 )
						{
							<button class="lb-expand-btn" onclick=@(() => ToggleExpand( cat.Key ))>
								@(isExpanded ? "Show Less" : $"Show Top 20")
							</button>
						}
					}
				</div>
			}
		}
	</div>
</div>

@code {
	public Action OnBack { get; set; }
	public string FilterMode { get; set; } = "all"; // "all" or "arena"

	private Dictionary<string, List<LeaderboardEntry>> allEntries = new();
	private Dictionary<string, int> playerRanks = new();
	private Dictionary<string, bool> expanded = new();
	private bool isLoading = true;

	private record CategoryInfo( string Key, string LeaderboardName, string Label, string Icon, string Unit, string Color );

	private static readonly CategoryInfo[] Categories = new[]
	{
		new CategoryInfo( "arena-score", "arena-score", "Arena Rating", "âš”", "pts", "#fbbf24" ),
		new CategoryInfo( "arena-wins", "arena-wins", "Arena Wins", "ðŸ†", "wins", "#facc15" ),
		new CategoryInfo( "expedition-highest", "expedition-highest", "Expedition", "ðŸ—º", "", "#34d399" ),
		new CategoryInfo( "monsters-caught", "monsters-caught", "Caught", "ðŸ¾", "", "#60a5fa" ),
		new CategoryInfo( "monsters-bred", "monsters-bred", "Bred", "ðŸ¥š", "", "#f472b6" ),
		new CategoryInfo( "monsters-evolved", "monsters-evolved", "Evolved", "ðŸ”®", "", "#c084fc" ),
		new CategoryInfo( "battles-won", "battles-won", "Battles Won", "ðŸ›¡", "", "#f87171" ),
		new CategoryInfo( "total-damage", "total-damage", "Damage", "ðŸ’¥", "dmg", "#fb923c" ),
		new CategoryInfo( "total-knockouts", "total-knockouts", "Knockouts", "ðŸ’€", "KOs", "#cbd5e1" ),
		new CategoryInfo( "total-gold", "total-gold", "Gold Earned", "ðŸ’°", "", "#fcd34d" ),
		new CategoryInfo( "expeditions-completed", "expeditions-completed", "Expeditions", "ðŸ•", "", "#5eead4" ),
		new CategoryInfo( "total-playtime", "total-playtime", "Playtime", "â°", "", "#a78bfa" )
	};

	private CategoryInfo[] GetVisibleCategories()
	{
		if ( FilterMode == "arena" )
		{
			return Categories.Where( c => c.Key == "arena-score" || c.Key == "arena-wins" ).ToArray();
		}
		return Categories;
	}

	protected override async void OnAfterTreeRender( bool firstTime )
	{
		if ( firstTime )
		{
			await LoadAllLeaderboards();
		}
	}

	private async Task LoadAllLeaderboards()
	{
		isLoading = true;
		allEntries = new();
		playerRanks = new();

		var tasks = Categories.Select( async cat =>
		{
			try
			{
				var board = Leaderboards.GetFromStat( "publicsquare.beastborne", cat.LeaderboardName );
				board.MaxEntries = 100;
				await board.Refresh();

				var entries = board.Entries.Select( ( e, index ) => new LeaderboardEntry
				{
					Rank = (int)e.Rank,
					Name = e.DisplayName,
					Score = (int)e.Value,
					RankTitle = cat.Key == "arena-score"
						? CompetitiveManager.GetRankFromPoints( (int)e.Value )
						: ""
				} ).ToList();

				var myName = Connection.Local?.DisplayName;
				var myEntry = entries.FirstOrDefault( x => x.Name == myName );
				var rank = myEntry != null ? myEntry.Rank : (entries.Count + 1);

				lock ( allEntries )
				{
					allEntries[cat.Key] = entries;
					playerRanks[cat.Key] = rank;
				}

				Log.Info( $"Fetched {entries.Count} entries for '{cat.LeaderboardName}'" );
			}
			catch ( Exception e )
			{
				Log.Warning( $"Failed to fetch '{cat.LeaderboardName}': {e.Message}" );
				lock ( allEntries )
				{
					allEntries[cat.Key] = new();
					playerRanks[cat.Key] = 0;
				}
			}
		} );

		await Task.WhenAll( tasks );
		isLoading = false;
		StateHasChanged();
	}

	private async void RefreshAll()
	{
		SoundManager.PlayClick();
		await LoadAllLeaderboards();
	}

	private void OnBackClicked()
	{
		SoundManager.PlayBack();
		OnBack?.Invoke();
	}

	private void ToggleExpand( string key )
	{
		SoundManager.PlayClick();
		if ( expanded.ContainsKey( key ) )
			expanded[key] = !expanded[key];
		else
			expanded[key] = true;
	}

	private List<LeaderboardEntry> GetEntries( string key )
	{
		return allEntries.ContainsKey( key ) ? allEntries[key] : new();
	}

	private int GetPlayerRank( string key )
	{
		return playerRanks.ContainsKey( key ) ? playerRanks[key] : 0;
	}

	private int GetPlayerValue( string key )
	{
		var tamer = TamerManager.Instance?.CurrentTamer;
		if ( tamer == null ) return 0;

		return key switch
		{
			"arena-score" => tamer.ArenaPoints,
			"arena-wins" => tamer.ArenaWins,
			"expedition-highest" => tamer.HighestExpeditionCleared,
			"monsters-caught" => tamer.TotalMonstersCaught,
			"monsters-bred" => tamer.TotalMonstersBred,
			"monsters-evolved" => tamer.TotalMonstersEvolved,
			"battles-won" => tamer.TotalBattlesWon,
			"total-damage" => tamer.TotalDamageDealt,
			"total-knockouts" => tamer.TotalKnockouts,
			"total-gold" => tamer.TotalGoldEarned,
			"expeditions-completed" => tamer.TotalExpeditionsCompleted,
			"total-playtime" => (int)tamer.TotalPlayTime.TotalMinutes,
			_ => 0
		};
	}

	private string FormatValue( int value, string category )
	{
		return category switch
		{
			"arena-score" => $"{value:N0} pts",
			"arena-wins" => $"{value:N0}",
			"expedition-highest" => value > 0 ? $"Stage {value}" : "None",
			"monsters-caught" => $"{value:N0}",
			"monsters-bred" => $"{value:N0}",
			"monsters-evolved" => $"{value:N0}",
			"battles-won" => $"{value:N0}",
			"total-damage" => FormatLargeNumber( value ),
			"total-knockouts" => $"{value:N0}",
			"total-gold" => FormatLargeNumber( value ),
			"expeditions-completed" => $"{value:N0}",
			"total-playtime" => FormatPlaytime( value ),
			_ => $"{value:N0}"
		};
	}

	private string FormatLargeNumber( int value )
	{
		if ( value >= 1000000 ) return $"{value / 1000000f:F1}M";
		if ( value >= 1000 ) return $"{value / 1000f:F1}K";
		return $"{value:N0}";
	}

	private string FormatPlaytime( int minutes )
	{
		if ( minutes < 60 ) return $"{minutes}m";
		int hours = minutes / 60;
		int mins = minutes % 60;
		if ( hours < 24 ) return $"{hours}h {mins}m";
		int days = hours / 24;
		hours = hours % 24;
		return $"{days}d {hours}h";
	}

	private string ColorWithAlpha( string hex, double alpha )
	{
		if ( string.IsNullOrEmpty( hex ) || hex.Length < 7 ) return $"rgba(139, 92, 246, {alpha})";
		int r = Convert.ToInt32( hex.Substring( 1, 2 ), 16 );
		int g = Convert.ToInt32( hex.Substring( 3, 2 ), 16 );
		int b = Convert.ToInt32( hex.Substring( 5, 2 ), 16 );
		return $"rgba({r}, {g}, {b}, {alpha})";
	}

	private string GetPlayerRankTitle()
	{
		return CompetitiveManager.GetRankFromPoints( TamerManager.Instance?.CurrentTamer?.ArenaPoints ?? 0 );
	}

	private string GetPlayerRankColor()
	{
		return CompetitiveManager.GetRankColor( GetPlayerRankTitle() );
	}

	private bool IsPlayerEntry( LeaderboardEntry entry )
	{
		var playerName = TamerManager.Instance?.CurrentTamer?.Name;
		return entry.Name == playerName;
	}
}
