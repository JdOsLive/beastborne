@namespace Beastborne.UI.Panels
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@using Beastborne.UI.Components;
@inherits Panel

<root class="shop-panel-content">
	@if (shopView == "landing")
	{
		<!-- SHOP LANDING PAGE -->
		<div class="shop-landing">
			<div class="landing-buttons">
				<button class="store-card gold-store" onclick=@(() => SwitchShopView("gold"))>
					<div class="store-card-header gold-header">
						<img class="store-card-icon" src="/ui/icons/shop_gold.png" />
					</div>
					<div class="store-card-body">
						<div class="store-card-name">Gold Store</div>
						<div class="store-card-desc">Supplies, boosts, and upgrades</div>
						<div class="store-card-balance">
							<span class="balance-icon">ü™ô</span>
							<span class="balance-value gold-value">@GetGold().ToString("N0")</span>
						</div>
						<div class="store-card-cta gold-cta">Enter Store</div>
					</div>
				</button>
				<button class="store-card boss-store" onclick=@(() => SwitchShopView("boss"))>
					<div class="store-card-header boss-header">
						<img class="store-card-icon" src="/ui/icons/shop_boss.png" />
					</div>
					<div class="store-card-body">
						<div class="store-card-name">Boss Token Store</div>
						<div class="store-card-desc">Rare items from boss victories</div>
						<div class="store-card-balance">
							<span class="balance-icon">üíé</span>
							<span class="balance-value token-value">@GetBossTokens().ToString("N0")</span>
						</div>
						<div class="store-card-cta boss-cta">Enter Store</div>
					</div>
				</button>
			</div>
		</div>
	}
	else if (shopView == "gold")
	{
		<!-- GOLD SHOP -->
		<div class="shop-header">
			<div class="header-left">
				<div class="shop-title">Gold Shop</div>
				<div class="shop-subtitle">Purchase supplies and boosts for your journey</div>
			</div>
		</div>

		<!-- Category Filter -->
		<div class="shop-filters">
			<button class="back-to-landing-btn" onclick=@BackToLanding>
				<span class="back-arrow">‚Üê</span>
				<span>All Stores</span>
			</button>
			<div class="dropdown-container">
				<button class="dropdown-btn shop-category-btn @(currentCategory != "all" ? "active" : "")" onclick=@ToggleCategoryDropdown>
					<span class="dropdown-icon">@GetCategoryIcon(currentCategory)</span>
					<span class="dropdown-label">@GetCategoryLabel(currentCategory)</span>
					<span class="dropdown-arrow @(categoryDropdownOpen ? "open" : "")">‚ñº</span>
				</button>
				@if (categoryDropdownOpen)
				{
					<div class="dropdown-menu">
						<div class="dropdown-item @(currentCategory == "all" ? "active" : "")" onclick=@(() => SelectCategory("all"))>
							<span class="dd-icon">‚óã</span>
							<span class="dd-label">All Items</span>
						</div>
						<div class="dropdown-item @(currentCategory == "supplies" ? "active" : "")" onclick=@(() => SelectCategory("supplies"))>
							<span class="dd-icon">üìù</span>
							<span class="dd-label">Supplies</span>
						</div>
						<div class="dropdown-item @(currentCategory == "boosts" ? "active" : "")" onclick=@(() => SelectCategory("boosts"))>
							<span class="dd-icon">üéÅ</span>
							<span class="dd-label">Boosts</span>
						</div>
						<div class="dropdown-item @(currentCategory == "storage" ? "active" : "")" onclick=@(() => SelectCategory("storage"))>
							<span class="dd-icon">üì¶</span>
							<span class="dd-label">Storage</span>
						</div>
					</div>
				}
			</div>
			<div class="filter-spacer"></div>
			<div class="currency-display @(IsGoldFlash ? "currency-flash" : "")">
				<span class="gold-icon">ü™ô</span>
				<span class="gold-value">@GetGold().ToString("N0")</span>
			</div>
		</div>

		<!-- Active Boosts Banner -->
		@{
			var activeBoosts = GetActiveBoosts();
		}
		@if (activeBoosts.Count > 0)
		{
			<div class="active-boosts-bar">
				<span class="boosts-label">Active</span>
				@foreach (var boost in activeBoosts)
				{
					<div class="boost-pill">
						<span class="boost-pill-icon">@GetBoostIcon(boost.Type)</span>
						<span class="boost-pill-name">@GetBoostName(boost.Type)</span>
						<span class="boost-pill-time">@GetRemainingTime(boost)</span>
					</div>
				}
			</div>
		}

		<div class="shop-layout">
			<!-- Left Side: Items -->
			<div class="shop-left">
				<div class="items-grid">
					@foreach (var item in GetFilteredItems())
					{
						<div class="shop-item @GetItemTypeClass(item.Type) @(CanAfford(item) ? "" : "cant-afford") @(selectedItem?.Id == item.Id ? "selected" : "")"
							 onclick=@(() => SelectItem(item))>
							<div class="item-type-badge @GetItemTypeClass(item.Type)">@GetItemCategory(item.Type)</div>
							<div class="item-icon-container">
								<span class="item-emoji">@GetItemEmoji(item.Type)</span>
								@if (item.Quantity > 1)
								{
									<span class="item-quantity">x@(item.Quantity)</span>
								}
							</div>
							<div class="item-info">
								<div class="item-name">@item.Name</div>
								<div class="item-price gold">
									<span class="gold-icon">ü™ô</span>
									<span>@item.Price.ToString("N0")</span>
								</div>
							</div>
							@if (item.RequiredLevel > GetLevel())
							{
								<div class="level-lock">LV @item.RequiredLevel</div>
							}
						</div>
					}
				</div>
			</div>

			<!-- Right Side: Detail Panel -->
			<div class="shop-right">
				@if (selectedItem != null)
				{
					<div class="item-detail">
						<div class="detail-accent @GetItemTypeClass(selectedItem.Type)"></div>
						<div class="detail-header">
							<span class="detail-emoji">@GetItemEmoji(selectedItem.Type)</span>
							<div class="detail-info">
								<div class="detail-name">@selectedItem.Name</div>
								<div class="detail-category-tag @GetItemTypeClass(selectedItem.Type)">@GetItemCategory(selectedItem.Type)</div>
								@if (selectedItem.Quantity > 1)
								{
									<div class="detail-quantity">x@(selectedItem.Quantity)</div>
								}
							</div>
						</div>
						<div class="detail-description">
							<label class="description-text">@selectedItem.Description</label>
						</div>
						@if (selectedItem.BoostDurationMinutes > 0)
						{
							<div class="detail-duration">Duration: @GetDurationText(selectedItem.BoostDurationMinutes)</div>
						}
						@if (selectedItem.RequiredLevel > 1)
						{
							<div class="detail-level @(GetLevel() >= selectedItem.RequiredLevel ? "" : "locked")">
								Requires Level @selectedItem.RequiredLevel
							</div>
						}
						<div class="detail-footer">
							<div class="detail-price gold">
								<span class="gold-icon">ü™ô</span>
								<span>@selectedItem.Price.ToString("N0")</span>
							</div>
							<button class="buy-btn @(IsPurchaseFlash ? "purchased" : "") @(CanPurchase(selectedItem) ? "" : "disabled")"
									onclick=@(() => PurchaseItem(selectedItem))>
								@if (IsPurchaseFlash)
								{
									<span>Purchased!</span>
								}
								else if (!CanAfford(selectedItem))
								{
									<span>Not Enough</span>
								}
								else if (GetLevel() < selectedItem.RequiredLevel)
								{
									<span>Level Locked</span>
								}
								else
								{
									<span>Purchase</span>
								}
							</button>
						</div>
					</div>
				}
				else
				{
					<div class="no-selection">
						@if (activeBoosts.Count > 0)
						{
							<span class="no-selection-icon">‚ö°</span>
							<span class="no-selection-text">@activeBoosts.Count boost@(activeBoosts.Count > 1 ? "s" : "") active</span>
							<span class="no-selection-hint">Select an item to purchase</span>
						}
						else
						{
							<span class="no-selection-icon">üõí</span>
							<span class="no-selection-text">Select an item</span>
							<span class="no-selection-hint">Browse items on the left</span>
						}
					</div>
				}
			</div>
		</div>
	}
	else
	{
		<!-- BOSS SHOP -->
		<div class="shop-header boss-header">
			<div class="header-left">
				<div class="shop-title">Boss Shop</div>
				<div class="shop-subtitle">Spend tokens earned from defeating bosses</div>
			</div>
		</div>

		<!-- Boss Shop Category Filter -->
		<div class="shop-filters">
			<button class="back-to-landing-btn" onclick=@BackToLanding>
				<span class="back-arrow">‚Üê</span>
				<span>All Stores</span>
			</button>
			<div class="dropdown-container">
				<button class="dropdown-btn shop-category-btn @(bossCategory != "all" ? "active" : "")" onclick=@ToggleBossCategoryDropdown>
					<span class="dropdown-icon">@GetBossCategoryIcon(bossCategory)</span>
					<span class="dropdown-label">@GetBossCategoryLabel(bossCategory)</span>
					<span class="dropdown-arrow @(bossCategoryDropdownOpen ? "open" : "")">‚ñº</span>
				</button>
				@if (bossCategoryDropdownOpen)
				{
					<div class="dropdown-menu">
						<div class="dropdown-item @(bossCategory == "all" ? "active" : "")" onclick=@(() => SelectBossCategory("all"))>
							<span class="dd-icon">‚óã</span>
							<span class="dd-label">All Items</span>
						</div>
						<div class="dropdown-item @(bossCategory == "themes" ? "active" : "")" onclick=@(() => SelectBossCategory("themes"))>
							<span class="dd-icon">üé®</span>
							<span class="dd-label">Themes</span>
						</div>
						<div class="dropdown-item @(bossCategory == "titles" ? "active" : "")" onclick=@(() => SelectBossCategory("titles"))>
							<span class="dd-icon">üè∑</span>
							<span class="dd-label">Titles</span>
						</div>
						<div class="dropdown-item @(bossCategory == "consumables" ? "active" : "")" onclick=@(() => SelectBossCategory("consumables"))>
							<span class="dd-icon">‚öó</span>
							<span class="dd-label">Items</span>
						</div>
					</div>
				}
			</div>
			<div class="filter-spacer"></div>
			<div class="currency-display boss-currency @(IsTokenFlash ? "currency-flash" : "")">
				<span class="token-icon">üíé</span>
				<span class="token-value">@GetBossTokens().ToString("N0")</span>
			</div>
		</div>

		<div class="shop-layout">
			<!-- Left Side: Boss Items -->
			<div class="shop-left">
				<div class="items-grid">
					@if (bossCategory == "all" || bossCategory == "themes")
					{
						@foreach (var theme in CosmeticDatabase.Themes)
						{
							bool owned = HasTheme(theme.Id);
							bool canAfford = GetBossTokens() >= theme.TokenCost;
							bool meetsRequirement = MeetsBossRequirement(theme.RequiredBossId);
							bool isActive = GetActiveTheme() == theme.Id;

							<div class="shop-item boss-item boss-type-theme @(owned ? "owned" : "") @(!canAfford && !owned ? "cant-afford" : "") @(selectedTheme?.Id == theme.Id ? "selected" : "")"
								 onclick=@(() => SelectTheme(theme))>
								<div class="item-type-badge boss-type-theme">Theme</div>
								<div class="theme-preview">
									<div class="theme-color primary" style="background-color: @theme.PrimaryColor;"></div>
									<div class="theme-color secondary" style="background-color: @theme.SecondaryColor;"></div>
									<div class="theme-color accent" style="background-color: @theme.AccentColor;"></div>
								</div>
								<div class="item-info">
									<div class="item-name">@theme.Name</div>
									@if (owned)
									{
										<div class="owned-badge">@(isActive ? "ACTIVE" : "OWNED")</div>
									}
									else
									{
										<div class="item-price boss">
											<span class="token-icon">üíé</span>
											<span>@theme.TokenCost.ToString("N0")</span>
										</div>
									}
								</div>
								@if (!meetsRequirement && !owned)
								{
									<div class="boss-lock">Boss Required</div>
								}
							</div>
						}
					}
					@if (bossCategory == "all" || bossCategory == "titles")
					{
						@foreach (var title in CosmeticDatabase.Titles)
						{
							bool owned = HasTitle(title.Id);
							bool canAfford = GetBossTokens() >= title.TokenCost;
							bool meetsRequirement = MeetsBossRequirement(title.RequiredBossId);
							bool isActive = GetActiveTitle() == title.Id;

							<div class="shop-item boss-item boss-type-title @(owned ? "owned" : "") @(!canAfford && !owned ? "cant-afford" : "") @(selectedTitle?.Id == title.Id ? "selected" : "")"
								 onclick=@(() => SelectTitle(title))>
								<div class="item-type-badge boss-type-title">Title</div>
								<div class="title-preview" style="color: @title.TitleColor;">
									@title.Title
								</div>
								<div class="item-info">
									<div class="item-name">@title.Title</div>
									@if (owned)
									{
										<div class="owned-badge">@(isActive ? "ACTIVE" : "OWNED")</div>
									}
									else
									{
										<div class="item-price boss">
											<span class="token-icon">üíé</span>
											<span>@title.TokenCost.ToString("N0")</span>
										</div>
									}
								</div>
								@if (!meetsRequirement && !owned)
								{
									<div class="boss-lock">Boss Required</div>
								}
							</div>
						}
					}
					@if (bossCategory == "all" || bossCategory == "consumables")
					{
						@foreach (var item in consumables)
						{
							bool canAfford = GetBossTokens() >= item.Cost;

							<div class="shop-item boss-item boss-type-consumable @(!canAfford ? "cant-afford" : "") @(selectedConsumable?.Id == item.Id ? "selected" : "")"
								 onclick=@(() => SelectConsumable(item))>
								<div class="item-type-badge boss-type-consumable">Item</div>
								<div class="consumable-icon">@item.Icon</div>
								<div class="item-info">
									<div class="item-name">@item.Name</div>
									<div class="item-price boss">
										<span class="token-icon">üíé</span>
										<span>@item.Cost.ToString("N0")</span>
									</div>
								</div>
							</div>
						}
					}
				</div>
			</div>

			<!-- Right Side: Boss Item Detail -->
			<div class="shop-right">
				@if (selectedTheme != null)
				{
					<div class="item-detail boss-detail">
						<div class="detail-accent boss-type-theme"></div>
						<div class="detail-header">
							<div class="theme-preview-large">
								<div class="theme-color primary" style="background-color: @selectedTheme.PrimaryColor;"></div>
								<div class="theme-color secondary" style="background-color: @selectedTheme.SecondaryColor;"></div>
								<div class="theme-color accent" style="background-color: @selectedTheme.AccentColor;"></div>
							</div>
							<div class="detail-info">
								<div class="detail-name">@selectedTheme.Name</div>
								<div class="detail-category-tag boss-type-theme">Theme</div>
							</div>
						</div>
						<div class="detail-description">
							<label class="description-text">@selectedTheme.Description</label>
						</div>
						@if (!string.IsNullOrEmpty(selectedTheme.RequiredBossId))
						{
							<div class="detail-requirement @(MeetsBossRequirement(selectedTheme.RequiredBossId) ? "met" : "unmet")">
								Requires: Clear @GetBossName(selectedTheme.RequiredBossId)
							</div>
						}
						<div class="detail-footer">
							<div class="detail-price boss">
								<span class="token-icon">üíé</span>
								<span>@selectedTheme.TokenCost.ToString("N0")</span>
							</div>
							@if (HasTheme(selectedTheme.Id))
							{
								@if (GetActiveTheme() == selectedTheme.Id)
								{
									<button class="buy-btn active-btn">Active</button>
								}
								else
								{
									<button class="buy-btn equip-btn" onclick=@(() => EquipTheme(selectedTheme.Id))>Equip</button>
								}
							}
							else
							{
								<button class="buy-btn @(IsPurchaseFlash ? "purchased" : "") @(CanPurchaseTheme(selectedTheme) ? "" : "disabled")"
										onclick=@(() => PurchaseTheme(selectedTheme))>
									@if (IsPurchaseFlash)
									{
										<span>Purchased!</span>
									}
									else if (!MeetsBossRequirement(selectedTheme.RequiredBossId))
									{
										<span>Boss Locked</span>
									}
									else if (GetBossTokens() < selectedTheme.TokenCost)
									{
										<span>Not Enough</span>
									}
									else
									{
										<span>Purchase</span>
									}
								</button>
							}
						</div>
					</div>
				}
				else if (selectedTitle != null)
				{
					<div class="item-detail boss-detail">
						<div class="detail-accent boss-type-title"></div>
						<div class="detail-header">
							<div class="title-preview-large" style="color: @selectedTitle.TitleColor;">
								@selectedTitle.Title
							</div>
							<div class="detail-info">
								<div class="detail-name">@selectedTitle.Title</div>
								<div class="detail-category-tag boss-type-title">Title</div>
							</div>
						</div>
						<div class="detail-description">
							<label class="description-text">@selectedTitle.Description</label>
						</div>
						@if (!string.IsNullOrEmpty(selectedTitle.RequiredBossId))
						{
							<div class="detail-requirement @(MeetsBossRequirement(selectedTitle.RequiredBossId) ? "met" : "unmet")">
								Requires: Clear @GetBossName(selectedTitle.RequiredBossId)
							</div>
						}
						<div class="detail-footer">
							<div class="detail-price boss">
								<span class="token-icon">üíé</span>
								<span>@selectedTitle.TokenCost.ToString("N0")</span>
							</div>
							@if (HasTitle(selectedTitle.Id))
							{
								@if (GetActiveTitle() == selectedTitle.Id)
								{
									<button class="buy-btn active-btn">Active</button>
								}
								else
								{
									<button class="buy-btn equip-btn" onclick=@(() => EquipTitle(selectedTitle.Id))>Equip</button>
								}
							}
							else
							{
								<button class="buy-btn @(IsPurchaseFlash ? "purchased" : "") @(CanPurchaseTitle(selectedTitle) ? "" : "disabled")"
										onclick=@(() => PurchaseTitle(selectedTitle))>
									@if (IsPurchaseFlash)
									{
										<span>Purchased!</span>
									}
									else if (!MeetsBossRequirement(selectedTitle.RequiredBossId))
									{
										<span>Boss Locked</span>
									}
									else if (GetBossTokens() < selectedTitle.TokenCost)
									{
										<span>Not Enough</span>
									}
									else
									{
										<span>Purchase</span>
									}
								</button>
							}
						</div>
					</div>
				}
				else if (selectedConsumable != null)
				{
					<div class="item-detail boss-detail">
						<div class="detail-accent boss-type-consumable"></div>
						<div class="detail-header">
							<div class="consumable-icon-large">@selectedConsumable.Icon</div>
							<div class="detail-info">
								<div class="detail-name">@selectedConsumable.Name</div>
								<div class="detail-category-tag boss-type-consumable">Item</div>
							</div>
						</div>
						<div class="detail-description">
							<label class="description-text">@selectedConsumable.Description</label>
						</div>
						<div class="detail-footer">
							<div class="detail-price boss">
								<span class="token-icon">üíé</span>
								<span>@selectedConsumable.Cost.ToString("N0")</span>
							</div>
							<button class="buy-btn @(IsPurchaseFlash ? "purchased" : "") @(GetBossTokens() >= selectedConsumable.Cost ? "" : "disabled")"
									onclick=@(() => PurchaseConsumable(selectedConsumable))>
								@if (IsPurchaseFlash)
								{
									<span>Purchased!</span>
								}
								else if (GetBossTokens() < selectedConsumable.Cost)
								{
									<span>Not Enough</span>
								}
								else
								{
									<span>Purchase</span>
								}
							</button>
						</div>
					</div>
				}
				else
				{
					<div class="no-selection">
						<span class="no-selection-icon">üíé</span>
						<span class="no-selection-text">Select an item</span>
						<span class="no-selection-hint">Browse items on the left</span>
					</div>
				}
			</div>
		</div>
	}

	<!-- Monster Picker Overlay -->
	@if (showMonsterPicker)
	{
		<div class="monster-picker-overlay" onclick=@CloseMonsterPicker>
			<div class="picker-content" onclick=@StopPropagation>
				<div class="picker-header">
					<div class="picker-title">Select a Monster</div>
					<div class="picker-subtitle">Choose which monster to use @(pendingConsumable?.Name ?? "item") on</div>
					<button class="picker-close-btn" onclick=@CloseMonsterPicker>‚úï</button>
				</div>
				<div class="picker-monster-grid">
					@{
						var monsters = GetOwnedMonsters();
						for (int i = 0; i < monsters.Count; i++)
						{
							var monster = monsters[i];
							var species = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
							var delay = i * 0.03f;
							<div class="picker-monster-card" style="animation-delay: @(delay)s;" onclick=@(() => ApplyConsumableToMonster(monster))>
								<MonsterCard Monster=@monster IsCompact=@true AnimationFrame=@SpriteAnimator.GlobalFrame />
							</div>
						}
					}
				</div>
			</div>
		</div>
	}
</root>

@code {
	// Shop view state (landing, gold, or boss)
	private string shopView = "landing";

	// Gold shop state
	private string currentCategory = "all";
	private ShopItem selectedItem;

	// Boss shop state
	private string bossCategory = "all";
	private HudTheme selectedTheme;
	private TamerTitle selectedTitle;
	private BossConsumable selectedConsumable;

	// Category dropdown state
	private bool categoryDropdownOpen = false;
	private bool bossCategoryDropdownOpen = false;

	// Monster picker state
	private bool showMonsterPicker = false;
	private BossConsumable pendingConsumable = null;

	// Purchase feedback state (timestamp-based, no OnUpdate needed)
	private float purchaseFlashUntil = 0f;
	private float goldFlashUntil = 0f;
	private float tokenFlashUntil = 0f;
	private int lastGoldValue = -1;
	private int lastTokenValue = -1;

	private bool IsPurchaseFlash => RealTime.Now < purchaseFlashUntil;
	private bool IsGoldFlash => RealTime.Now < goldFlashUntil;
	private bool IsTokenFlash => RealTime.Now < tokenFlashUntil;

	private void TriggerPurchaseFlash()
	{
		purchaseFlashUntil = RealTime.Now + 0.8f;
	}

	/// <summary>
	/// Detect currency changes and trigger flash. Called from BuildHash since it runs every frame.
	/// </summary>
	private void CheckCurrencyFlash()
	{
		int currentGold = GetGold();
		int currentTokens = GetBossTokens();
		if ( lastGoldValue >= 0 && currentGold != lastGoldValue )
			goldFlashUntil = RealTime.Now + 0.6f;
		if ( lastTokenValue >= 0 && currentTokens != lastTokenValue )
			tokenFlashUntil = RealTime.Now + 0.6f;
		lastGoldValue = currentGold;
		lastTokenValue = currentTokens;
	}

	// Category dropdown helpers
	private void ToggleCategoryDropdown() { categoryDropdownOpen = !categoryDropdownOpen; }
	private void ToggleBossCategoryDropdown() { bossCategoryDropdownOpen = !bossCategoryDropdownOpen; }

	private void SelectCategory(string cat)
	{
		currentCategory = cat;
		categoryDropdownOpen = false;
		selectedItem = null;
	}

	private void SelectBossCategory(string cat)
	{
		bossCategory = cat;
		bossCategoryDropdownOpen = false;
		selectedTheme = null;
		selectedTitle = null;
		selectedConsumable = null;
	}

	private string GetCategoryIcon(string cat) => cat switch
	{
		"supplies" => "üìù",
		"boosts" => "üéÅ",
		"storage" => "üì¶",
		_ => "‚óã"
	};

	private string GetCategoryLabel(string cat) => cat switch
	{
		"supplies" => "Supplies",
		"boosts" => "Boosts",
		"storage" => "Storage",
		_ => "All Items"
	};

	private string GetBossCategoryIcon(string cat) => cat switch
	{
		"themes" => "üé®",
		"titles" => "üè∑",
		"consumables" => "‚öó",
		_ => "‚óã"
	};

	private string GetBossCategoryLabel(string cat) => cat switch
	{
		"themes" => "Themes",
		"titles" => "Titles",
		"consumables" => "Items",
		_ => "All Items"
	};

	// Gold shop helpers
	private int GetGold() => TamerManager.Instance?.CurrentTamer?.Gold ?? 0;
	private int GetGems() => TamerManager.Instance?.CurrentTamer?.Gems ?? 0;
	private int GetLevel() => TamerManager.Instance?.CurrentTamer?.Level ?? 1;

	// Boss shop helpers
	private int GetBossTokens() => TamerManager.Instance?.CurrentTamer?.BossTokens ?? 0;
	private string GetActiveTheme() => TamerManager.Instance?.CurrentTamer?.ActiveThemeId ?? "default";
	private string GetActiveTitle() => TamerManager.Instance?.CurrentTamer?.ActiveTitleId;
	private bool HasTheme(string id) => TamerManager.Instance?.HasTheme(id) ?? (id == "default");
	private bool HasTitle(string id) => TamerManager.Instance?.HasTitle(id) ?? false;
	private bool MeetsBossRequirement(string bossId) => string.IsNullOrEmpty(bossId) || (TamerManager.Instance?.HasClearedBoss(bossId) ?? false);

	private void SwitchShopView(string view)
	{
		shopView = view;
		selectedItem = null;
		selectedTheme = null;
		selectedTitle = null;
		selectedConsumable = null;
		SoundManager.PlayClick();
	}

	private void BackToLanding()
	{
		shopView = "landing";
		selectedItem = null;
		selectedTheme = null;
		selectedTitle = null;
		selectedConsumable = null;
		SoundManager.PlayBack();
	}

	private List<ShopItem> GetFilteredItems()
	{
		var items = ShopManager.Instance?.GetAvailableItems(100) ?? new List<ShopItem>();
		items = items.Where(i => i.Currency == CurrencyType.Gold).ToList();

		return currentCategory switch
		{
			"supplies" => items.Where(i => i.Type == ShopItemType.ContractInk).ToList(),
			"boosts" => items.Where(i => i.Type == ShopItemType.XPBoost || i.Type == ShopItemType.GoldBoost || i.Type == ShopItemType.RareEncounter).ToList(),
			"storage" => items.Where(i => i.Type == ShopItemType.MonsterSlot).ToList(),
			_ => items
		};
	}

	private List<ActiveBoost> GetActiveBoosts()
	{
		return ShopManager.Instance?.ActiveBoosts?.Where(b => !b.IsExpired).ToList() ?? new List<ActiveBoost>();
	}

	private bool CanAfford(ShopItem item) => GetGold() >= item.Price;

	private bool CanPurchase(ShopItem item) => CanAfford(item) && GetLevel() >= item.RequiredLevel && item.IsInStock;

	private void SelectItem(ShopItem item)
	{
		selectedItem = item;
		SoundManager.PlayClick();
	}

	private void PurchaseItem(ShopItem item)
	{
		if (!CanPurchase(item)) return;

		if (ShopManager.Instance?.PurchaseItem(item.Id) == true)
		{
			TriggerPurchaseFlash();
			SoundManager.PlayForward();
		}
		else
			SoundManager.PlayBack();
	}

	private string GetDurationText(int minutes)
	{
		if (minutes >= 60)
		{
			int hours = minutes / 60;
			int mins = minutes % 60;
			return mins > 0 ? $"{hours}h {mins}m" : $"{hours} hour{(hours > 1 ? "s" : "")}";
		}
		return $"{minutes} minutes";
	}

	private string GetBoostName(ShopItemType type)
	{
		return type switch
		{
			ShopItemType.XPBoost => "2x XP",
			ShopItemType.TamerXPBoost => "2x Tamer XP",
			ShopItemType.BeastXPBoost => "2x Beast XP",
			ShopItemType.GoldBoost => "1.5x Gold",
			ShopItemType.RareEncounter or ShopItemType.LuckyCharm => "Lucky Charm",
			_ => type.ToString()
		};
	}

	private string GetItemTypeClass(ShopItemType type) => type switch
	{
		ShopItemType.ContractInk => "type-supply",
		ShopItemType.XPBoost or ShopItemType.TamerXPBoost or ShopItemType.BeastXPBoost
			or ShopItemType.GoldBoost or ShopItemType.RareEncounter or ShopItemType.LuckyCharm => "type-boost",
		ShopItemType.MonsterSlot => "type-storage",
		_ => "type-misc"
	};

	private string GetItemCategory(ShopItemType type) => type switch
	{
		ShopItemType.ContractInk => "Supply",
		ShopItemType.XPBoost or ShopItemType.TamerXPBoost or ShopItemType.BeastXPBoost
			or ShopItemType.GoldBoost or ShopItemType.RareEncounter or ShopItemType.LuckyCharm => "Boost",
		ShopItemType.MonsterSlot => "Storage",
		_ => "Item"
	};

	private string GetBoostIcon(ShopItemType type) => type switch
	{
		ShopItemType.XPBoost or ShopItemType.TamerXPBoost or ShopItemType.BeastXPBoost => "‚ö°",
		ShopItemType.GoldBoost => "üí∞",
		ShopItemType.RareEncounter or ShopItemType.LuckyCharm => "üçÄ",
		_ => "‚ú®"
	};

	private string GetRemainingTime(ActiveBoost boost)
	{
		var remaining = boost.TimeRemaining;
		if (remaining.TotalHours >= 1)
			return $"{(int)remaining.TotalHours}h {remaining.Minutes}m";
		if (remaining.TotalMinutes >= 1)
			return $"{(int)remaining.TotalMinutes}m";
		return "<1m";
	}

	private string GetItemEmoji(ShopItemType type)
	{
		return type switch
		{
			ShopItemType.ContractInk => "üñãÔ∏è",
			ShopItemType.Revive => "üíä",
			ShopItemType.XPBoost => "‚ö°",
			ShopItemType.GoldBoost => "üí∞",
			ShopItemType.RareEncounter => "üçÄ",
			ShopItemType.MonsterSlot => "üì¶",
			ShopItemType.SkillReset => "üîÑ",
			ShopItemType.PartySlot => "üë•",
			ShopItemType.StatBoost => "üí™",
			ShopItemType.NameChange => "‚úèÔ∏è",
			ShopItemType.ElementOrb => "üîÆ",
			_ => "üéÅ"
		};
	}

	// Boss shop selection methods
	private void SelectTheme(HudTheme theme)
	{
		selectedTheme = theme;
		selectedTitle = null;
		selectedConsumable = null;
		SoundManager.PlayClick();
	}

	private void SelectTitle(TamerTitle title)
	{
		selectedTheme = null;
		selectedTitle = title;
		selectedConsumable = null;
		SoundManager.PlayClick();
	}

	private void SelectConsumable(BossConsumable item)
	{
		selectedTheme = null;
		selectedTitle = null;
		selectedConsumable = item;
		SoundManager.PlayClick();
	}

	private bool CanPurchaseTheme(HudTheme theme)
	{
		return !HasTheme(theme.Id) &&
			   GetBossTokens() >= theme.TokenCost &&
			   MeetsBossRequirement(theme.RequiredBossId);
	}

	private bool CanPurchaseTitle(TamerTitle title)
	{
		return !HasTitle(title.Id) &&
			   GetBossTokens() >= title.TokenCost &&
			   MeetsBossRequirement(title.RequiredBossId);
	}

	private void PurchaseTheme(HudTheme theme)
	{
		if (!CanPurchaseTheme(theme)) return;

		if (TamerManager.Instance?.SpendBossTokens(theme.TokenCost) == true)
		{
			TamerManager.Instance?.UnlockTheme(theme.Id);
			TriggerPurchaseFlash();
			SoundManager.PlayForward();
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	private void PurchaseTitle(TamerTitle title)
	{
		if (!CanPurchaseTitle(title)) return;

		if (TamerManager.Instance?.SpendBossTokens(title.TokenCost) == true)
		{
			TamerManager.Instance?.UnlockTitle(title.Id);
			TriggerPurchaseFlash();
			SoundManager.PlayForward();
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	private void EquipTheme(string themeId)
	{
		TamerManager.Instance?.SetActiveTheme(themeId);
		SoundManager.PlayForward();
	}

	private void EquipTitle(string titleId)
	{
		TamerManager.Instance?.SetActiveTitle(titleId);
		SoundManager.PlayForward();
	}

	private string GetBossName(string bossId)
	{
		return bossId switch
		{
			"shadow_depths" => "Shadow Depths",
			"dawn_sanctuary" => "Spirit Sanctum",
			"elemental_nexus" => "Elemental Nexus",
			"mythweavers_realm" => "Mythweaver's Realm",
			"origin_void" => "Origin Void",
			_ => bossId?.Replace("_", " ") ?? "Unknown"
		};
	}

	// Boss consumables data (updated prices + new items)
	private List<BossConsumable> consumables = new()
	{
		// Existing items (price increases)
		new BossConsumable { Id = "xp_orb_small", Name = "XP Orb (Small)", Description = "Grants 500 XP to one monster", Icon = "üîÆ", Cost = 100, Type = "monster-target" },
		new BossConsumable { Id = "xp_orb_large", Name = "XP Orb (Large)", Description = "Grants 2000 XP to one monster", Icon = "üîÆ", Cost = 300, Type = "monster-target" },
		new BossConsumable { Id = "elite_ink", Name = "Elite Contract Ink", Description = "+15% catch rate for 10 minutes", Icon = "‚ú®", Cost = 200, Type = "instant" },
		new BossConsumable { Id = "contract_ink_bundle", Name = "Contract Ink x5", Description = "5 Contract Ink for capturing monsters", Icon = "üñãÔ∏è", Cost = 150, Type = "instant" },

		// New items
		new BossConsumable { Id = "trait_reroll", Name = "Trait Reroll", Description = "Randomly rerolls one of a monster's traits from its species pool", Icon = "üé≤", Cost = 500, Type = "trait-reroll" },
		new BossConsumable { Id = "gene_booster", Name = "Gene Booster", Description = "Increases a random gene (IV) by +5, max 30", Icon = "üß¨", Cost = 600, Type = "gene-booster" },
		new BossConsumable { Id = "master_ink", Name = "Master Ink", Description = "Guarantees your next capture attempt succeeds", Icon = "üñäÔ∏è", Cost = 800, Type = "master-ink" },

		// Nature Runes
		new BossConsumable { Id = "rune_ferocious", Name = "Ferocious Rune", Description = "Sets nature to Ferocious (+10% ATK, -10% DEF)", Icon = "üî¥", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Ferocious },
		new BossConsumable { Id = "rune_stalwart", Name = "Stalwart Rune", Description = "Sets nature to Stalwart (+10% DEF, -10% ATK)", Icon = "üîµ", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Stalwart },
		new BossConsumable { Id = "rune_restless", Name = "Restless Rune", Description = "Sets nature to Restless (+10% SPD, -10% HP)", Icon = "üü¢", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Restless },
		new BossConsumable { Id = "rune_enduring", Name = "Enduring Rune", Description = "Sets nature to Enduring (+10% HP, -10% SPD)", Icon = "üü§", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Enduring },
		new BossConsumable { Id = "rune_reckless", Name = "Reckless Rune", Description = "Sets nature to Reckless (+10% ATK, -10% SPD)", Icon = "üü†", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Reckless },
		new BossConsumable { Id = "rune_stoic", Name = "Stoic Rune", Description = "Sets nature to Stoic (+10% DEF, -10% SPD)", Icon = "‚ö™", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Stoic },
		new BossConsumable { Id = "rune_skittish", Name = "Skittish Rune", Description = "Sets nature to Skittish (+10% SPD, -10% DEF)", Icon = "üî∑", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Skittish },
		new BossConsumable { Id = "rune_vigorous", Name = "Vigorous Rune", Description = "Sets nature to Vigorous (+10% HP, -10% ATK)", Icon = "üçÄ", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Vigorous },
		new BossConsumable { Id = "rune_ruthless", Name = "Ruthless Rune", Description = "Sets nature to Ruthless (+10% ATK, -10% HP)", Icon = "üî∫", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Ruthless },
		new BossConsumable { Id = "rune_nimble", Name = "Nimble Rune", Description = "Sets nature to Nimble (+10% SPD, -10% ATK)", Icon = "ü™∂", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Nimble },
		new BossConsumable { Id = "rune_mystical", Name = "Mystical Rune", Description = "Sets nature to Mystical (+10% SpA, -10% ATK)", Icon = "üü£", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Mystical },
		new BossConsumable { Id = "rune_resolute", Name = "Resolute Rune", Description = "Sets nature to Resolute (+10% SpD, -10% SpA)", Icon = "üü°", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Resolute },
		new BossConsumable { Id = "rune_arcane", Name = "Arcane Rune", Description = "Sets nature to Arcane (+10% SpA, -10% DEF)", Icon = "üíú", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Arcane },
		new BossConsumable { Id = "rune_warded", Name = "Warded Rune", Description = "Sets nature to Warded (+10% SpD, -10% SPD)", Icon = "üü°", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Warded },
		new BossConsumable { Id = "rune_cunning", Name = "Cunning Rune", Description = "Sets nature to Cunning (+10% SpA, -10% HP)", Icon = "üîÆ", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Cunning },
		new BossConsumable { Id = "rune_serene", Name = "Serene Rune", Description = "Sets nature to Serene (+10% SpD, -10% ATK)", Icon = "üå∏", Cost = 400, Type = "nature-rune", TargetNature = NatureType.Serene },
	};

	private void PurchaseConsumable(BossConsumable item)
	{
		if (GetBossTokens() < item.Cost) return;

		// Items that need monster selection
		if (item.Type == "nature-rune" || item.Type == "trait-reroll" || item.Type == "gene-booster" || item.Type == "monster-target")
		{
			pendingConsumable = item;
			showMonsterPicker = true;
			SoundManager.PlayForward();
			return;
		}

		// Instant items
		if (TamerManager.Instance?.SpendBossTokens(item.Cost) == true)
		{
			switch (item.Id)
			{
				case "contract_ink_bundle":
					if (TamerManager.Instance?.CurrentTamer != null)
						TamerManager.Instance.CurrentTamer.ContractInk += 5;
					break;
				case "elite_ink":
					if (TamerManager.Instance?.CurrentTamer != null)
					{
						var tamer = TamerManager.Instance.CurrentTamer;
						var currentExpiry = tamer.EliteInkExpiresAt > DateTime.Now ? tamer.EliteInkExpiresAt : DateTime.Now;
						tamer.EliteInkExpiresAt = currentExpiry.AddMinutes(10);
					}
					break;
				case "master_ink":
					if (TamerManager.Instance?.CurrentTamer != null)
						TamerManager.Instance.CurrentTamer.HasMasterInk = true;
					break;
			}
			TamerManager.Instance?.SaveToCloud();
			TriggerPurchaseFlash();
			SoundManager.PlayForward();
		}
		else
		{
			SoundManager.PlayBack();
		}
	}

	// Monster picker methods
	private List<Monster> GetOwnedMonsters()
	{
		return MonsterManager.Instance?.OwnedMonsters?.ToList() ?? new List<Monster>();
	}

	private void CloseMonsterPicker()
	{
		showMonsterPicker = false;
		pendingConsumable = null;
		SoundManager.PlayBack();
	}

	private void StopPropagation()
	{
		// Prevents click from closing the overlay
	}

	private void ApplyConsumableToMonster(Monster monster)
	{
		if (pendingConsumable == null || monster == null) return;
		if (TamerManager.Instance?.SpendBossTokens(pendingConsumable.Cost) != true)
		{
			SoundManager.PlayBack();
			return;
		}

		var random = new Random();

		switch (pendingConsumable.Type)
		{
			case "nature-rune":
				if (pendingConsumable.TargetNature.HasValue)
				{
					monster.Genetics.Nature = pendingConsumable.TargetNature.Value;
					MonsterManager.Instance?.RecalculateStats(monster);
				}
				break;

			case "trait-reroll":
				var species = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
				if (species?.PossibleTraits != null && species.PossibleTraits.Count > 0 && monster.Traits.Count > 0)
				{
					// Find traits the monster doesn't already have
					var availableTraits = species.PossibleTraits.Where(t => !monster.Traits.Contains(t)).ToList();
					if (availableTraits.Count > 0)
					{
						// Replace a random trait slot with a random available trait
						int slotToReplace = random.Next(monster.Traits.Count);
						string newTrait = availableTraits[random.Next(availableTraits.Count)];
						monster.Traits[slotToReplace] = newTrait;
					}
				}
				break;

			case "gene-booster":
				// Pick a random gene and add +5 (max 30)
				int geneIndex = random.Next(6);
				switch (geneIndex)
				{
					case 0: monster.Genetics.HPGene = Math.Min(monster.Genetics.HPGene + 5, 30); break;
					case 1: monster.Genetics.ATKGene = Math.Min(monster.Genetics.ATKGene + 5, 30); break;
					case 2: monster.Genetics.DEFGene = Math.Min(monster.Genetics.DEFGene + 5, 30); break;
					case 3: monster.Genetics.SpAGene = Math.Min(monster.Genetics.SpAGene + 5, 30); break;
					case 4: monster.Genetics.SpDGene = Math.Min(monster.Genetics.SpDGene + 5, 30); break;
					case 5: monster.Genetics.SPDGene = Math.Min(monster.Genetics.SPDGene + 5, 30); break;
				}
				MonsterManager.Instance?.RecalculateStats(monster);
				break;

			case "monster-target":
				// XP orbs - apply XP to the selected monster
				int xpAmount = pendingConsumable.Id == "xp_orb_large" ? 2000 : 500;
				bool leveledUp = monster.AddXP(xpAmount);
				MonsterManager.Instance?.RecalculateStats(monster);

				if (leveledUp)
				{
					// Check for new moves learned at this level
					var learnedMoves = MonsterManager.Instance?.CheckAndLearnNewMoves(monster);
					if (learnedMoves != null)
					{
						foreach (var moveName in learnedMoves)
						{
							NotificationManager.Instance?.AddNotification(
								NotificationType.Success,
								"New Move Learned!",
								$"{monster.Nickname} learned {moveName}!"
							);
						}
					}

					// Check for evolution readiness
					var xpSpecies = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
					if (xpSpecies != null && monster.CanEvolve(xpSpecies) && !monster.HasBeenNotifiedForEvolution)
					{
						monster.HasBeenNotifiedForEvolution = true;
						var evolvedSpecies = MonsterManager.Instance?.GetSpecies(xpSpecies.EvolvesTo);
						NotificationManager.Instance?.NotifyEvolutionReady(
							monster.Nickname,
							evolvedSpecies?.Name ?? "???"
						);
					}
				}
				break;
		}

		MonsterManager.Instance?.SaveMonsters();
		SoundManager.PlayForward();

		showMonsterPicker = false;
		pendingConsumable = null;
	}

	// Helper classes
	public class BossConsumable
	{
		public string Id { get; set; }
		public string Name { get; set; }
		public string Description { get; set; }
		public string Icon { get; set; }
		public int Cost { get; set; }
		public string Type { get; set; } = "instant";
		public NatureType? TargetNature { get; set; }
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(shopView);
		hash.Add(currentCategory);
		hash.Add(bossCategory);
		hash.Add(selectedItem?.Id);
		hash.Add(selectedTheme?.Id);
		hash.Add(selectedTitle?.Id);
		hash.Add(selectedConsumable?.Id);
		hash.Add(GetGold());
		hash.Add(GetBossTokens());
		hash.Add(GetActiveBoosts().Count);
		hash.Add(GetActiveTheme());
		hash.Add(GetActiveTitle());
		hash.Add(showMonsterPicker);
		hash.Add(categoryDropdownOpen);
		hash.Add(bossCategoryDropdownOpen);
		hash.Add(pendingConsumable?.Id);
		hash.Add(SpriteAnimator.GlobalFrame);
		// Check for currency changes (triggers flash on purchase)
		CheckCurrencyFlash();
		hash.Add(IsPurchaseFlash);
		hash.Add(IsGoldFlash);
		hash.Add(IsTokenFlash);
		return hash.ToHashCode();
	}
}
