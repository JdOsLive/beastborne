@namespace Beastborne.UI.Panels
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@inherits Panel

<root class="@(IsVisible ? "visible" : "")">
	<div class="profile-overlay" onclick=@Close></div>

	<div class="profile-modal">
		<button class="close-btn" onclick=@Close>Ã—</button>
		<div class="profile-header">
			<div class="header-left">
				<div class="avatar-frame">
					<div class="avatar-portrait" style="background-image: url('@GetPortraitPath()')"></div>
				</div>
				<div class="header-info">
					<span class="tamer-name">@GetTamerName()</span>
					<span class="tamer-title">@GetTitle()</span>
				</div>
			</div>
		</div>

		<div class="profile-content">
			<!-- Level & Resources Row -->
			<div class="info-row">
				<div class="level-section">
					<span class="level-label">LEVEL</span>
					<div class="level-row">
						<span class="level-number">@GetLevel()</span>
						<div class="xp-container">
							<div class="xp-bar">
								<div class="xp-fill" style="width: @(GetXPProgress() * 100)%"></div>
							</div>
							<span class="xp-text">@GetCurrentLevelXP() / @GetXPForNextLevel() XP</span>
						</div>
					</div>
				</div>

				<div class="resources-section">
					<div class="resource">
						<span class="resource-icon-text">ðŸª™</span>
						<span class="resource-value gold">@GetGold().ToString("N0")</span>
					</div>
				</div>
			</div>

			<!-- Stats Section -->
			<div class="stats-section">
				<div class="stat-group">
					<span class="stat-group-title">ARENA</span>
					<div class="stat-row">
						<span class="stat rank">@GetArenaRank()</span>
						<span class="stat-detail">@GetArenaPoints() pts â€¢ @GetArenaWins()W/@GetArenaLosses()L</span>
					</div>
				</div>

				<div class="stat-group">
					<span class="stat-group-title">COLLECTION</span>
					<div class="stat-row">
						<span class="stat monsters">@GetOwnedMonsters()/@GetMaxMonsters()</span>
						<span class="stat-detail">Beasts</span>
						<span class="stat-separator">â€¢</span>
						<span class="stat discovered">@GetDiscoveredSpecies()/@GetTotalSpecies()</span>
						<span class="stat-detail">Discovered</span>
					</div>
				</div>

				<div class="stat-group">
					<span class="stat-group-title">PROGRESSION</span>
					<div class="stat-row">
						<span class="stat expedition">Stage @GetHighestExpedition()</span>
						<span class="stat-detail">Highest</span>
						<span class="stat-separator">â€¢</span>
						<span class="stat skills">@GetSkillsUnlocked()/@GetTotalSkills()</span>
						<span class="stat-detail">Skills</span>
					</div>
				</div>
			</div>

			<!-- Footer -->
			<div class="profile-footer">
				<span class="playtime">Playtime: @GetPlayTime()</span>
				<span class="created-date">Created: @GetCreatedDate()</span>
			</div>
		</div>
	</div>
</root>

@code {
	public static bool IsVisible { get; set; } = false;

	public static void Show() => IsVisible = true;
	public static void Close() => IsVisible = false;
	public static void Toggle() => IsVisible = !IsVisible;

	private Tamer GetTamer() => TamerManager.Instance?.CurrentTamer;

	private string GetTamerName() => GetTamer()?.Name ?? "Unknown Tamer";
	private int GetLevel() => GetTamer()?.Level ?? 1;
	private float GetXPProgress() => GetTamer()?.XPProgress ?? 0;
	private int GetCurrentLevelXP() => GetTamer()?.CurrentLevelXP ?? 0;
	private int GetXPForNextLevel() => GetTamer()?.XPForNextLevel ?? 100;

	private int GetGold() => GetTamer()?.Gold ?? 0;
	private int GetGems() => GetTamer()?.Gems ?? 0;
	private int GetContractInk() => GetTamer()?.ContractInk ?? 0;
	private int GetSkillPoints() => GetTamer()?.SkillPoints ?? 0;

	private int GetBattlesWon() => GetTamer()?.TotalBattlesWon ?? 0;
	private int GetBattlesLost() => GetTamer()?.TotalBattlesLost ?? 0;
	private int GetWinRate() => (int)((GetTamer()?.WinRate ?? 0) * 100);

	private string GetArenaRank() => GetTamer()?.ArenaRank ?? "Unranked";
	private int GetArenaPoints() => GetTamer()?.ArenaPoints ?? 0;
	private int GetArenaWins() => GetTamer()?.ArenaWins ?? 0;
	private int GetArenaLosses() => GetTamer()?.ArenaLosses ?? 0;

	private int GetMonstersCaught() => GetTamer()?.TotalMonstersCaught ?? 0;
	private int GetMonstersBred() => GetTamer()?.TotalMonstersBred ?? 0;
	private int GetOwnedMonsters() => MonsterManager.Instance?.OwnedMonsters?.Count ?? 0;
	private int GetMaxMonsters() => MonsterManager.Instance?.MaxMonsters ?? 50;

	private int GetDiscoveredSpecies() => BeastiaryManager.Instance?.GetDiscoveryCount() ?? 0;
	private int GetTotalSpecies() => BeastiaryManager.Instance?.GetTotalSpeciesCount() ?? 1;

	private int GetHighestExpedition() => GetTamer()?.HighestExpeditionCleared ?? 0;
	private int GetSkillsUnlocked() => GetTamer()?.UnlockedSkills?.Count ?? 0;
	private int GetTotalSkills() => TamerManager.Instance?.GetTotalSkillCount() ?? 20;

	private string GetPortraitPath() => GetTamer()?.Gender == TamerGender.Female
		? "ui/characters/female/female_tamer.png"
		: "ui/characters/male/male_tamer.png";

	private string GetTitle()
	{
		var level = GetLevel();
		if ( level >= 80 ) return "Legendary Tamer";
		if ( level >= 60 ) return "Master Tamer";
		if ( level >= 40 ) return "Expert Tamer";
		if ( level >= 20 ) return "Skilled Tamer";
		if ( level >= 10 ) return "Apprentice Tamer";
		return "Novice Tamer";
	}

	private string GetPlayTime()
	{
		var time = GetTamer()?.TotalPlayTime ?? TimeSpan.Zero;
		if ( time.TotalDays >= 1 )
			return $"{(int)time.TotalDays}d {time.Hours}h";
		if ( time.TotalHours >= 1 )
			return $"{(int)time.TotalHours}h {time.Minutes}m";
		return $"{time.Minutes}m";
	}

	private string GetLastLogin()
	{
		var date = GetTamer()?.LastLogin ?? DateTime.UtcNow;
		var diff = DateTime.UtcNow - date;
		if ( diff.TotalMinutes < 5 ) return "Just now";
		if ( diff.TotalHours < 1 ) return $"{(int)diff.TotalMinutes}m ago";
		if ( diff.TotalDays < 1 ) return $"{(int)diff.TotalHours}h ago";
		return date.ToString( "MMM d" );
	}

	private string GetCreatedDate()
	{
		var date = GetTamer()?.CreatedAt ?? DateTime.UtcNow;
		return date.ToString( "MMM d, yyyy" );
	}

	public override void Tick()
	{
		base.Tick();
		if ( IsVisible && Input.Pressed( "Escape" ) )
			Close();
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add( IsVisible );
		hash.Add( GetLevel() );
		hash.Add( GetGold() );
		hash.Add( GetBattlesWon() );
		hash.Add( GetArenaPoints() );
		hash.Add( GetOwnedMonsters() );
		return hash.ToHashCode();
	}
}
