@namespace Beastborne.UI.Panels
@using Sandbox;
@using Sandbox.UI;
@using Beastborne.Core;
@using Beastborne.Data;
@using Beastborne.Systems;
@using Beastborne.UI.Components;
@using System.Linq;
@using System.Collections.Generic;
@inherits Panel

<div class="expedition-panel @(currentView == "team" ? "team-view" : "") @(currentView == "battle" ? "battle-mode" : "") @GetExpeditionBackgroundClass()" onclick=@OnPanelClicked>
	@if (currentView == "list")
	{
		<!-- Expedition List View -->
		<div class="panel-header">
			<div class="header-text">
				<div class="panel-title">Expeditions</div>
				<div class="panel-subtitle">Select an expedition to begin your journey</div>
			</div>
		</div>

		<!-- Controls Row (below header, like other panels) -->
		<div class="expedition-controls">
			<!-- Difficulty Dropdown -->
			<div class="dropdown-container">
				<button class="dropdown-btn @(hardModeEnabled ? "hard-active" : "")" onclick=@ToggleDifficultyDropdown>
					<span class="dropdown-icon">@(hardModeEnabled ? "üíÄ" : "‚öî")</span>
					<span class="dropdown-label">@(hardModeEnabled ? "Hard" : "Normal")</span>
					<span class="dropdown-arrow @(difficultyDropdownOpen ? "open" : "")">‚ñº</span>
				</button>
				@if (difficultyDropdownOpen)
				{
					<div class="dropdown-menu">
						<div class="dropdown-item @(hardModeEnabled == false ? "active" : "")" onclick=@(() => SelectDifficulty(false))>
							<span class="item-icon">‚öî</span>
							<span class="item-label">Normal</span>
						</div>
						<div class="dropdown-item hard @(hardModeEnabled ? "active" : "") @(IsHardModeUnlocked() ? "" : "locked")" onclick=@(() => SelectDifficulty(true))>
							@if (!IsHardModeUnlocked())
							{
								<span class="item-icon">üîí</span>
							}
							else
							{
								<span class="item-icon">üíÄ</span>
							}
							<span class="item-label">Hard</span>
							@if (!IsHardModeUnlocked())
							{
								<span class="item-hint">Unlock Cartographer</span>
							}
							else
							{
								<span class="item-hint">+10 Levels, +50% Rewards</span>
							}
						</div>
					</div>
				}
			</div>

			<div class="auto-toggles">
				<div class="auto-battle-toggle @(autoRetry ? "active" : "")" onclick=@ToggleAutoRetry>
					<div class="toggle-slider"></div>
					<span class="toggle-label">Auto Retry</span>
				</div>
				<div class="auto-battle-toggle @(autoBattle ? "active" : "")" onclick=@ToggleAutoBattle>
					<div class="toggle-slider"></div>
					<span class="toggle-label">Auto Battle</span>
				</div>
			</div>

			<!-- Auto Contract Dropdown -->
			<div class="dropdown-container">
				<button class="dropdown-btn @(autoNegotiate ? "active" : "")" onclick=@ToggleCatchDropdown>
					<span class="dropdown-label">Auto Contract</span>
					<span class="dropdown-value @(autoNegotiate ? "enabled" : "")">@GetCatchStrategyLabel()</span>
					<span class="dropdown-arrow @(catchDropdownOpen ? "open" : "")">‚ñº</span>
				</button>
				@if (catchDropdownOpen)
				{
					<div class="dropdown-menu catch-menu">
						<div class="dropdown-item @(!autoNegotiate ? "active" : "")" onclick=@(() => SelectCatchStrategy(-2))>
							<span class="item-icon">‚úó</span>
							<span class="item-label">Off</span>
						</div>
						<div class="dropdown-divider"></div>
						<div class="dropdown-item @(autoNegotiate && autoNegotiateStrategy == -1 ? "active" : "")" onclick=@(() => SelectCatchStrategy(-1))>
							<span class="item-icon">‚è≠</span>
							<span class="item-label">Skip</span>
						</div>
						<div class="dropdown-item @(autoNegotiate && autoNegotiateStrategy == 0 ? "active" : "")" onclick=@(() => SelectCatchStrategy(0))>
							<span class="item-icon">üíù</span>
							<span class="item-label">Generous</span>
							<span class="item-cost">3üñãÔ∏è</span>
						</div>
						<div class="dropdown-item @(autoNegotiate && autoNegotiateStrategy == 1 ? "active" : "")" onclick=@(() => SelectCatchStrategy(1))>
							<span class="item-icon">ü§ù</span>
							<span class="item-label">Fair</span>
							<span class="item-cost">2üñãÔ∏è</span>
						</div>
						<div class="dropdown-item @(autoNegotiate && autoNegotiateStrategy == 2 ? "active" : "")" onclick=@(() => SelectCatchStrategy(2))>
							<span class="item-icon">üìã</span>
							<span class="item-label">Strict</span>
							<span class="item-cost">1üñãÔ∏è</span>
						</div>
						<div class="dropdown-item @(autoNegotiate && autoNegotiateStrategy == 3 ? "active" : "")" onclick=@(() => SelectCatchStrategy(3))>
							<span class="item-icon">üí∞</span>
							<span class="item-label">Golden</span>
							<span class="item-cost">2üñãÔ∏è+üí∞</span>
						</div>
						<div class="dropdown-divider"></div>
						<div class="dropdown-item" onclick=@OpenContractTargetSearch>
							<span class="item-icon">üéØ</span>
							<span class="item-label">@(autoContractTargetSpecies != null ? "Change Target..." : "Target Beast...")</span>
						</div>
						@if (autoContractTargetSpecies != null)
						{
							<div class="dropdown-item" onclick=@ClearContractTarget>
								<span class="item-icon">‚úó</span>
								<span class="item-label">Clear Target</span>
							</div>
						}
					</div>
				}
			</div>
		</div>

		<div class="expedition-grid">
			@foreach (var expedition in GetExpeditions())
			{
				var isLocked = !CanStartExpedition(expedition);
				var isCleared = IsCleared(expedition);
				<div class="expedition-card @(isLocked ? "locked" : "") @(isCleared ? "cleared" : "") @(selectedExpedition?.Id == expedition.Id ? "selected" : "") @GetBackgroundClass(expedition) @(!hasAnimatedCards ? "animate-entrance" : "")"
					 onclick=@(() => SelectExpedition(expedition))>

					@if (!string.IsNullOrEmpty(GetBackgroundClass(expedition)))
					{
						<div class="card-gradient-overlay"></div>
					}

					<div class="card-element @expedition.Element.ToString().ToLower()">
						<span class="element-icon">@GetElementIcon(expedition.Element)</span>
					</div>

					<div class="card-body">
						<div class="card-title">@expedition.Name</div>
						<div class="card-desc">@expedition.Description</div>

						<div class="card-stats">
							<div class="stat-badge">
								<span class="stat-icon">‚öî</span>
								<span class="stat-value">@expedition.Waves Waves</span>
							</div>
							<div class="stat-badge @(hardModeEnabled ? "hard-mode" : "")">
								<span class="stat-icon">üìä</span>
								<span class="stat-value">Lv.@GetDisplayLevel(expedition)+</span>
							</div>
						</div>

						<div class="card-rewards">
							<div class="reward-badge gold @(hardModeEnabled ? "boosted" : "")">
								<span>üí∞</span>
								<span>@GetDisplayGold(expedition)</span>
							</div>
							<div class="reward-badge xp @(hardModeEnabled ? "boosted" : "")">
								<span>‚≠ê</span>
								<span>@GetDisplayXP(expedition)</span>
							</div>
						</div>

						<div class="card-info-buttons">
							<div class="monsters-info-btn" onclick=@((e) => { e.StopPropagation(); ShowMonstersPopup(expedition); })>
								<span class="monsters-icon">üêæ</span>
								<span class="monsters-label">Beasts</span>
							</div>
							<div class="monsters-info-btn drops-btn" onclick=@((e) => { e.StopPropagation(); ShowDropsPopup(expedition); })>
								<span class="monsters-icon">üíé</span>
								<span class="monsters-label">Drops</span>
							</div>
						</div>
					</div>

					@if (isLocked)
					{
						<div class="locked-overlay">
							<span class="lock-icon">üîí</span>
							<span class="lock-text">Tamer Lv.@expedition.RequiredLevel</span>
						</div>
					}

					@if (isCleared)
					{
						<div class="cleared-mark">‚úì</div>
					}

					@if (selectedExpedition?.Id == expedition.Id)
					{
						<button class="card-select-team-btn" onclick=@((e) => { e.StopPropagation(); GoToTeam(); })>
							SELECT TEAM ‚ñ∏
						</button>
					}
				</div>
			}
		</div>

		@if (showMonstersPopup && monstersPopupExpedition != null)
		{
			<div class="monsters-popup-overlay" onclick=@CloseMonstersPopup>
				<div class="monsters-popup" onclick=@((e) => e.StopPropagation())>
					<div class="popup-header">
						<span class="popup-title">@monstersPopupExpedition.Name</span>
						<button class="popup-close" onclick=@CloseMonstersPopup>√ó</button>
					</div>
					<div class="popup-content">
						@{
							var bossPool = BossPoolDatabase.GetPool(monstersPopupExpedition.Id);
							var bossSpeciesIds = bossPool?.Bosses?.Select(b => b.SpeciesId).ToHashSet() ?? new HashSet<string>();
							var regularSpecies = monstersPopupExpedition.PossibleSpecies.Where(s => !bossSpeciesIds.Contains(s)).ToList();
						}

						<!-- Regular Encounters Section -->
						<div class="popup-section">
							<div class="section-header">
								<span class="section-title">Regular Encounters</span>
								<span class="section-count">@regularSpecies.Count beasts</span>
							</div>
							<div class="monsters-grid">
								@foreach (var speciesId in regularSpecies)
								{
									var species = GetSpecies(speciesId);
									if (species != null)
									{
										var isDiscovered = IsSpeciesDiscovered(speciesId);
										var isSeen = IsSpeciesSeen(speciesId);
										<div class="monster-card @(isDiscovered ? "discovered" : isSeen ? "seen" : "unknown")">
											<div class="monster-sprite-container">
												@if (isDiscovered || isSeen)
												{
													<img class="monster-sprite" src="@species.IconPath" />
												}
												else
												{
													<div class="monster-sprite-unknown">?</div>
												}
												<div class="monster-status-badge @(isDiscovered ? "discovered" : isSeen ? "seen" : "unknown")">
													@if (isDiscovered) { <span>‚úì</span> }
													else if (isSeen) { <span>üëÅ</span> }
													else { <span>?</span> }
												</div>
											</div>
											<div class="monster-details">
												@if (isDiscovered || isSeen)
												{
													<span class="monster-name">@species.Name</span>
													<span class="monster-element @species.Element.ToString().ToLower()">@GetElementIcon(species.Element) @species.Element</span>
													<span class="monster-rarity @species.BaseRarity.ToString().ToLower()">@species.BaseRarity</span>
												}
												else
												{
													<span class="monster-name unknown">???</span>
													<span class="monster-element unknown">Unknown</span>
													<span class="monster-rarity unknown">???</span>
												}
											</div>
										</div>
									}
								}
							</div>
						</div>

						<!-- Boss Section -->
						@if (bossPool != null && bossPool.Bosses.Count > 0)
						{
							<div class="popup-section boss-section">
								<div class="section-header boss">
									<span class="section-title">Boss Pool</span>
									<span class="section-count">1 random boss per run</span>
								</div>
								<div class="monsters-grid boss-grid">
									@foreach (var boss in bossPool.Bosses)
									{
										var species = GetSpecies(boss.SpeciesId);
										if (species != null)
										{
											var isDiscovered = IsSpeciesDiscovered(boss.SpeciesId);
											var isSeen = IsSpeciesSeen(boss.SpeciesId);
											<div class="monster-card boss-card @(isDiscovered ? "discovered" : isSeen ? "seen" : "unknown")">
												<div class="monster-sprite-container">
													@if (isDiscovered || isSeen)
													{
														<img class="monster-sprite" src="@species.IconPath" />
													}
													else
													{
														<div class="monster-sprite-unknown">?</div>
													}
													<div class="boss-badge">BOSS</div>
													<div class="monster-status-badge @(isDiscovered ? "discovered" : isSeen ? "seen" : "unknown")">
														@if (isDiscovered) { <span>‚úì</span> }
														else if (isSeen) { <span>üëÅ</span> }
														else { <span>?</span> }
													</div>
												</div>
												<div class="monster-details">
													@if (isDiscovered || isSeen)
													{
														<span class="monster-name">@species.Name</span>
														<span class="monster-element @species.Element.ToString().ToLower()">@GetElementIcon(species.Element) @species.Element</span>
														<span class="monster-rarity @species.BaseRarity.ToString().ToLower()">@species.BaseRarity</span>
													}
													else
													{
														<span class="monster-name unknown">???</span>
														<span class="monster-element unknown">Unknown</span>
														<span class="monster-rarity unknown">???</span>
													}
												</div>
											</div>
										}
									}
								</div>
							</div>
						}
					</div>
				</div>
			</div>
		}

		@if (showDropsPopup && dropsPopupExpedition != null)
		{
			<div class="monsters-popup-overlay drops-popup-overlay" onclick=@CloseDropsPopup>
				<div class="monsters-popup drops-popup" onclick=@((e) => e.StopPropagation())>
					<div class="popup-header">
						<span class="popup-title">@dropsPopupExpedition.Name - Possible Drops</span>
						<button class="popup-close" onclick=@CloseDropsPopup>√ó</button>
					</div>
					<div class="popup-content">
						@{
							var drops = GetExpeditionDrops(dropsPopupExpedition);
							var consumables = drops.Where(d => d.Category == ItemCategory.Consumable).ToList();
							var heldItems = drops.Where(d => d.Category == ItemCategory.HeldItem).ToList();
							var relics = drops.Where(d => d.Category == ItemCategory.Relic).ToList();
						}

						@if (heldItems.Any())
						{
							<!-- Held Items Section -->
							<div class="popup-section">
								<div class="section-header held">
									<span class="section-title">‚öî Held Items</span>
									<span class="section-count">@heldItems.Count items</span>
								</div>
								<div class="items-grid">
									@foreach (var item in heldItems.OrderBy(i => i.Rarity))
									{
										<div class="item-card @GetRarityClass(item.Rarity)">
											<div class="item-icon-container">
												<img class="item-icon" src="@item.IconPath" />
											</div>
											<div class="item-details">
												<span class="item-name">@item.Name</span>
												<span class="item-rarity @GetRarityClass(item.Rarity)">@item.Rarity</span>
												<span class="item-desc">@item.Description</span>
											</div>
										</div>
									}
								</div>
							</div>
						}

						@if (consumables.Any())
						{
							<!-- Consumables Section -->
							<div class="popup-section">
								<div class="section-header consumable">
									<span class="section-title">üß™ Consumables</span>
									<span class="section-count">@consumables.Count items</span>
								</div>
								<div class="items-grid">
									@foreach (var item in consumables.OrderBy(i => i.Rarity))
									{
										<div class="item-card @GetRarityClass(item.Rarity)">
											<div class="item-icon-container">
												<img class="item-icon" src="@item.IconPath" />
											</div>
											<div class="item-details">
												<span class="item-name">@item.Name</span>
												<span class="item-rarity @GetRarityClass(item.Rarity)">@item.Rarity</span>
												<span class="item-desc">@item.Description</span>
											</div>
										</div>
									}
								</div>
							</div>
						}

						@if (relics.Any())
						{
							<!-- Relics Section -->
							<div class="popup-section">
								<div class="section-header relic">
									<span class="section-title">üè∫ Relics</span>
									<span class="section-count">@relics.Count items</span>
								</div>
								<div class="items-grid">
									@foreach (var item in relics.OrderBy(i => i.Rarity))
									{
										<div class="item-card @GetRarityClass(item.Rarity)">
											<div class="item-icon-container">
												<img class="item-icon" src="@item.IconPath" />
											</div>
											<div class="item-details">
												<span class="item-name">@item.Name</span>
												<span class="item-rarity @GetRarityClass(item.Rarity)">@item.Rarity</span>
												<span class="item-desc">@item.Description</span>
											</div>
										</div>
									}
								</div>
							</div>
						}

						@if (!drops.Any())
						{
							<div class="no-drops">
								<span class="empty-icon">üì¶</span>
								<span class="empty-text">No special drops</span>
								<span class="empty-hint">This expedition has standard gold and XP rewards</span>
							</div>
						}
					</div>
				</div>
			</div>
		}

		@if (IsExpeditionRunning())
		{
			<div class="running-expedition-bar">
				<div class="running-info">
					<span class="running-icon">‚öî</span>
					<span class="running-text">@GetRunningExpeditionName() - Wave @GetRunningWave()</span>
				</div>
				<div class="running-actions">
					<button class="btn-secondary" onclick=@ResumeExpedition>
						RESUME
					</button>
					<button class="btn-danger" onclick=@CancelExpedition>
						CANCEL
					</button>
				</div>
			</div>
		}

		@if (contractTargetSearchOpen)
		{
			<div class="monsters-popup-overlay contract-search-overlay" onclick=@CloseContractTargetSearch>
				<div class="contract-search-popup" onclick=@((e) => e.StopPropagation())>
					<div class="contract-search-header">
						<span class="contract-search-title">Target Beast</span>
						<button class="contract-search-close" onclick=@CloseContractTargetSearch>√ó</button>
					</div>
					<div class="contract-search-input-wrapper">
						<TextEntry class="contract-search-input" @ref="contractTargetSearchInput" Text="@contractTargetSearchText" Placeholder="Type to filter..." />
					</div>
					<div class="contract-search-results">
						@foreach (var species in GetFilteredSpecies())
						{
							<div class="contract-search-result @(autoContractTargetSpecies == species.Id ? "active" : "")" onclick=@(() => SelectContractTarget(species))>
								<span class="result-number">#@species.BeastiaryNumber</span>
								<span class="result-element">@GetElementIcon(species.Element)</span>
								<span class="result-name">@species.Name</span>
							</div>
						}
						@if (GetFilteredSpecies().Count == 0)
						{
							<div class="contract-search-empty">No matches found</div>
						}
					</div>
				</div>
			</div>
		}
	}
	else if (currentView == "team")
	{
		<!-- Team Selection View -->
		<div class="team-view @(isTransitioningToBattle ? "transitioning-out" : "") @(isTransitioningToList ? "transitioning-back" : "")">
		<div class="roster-header">
			<div class="header-left">
				<button class="back-btn" onclick=@GoToList>‚Üê</button>
				<div class="header-titles">
					<div class="roster-title">@selectedExpedition?.Name</div>
					<div class="roster-subtitle">Select up to 3 beasts for your team</div>
				</div>
			</div>
			<div class="header-right">
				<div class="team-counter">
					<span class="count-current">@selectedTeam.Count</span>
					<span class="count-divider">/</span>
					<span class="count-max">3</span>
				</div>
			</div>
		</div>

		<div class="team-selection">
			<!-- Left side: Filters + Monster grid -->
			<div class="selection-left">
				<!-- Top: Filters + Hover Tooltip -->
				<div class="selection-top">
					<div class="selection-filters">
						<FilterBar @ref="expeditionFilterBar"
								   CurrentElement=@expeditionFilter
								   CurrentSort=@expeditionSort
								   CurrentRarity=@expeditionRarity
								   ShowBeastiarySort=@true
								   ShowRarityFilter=@true
								   OnElementChanged=@OnExpeditionElementChanged
								   OnSortChanged=@OnExpeditionSortChanged
								   OnRarityChanged=@OnExpeditionRarityChanged
								   OnNameFilterChanged=@OnExpeditionNameFilterChanged
								   AvailableNames=@GetExpeditionMonsterNames() />
					</div>
					@{
						var hovered = GetHoveredMonster();
					}
					@if (hovered != null)
					{
						var species = MonsterManager.Instance?.GetSpecies(hovered.SpeciesId);
						<div class="monster-hover-tooltip">
							<div class="tooltip-name">@(hovered.Nickname ?? species?.Name ?? "Unknown")</div>
							<div class="tooltip-level">Lv.@hovered.Level</div>
							<div class="tooltip-element @(species?.Element.ToString().ToLower() ?? "neutral")">@species?.Element</div>
							<div class="tooltip-stat"><span class="stat-name">HP</span><span class="stat-val">@hovered.MaxHP</span></div>
							<div class="tooltip-stat"><span class="stat-name">ATK</span><span class="stat-val">@hovered.ATK</span></div>
							<div class="tooltip-stat"><span class="stat-name">DEF</span><span class="stat-val">@hovered.DEF</span></div>
							<div class="tooltip-stat"><span class="stat-name">SpA</span><span class="stat-val">@hovered.SpA</span></div>
							<div class="tooltip-stat"><span class="stat-name">SpD</span><span class="stat-val">@hovered.SpD</span></div>
							<div class="tooltip-stat"><span class="stat-name">SPD</span><span class="stat-val">@hovered.SPD</span></div>
							<div class="tooltip-genes"><span class="genes-label">Genes</span><span class="genes-value">@GetTotalGenes(hovered)/186</span></div>
							@if (hovered.Traits != null && hovered.Traits.Count > 0)
							{
								<div class="tooltip-traits">
									@foreach (var traitId in hovered.Traits)
									{
										var trait = TraitDatabase.GetTrait(traitId);
										if (trait != null)
										{
											<span class="trait-badge">@trait.Name</span>
										}
									}
								</div>
							}
						</div>
					}
				</div>

				<!-- Monster grid -->
				<div class="available-monsters">
						@foreach (var monster in GetAvailableMonsters())
						{
							var m = monster;
							var isSelected = selectedTeam.Contains(m);
							var isHovered = hoveredMonsterId.HasValue && hoveredMonsterId.Value == m.Id;
							<div class="monster-option @(isSelected ? "in-team" : "")">
								<MonsterCard Monster=@m IsCompact=@true AnimateOnHover=@true AnimationFrame=@SpriteAnimator.GlobalFrame
											 ShouldAnimate=@isHovered
											 ClickAction=@(() => ToggleMonster(m))
											 HoverAction=@(() => OnMonsterHover(m.Id))
											 LeaveAction=@OnMonsterLeave />
							</div>
						}
						@if (GetAvailableMonsters().Count == 0)
						{
							<div class="no-monsters">
								<div class="empty-icon">?</div>
								<div class="empty-text">No beasts found</div>
								<div class="empty-hint">No beasts match this filter</div>
							</div>
						}
					</div>
				</div>

				<!-- Right side: Team Slots -->
				<div class="team-section">
				<div class="team-label">Your Team</div>
				<div class="selected-team">
					@for (int i = 0; i < 3; i++)
					{
						var index = i;
						var monster = selectedTeam.Count > index ? selectedTeam[index] : null;
						<div class="team-slot @(monster != null ? "filled" : "empty")"
							 onclick=@(() => { if (monster != null) RemoveFromTeam(monster); })>
							@if (monster != null)
							{
								<MonsterCard Monster=@monster IsCompact=@true AnimateOnHover=@true AnimationFrame=@SpriteAnimator.GlobalFrame />
							}
							else
							{
								<div class="slot-empty">
									<span class="slot-number">@(index + 1)</span>
									<span class="slot-label">Empty</span>
								</div>
							}
						</div>
					}
				</div>
				<button class="btn-primary btn-start @(selectedTeam.Count == 0 ? "disabled" : "")"
						onclick=@StartExpedition>
					BEGIN EXPEDITION
				</button>
			</div>
		</div>
		</div>
	}
	else if (currentView == "battle")
	{
		<!-- Battle View -->
		<BattleView OnBattleEnd=@OnBattleComplete OnExpeditionCancelled=@OnExpeditionCancelled ExpeditionId="@(selectedExpedition?.Id ?? "")" />
	}
	else if (currentView == "negotiate")
	{
		<!-- Contract Negotiation View -->
		<ContractNegotiationPanel @ref=negotiationPanel IsVisible=@true
								  TargetMonster=@negotiationTarget
								  IsBossContract=@isBossContract
								  OnNegotiationComplete=@OnNegotiationComplete />
	}
	else if (currentView == "result")
	{
		<!-- Result View -->
		@{
			var isExpeditionComplete = lastBattleWon && currentWave >= (selectedExpedition?.Waves ?? 0);
			var isWaveComplete = lastBattleWon && currentWave < (selectedExpedition?.Waves ?? 0);
		}
		<div class="result-view @(lastBattleWon ? "victory" : "defeat")">
			<div class="result-banner">
				@if (isExpeditionComplete)
				{
					<div class="result-icon">üíé</div>
					<div class="result-title">VICTORY!</div>
				}
				else if (isWaveComplete)
				{
					<div class="result-icon">‚öî</div>
					<div class="result-title">Wave @currentWave Complete</div>
				}
				else
				{
					<div class="result-icon">üíÄ</div>
					<div class="result-title">DEFEAT</div>
				}
			</div>

			@if (lastBattleWon)
			{
				<div class="result-rewards">
					<div class="reward-row">
						<span class="reward-label">Total Gold</span>
						<span class="reward-amount gold">+@battleGold üí∞</span>
					</div>
					<div class="reward-row">
						<span class="reward-label">Total XP</span>
						<span class="reward-amount xp">+@battleXP ‚≠ê</span>
					</div>
					@if (battleTokens > 0)
					{
						<div class="reward-row">
							<span class="reward-label">Boss Tokens</span>
							<span class="reward-amount tokens">+@battleTokens üíé</span>
						</div>
					}
				</div>

				@if (isWaveComplete)
				{
					<div class="wave-indicator">
						<span>Wave @currentWave of @selectedExpedition.Waves</span>
						<div class="wave-progress-bar">
							<div class="wave-progress-fill" style="width: @(100f * currentWave / selectedExpedition.Waves)%"></div>
						</div>
					</div>
					<div class="action-bar">
						<button class="btn-success" onclick=@ContinueExpedition>
							NEXT WAVE ‚Üí
						</button>
					</div>
				}
				else
				{
					<div class="expedition-complete-banner">
						<span class="complete-icon">üéâ</span>
						<span class="complete-text">Expedition Complete!</span>
					</div>
					<div class="action-bar">
						<button class="btn-primary" onclick=@ReturnToList>
							RETURN TO EXPEDITIONS
						</button>
					</div>
				}
			}
			else
			{
				<div class="defeat-info">
					<span>Your team was defeated on Wave @currentWave</span>
				</div>
				<div class="action-bar">
					<button class="btn-warning" onclick=@GoToTeam>
						RETRY
					</button>
					<button class="btn-secondary" onclick=@ReturnToList>
						RETURN
					</button>
				</div>
			}
		</div>
	}

</div>

@code {
	private string currentView = "list";
	private Expedition selectedExpedition;
	private List<Monster> selectedTeam = new();
	private bool autoBattle = true;
	private bool autoRetry = true;
	private bool autoNegotiate = false;
	private bool hardModeEnabled = false;
	private bool isTransitioningToBattle = false;
	private bool isTransitioningToList = false;
	private int autoNegotiateStrategy = 0;
	private string autoContractTargetSpecies
	{
		get => ExpeditionManager.Instance?.AutoContractTargetSpecies;
		set { if (ExpeditionManager.Instance != null) ExpeditionManager.Instance.AutoContractTargetSpecies = value; }
	}
	private bool hasAnimatedCards = false;

	// Dropdown states
	private bool difficultyDropdownOpen = false;
	private bool catchDropdownOpen = false;

	// Contract target search popup
	private bool contractTargetSearchOpen = false;
	private string contractTargetSearchText = "";
	private TextEntry contractTargetSearchInput;

	private bool lastBattleWon = false;
	private int currentWave = 0;
	private int battleGold = 0;
	private int battleXP = 0;
	private int battleTokens = 0;

	// Team selection filter/sort state
	private string expeditionFilter = "all";
	private string expeditionSort = "power";
	private string expeditionRarity = "all";
	private string expeditionNameFilter = "";
	private FilterBar expeditionFilterBar;

	// Hover tooltip state (matches MonsterRosterPanel pattern)
	private Guid? hoveredMonsterId = null;

	private void OnMonsterHover(Guid monsterId)
	{
		if (hoveredMonsterId != monsterId)
		{
			hoveredMonsterId = monsterId;
			StateHasChanged();
		}
	}

	private void OnMonsterLeave()
	{
		if (hoveredMonsterId != null)
		{
			hoveredMonsterId = null;
			StateHasChanged();
		}
	}

	private Monster GetHoveredMonster()
	{
		if (!hoveredMonsterId.HasValue) return null;
		return MonsterManager.Instance?.OwnedMonsters?.FirstOrDefault(m => m.Id == hoveredMonsterId.Value);
	}

	// Negotiation state
	private ContractNegotiationPanel negotiationPanel;
	private Monster negotiationTarget;
	private bool isBossContract = false;

	// Monsters popup state
	private bool showMonstersPopup = false;
	private Expedition monstersPopupExpedition;
	private bool showDropsPopup = false;
	private Expedition dropsPopupExpedition;

	// Keyboard navigation
	private int selectedExpeditionIndex = 0;
	private int selectedMonsterIndex = 0;
	private int selectedTeamSlotIndex = 0;

	private void OnPanelClicked()
	{
		// When user clicks with mouse, ensure we're in panel mode (not tab navigation)
		GameHUD.EnterPanel();
	}

	protected override void OnAfterTreeRender(bool firstTime)
	{
		if (firstTime)
		{
			SyncWithBackgroundExpedition();
			// Mark cards as animated after entrance animation completes
			_ = MarkCardsAnimated();
		}
	}

	private async Task MarkCardsAnimated()
	{
		await Task.Delay(600); // Wait for staggered animation to complete
		hasAnimatedCards = true;
		StateHasChanged();
	}

	public override void Tick()
	{
		base.Tick();

		// Update contract target search text from input
		if (contractTargetSearchInput != null && contractTargetSearchOpen)
		{
			contractTargetSearchText = contractTargetSearchInput.Text ?? "";
		}

		// Check if we need to sync with a running expedition
		// This handles returning from background mode
		var expMgr = ExpeditionManager.Instance;
		if (expMgr?.CurrentExpedition != null && BattleManager.Instance?.IsInBattle == true)
		{
			// There's an active battle but we're not showing it
			if (currentView != "battle")
			{
				Log.Info($"ExpeditionPanel.Tick: Battle active but view is '{currentView}', syncing...");
				SyncWithBackgroundExpedition();
				StateHasChanged();
			}
			// Force UI updates while battle is active to ensure animations play
			else if (currentView == "battle")
			{
				StateHasChanged();
			}
		}
	}

	/// <summary>
	/// Called by GameHUD to handle keyboard input (child panels don't auto-tick in s&box Razor)
	/// </summary>
	public void TickInput()
	{
		HandleKeyboardInput();
	}

	private void HandleKeyboardInput()
	{

		// List view - expedition selection
		if (currentView == "list")
		{
			var expeditions = GetExpeditions();
			if (expeditions.Count == 0)
			{
				// No expeditions - W/Up exits to tabs
				if (Input.Pressed("Up"))
				{
					GameHUD.ExitPanel();
				}
				return;
			}

			selectedExpeditionIndex = Math.Clamp(selectedExpeditionIndex, 0, expeditions.Count - 1);

			// Grid navigation (assume 2 columns)
			int columns = 2;

			if (Input.Pressed("Left"))
			{
				selectedExpeditionIndex = Math.Max(0, selectedExpeditionIndex - 1);
				SoundManager.PlayHover();
			}
			else if (Input.Pressed("Right"))
			{
				selectedExpeditionIndex = Math.Min(expeditions.Count - 1, selectedExpeditionIndex + 1);
				SoundManager.PlayHover();
			}
			else if (Input.Pressed("Up"))
			{
				// If at top row, exit to tab navigation
				if (selectedExpeditionIndex < columns)
				{
					GameHUD.ExitPanel();
				}
				else
				{
					selectedExpeditionIndex = Math.Max(0, selectedExpeditionIndex - columns);
					SoundManager.PlayHover();
				}
			}
			else if (Input.Pressed("Down"))
			{
				selectedExpeditionIndex = Math.Min(expeditions.Count - 1, selectedExpeditionIndex + columns);
				SoundManager.PlayHover();
			}
			else if (Input.Pressed("attack1") || Input.Pressed("jump"))
			{
				var exp = expeditions[selectedExpeditionIndex];
				if (CanStartExpedition(exp))
				{
					SelectExpedition(exp);
					// If already selected, go to team
					if (selectedExpedition?.Id == exp.Id)
					{
						GoToTeam();
					}
				}
			}
			// Toggle auto battle/retry with Q/E
			else if (Input.Pressed("PrevWeapon"))
			{
				ToggleAutoBattle();
			}
			else if (Input.Pressed("NextWeapon"))
			{
				ToggleAutoRetry();
			}
			// Resume running expedition
			else if (Input.Pressed("reload") && IsExpeditionRunning())
			{
				ResumeExpedition();
			}
		}
		// Team view - monster selection
		else if (currentView == "team")
		{
			var monsters = GetAvailableMonsters();

			// Navigation
			if (monsters.Count > 0)
			{
				selectedMonsterIndex = Math.Clamp(selectedMonsterIndex, 0, monsters.Count - 1);
				int columns = 4;

				if (Input.Pressed("Left"))
				{
					selectedMonsterIndex = Math.Max(0, selectedMonsterIndex - 1);
					SoundManager.PlayHover();
				}
				else if (Input.Pressed("Right"))
				{
					selectedMonsterIndex = Math.Min(monsters.Count - 1, selectedMonsterIndex + 1);
					SoundManager.PlayHover();
				}
				else if (Input.Pressed("Up"))
				{
					// If at top row, go back to list
					if (selectedMonsterIndex < columns)
					{
						GoToList();
					}
					else
					{
						selectedMonsterIndex = Math.Max(0, selectedMonsterIndex - columns);
						SoundManager.PlayHover();
					}
				}
				else if (Input.Pressed("Down"))
				{
					selectedMonsterIndex = Math.Min(monsters.Count - 1, selectedMonsterIndex + columns);
					SoundManager.PlayHover();
				}
				else if (Input.Pressed("attack1") || Input.Pressed("jump"))
				{
					// Add monster to team
					ToggleMonster(monsters[selectedMonsterIndex]);
				}
			}

			// Enter to start expedition
			if (Input.Pressed("reload") && selectedTeam.Count > 0)
			{
				StartExpedition();
			}
			// Back to list
			else if (Input.Pressed("Menu") || Input.Pressed("run"))
			{
				GoToList();
			}
			// Remove from team with number keys
			else if (Input.Pressed("Slot1") && selectedTeam.Count > 0)
			{
				RemoveFromTeam(selectedTeam[0]);
			}
			else if (Input.Pressed("Slot2") && selectedTeam.Count > 1)
			{
				RemoveFromTeam(selectedTeam[1]);
			}
			else if (Input.Pressed("Slot3") && selectedTeam.Count > 2)
			{
				RemoveFromTeam(selectedTeam[2]);
			}
		}
		// Result view
		else if (currentView == "result")
		{
			if (Input.Pressed("attack1") || Input.Pressed("jump") || Input.Pressed("Menu"))
			{
				if (lastBattleWon && currentWave < (selectedExpedition?.Waves ?? 0))
				{
					ContinueExpedition();
				}
				else
				{
					ReturnToList();
				}
			}
		}
		// Negotiate view - delegate to the negotiation panel
		else if (currentView == "negotiate")
		{
			negotiationPanel?.TickInput();
		}
	}

	/// <summary>
	/// Sync panel state with any running background expedition
	/// </summary>
	private void SyncWithBackgroundExpedition()
	{
		var expMgr = ExpeditionManager.Instance;
		if (expMgr == null) return;

		var oldView = currentView;

		// Sync toggle states
		autoBattle = expMgr.AutoBattle;
		autoRetry = expMgr.AutoRetry;
		autoNegotiate = expMgr.AutoNegotiate;
		autoNegotiateStrategy = expMgr.AutoNegotiateStrategy;

		// If there's an expedition running (background or not), sync to it
		if (expMgr.CurrentExpedition != null)
		{
			selectedExpedition = expMgr.CurrentExpedition;
			selectedTeam = new List<Monster>(expMgr.SelectedTeam);
			currentWave = expMgr.CurrentWave;
			battleGold = expMgr.AccumulatedGold;
			battleXP = expMgr.AccumulatedXP;

			// If battle is in progress, show battle view
			if (BattleManager.Instance?.IsInBattle == true)
			{
				currentView = "battle";
			}
		}

		if (oldView != currentView)
		{
			Log.Info($"SyncWithBackgroundExpedition: View changed from '{oldView}' to '{currentView}'");
		}
	}

	private List<Expedition> GetExpeditions()
	{
		return ExpeditionManager.Instance?.Expeditions?.ToList() ?? new();
	}

	private bool CanStartExpedition(Expedition expedition)
	{
		var tamer = TamerManager.Instance?.CurrentTamer;
		return tamer != null && tamer.Level >= expedition.RequiredLevel;
	}

	private bool IsCleared(Expedition expedition)
	{
		var expeditions = GetExpeditions();
		var index = expeditions.IndexOf(expedition);
		var tamer = TamerManager.Instance?.CurrentTamer;
		return tamer != null && index < tamer.HighestExpeditionCleared;
	}

	private string GetElementIcon(ElementType element)
	{
		return element switch
		{
			ElementType.Fire => "üî•",
			ElementType.Water => "üíß",
			ElementType.Earth => "ü™®",
			ElementType.Wind => "üå™",
			ElementType.Electric => "‚ö°",
			ElementType.Ice => "‚ùÑ",
			ElementType.Nature => "üåø",
			ElementType.Metal => "‚öô",
			ElementType.Shadow => "üåë",
			ElementType.Spirit => "üëª",
			_ => "‚ö™"
		};
	}

	private int GetDisplayLevel(Expedition expedition)
	{
		if (hardModeEnabled)
			return expedition.BaseEnemyLevel + ExpeditionManager.HARD_MODE_LEVEL_BONUS;
		return expedition.BaseEnemyLevel;
	}

	private int GetDisplayGold(Expedition expedition)
	{
		if (hardModeEnabled)
			return (int)(expedition.GoldReward * ExpeditionManager.HARD_MODE_REWARD_MULTIPLIER);
		return expedition.GoldReward;
	}

	private int GetDisplayXP(Expedition expedition)
	{
		if (hardModeEnabled)
			return (int)(expedition.XPReward * ExpeditionManager.HARD_MODE_REWARD_MULTIPLIER);
		return expedition.XPReward;
	}

	private void ShowMonstersPopup(Expedition expedition)
	{
		monstersPopupExpedition = expedition;
		showMonstersPopup = true;
		SoundManager.PlaySelect();
		StateHasChanged();
	}

	private void CloseMonstersPopup()
	{
		showMonstersPopup = false;
		monstersPopupExpedition = null;
		SoundManager.PlayBack();
		StateHasChanged();
	}

	private void ShowDropsPopup(Expedition expedition)
	{
		dropsPopupExpedition = expedition;
		showDropsPopup = true;
		SoundManager.PlaySelect();
		StateHasChanged();
	}

	private void CloseDropsPopup()
	{
		showDropsPopup = false;
		dropsPopupExpedition = null;
		SoundManager.PlayBack();
		StateHasChanged();
	}

	private List<ItemDefinition> GetExpeditionDrops(Expedition expedition)
	{
		if (ItemManager.Instance == null || expedition == null)
			return new List<ItemDefinition>();

		return ItemManager.Instance.GetDropsForExpedition(expedition.Id);
	}

	private string GetRarityClass(ItemRarity rarity)
	{
		return rarity.ToString().ToLower();
	}

	private string GetItemIcon(ItemDefinition item)
	{
		// Return emoji based on item category
		return item.Category switch
		{
			ItemCategory.Consumable => "üß™",
			ItemCategory.HeldItem => "‚öî",
			ItemCategory.Relic => "üè∫",
			ItemCategory.QuestItem => "üìú",
			_ => "üì¶"
		};
	}

	private MonsterSpecies GetSpecies(string speciesId)
	{
		return MonsterManager.Instance?.GetSpecies(speciesId);
	}

	private bool IsSpeciesDiscovered(string speciesId)
	{
		return BeastiaryManager.Instance?.IsDiscovered(speciesId) ?? false;
	}

	private bool IsSpeciesSeen(string speciesId)
	{
		return BeastiaryManager.Instance?.IsSeen(speciesId) ?? false;
	}

	private string GetBackgroundClass(Expedition expedition)
	{
		// Return CSS class for expeditions with background art (card view)
		return expedition.Id switch
		{
			"forest_entrance" => "has-background bg-forest_entrance",
			"ember_cavern" => "has-background bg-ember_cavern",
			"tear_lake" => "has-background bg-tear_lake",
			"echo_canyon" => "has-background bg-echo_canyon",
			"storm_spire" => "has-background bg-storm_spire",
			"ancient_ruins" => "has-background bg-ancient_ruins",
			"frozen_vale" => "has-background bg-frozen_vale",
			"overgrown_heart" => "has-background bg-overgrown_heart",
			"rusted_foundry" => "has-background bg-rusted_foundry",
			"dawn_sanctuary" => "has-background bg-spirit_sanctum",
			"shadow_depths" => "has-background bg-shadow_depths",
			"elemental_nexus" => "has-background bg-elemental_nexus",
			"primordial_rift" => "has-background bg-primordial_rift",
			"garden_of_origins" => "has-background bg-garden_of_origins",
			"mythweavers_realm" => "has-background bg-mythweavers_realm",
			"origin_void" => "has-background bg-origin_void",
			_ => ""
		};
	}

	private string GetExpeditionBackgroundClass()
	{
		// Return CSS class for the expedition panel background (team select & battle)
		var expedition = selectedExpedition ?? ExpeditionManager.Instance?.CurrentExpedition;
		if (expedition == null) return "";

		return expedition.Id switch
		{
			"forest_entrance" => "expedition-bg-forest",
			"ember_cavern" => "expedition-bg-ember",
			"tear_lake" => "expedition-bg-tear_lake",
			"echo_canyon" => "expedition-bg-echo_canyon",
			"storm_spire" => "expedition-bg-storm_spire",
			"ancient_ruins" => "expedition-bg-ancient_ruins",
			"frozen_vale" => "expedition-bg-frozen_vale",
			"overgrown_heart" => "expedition-bg-overgrown_heart",
			"rusted_foundry" => "expedition-bg-rusted_foundry",
			"dawn_sanctuary" => "expedition-bg-spirit_sanctum",
			"shadow_depths" => "expedition-bg-shadow_depths",
			"elemental_nexus" => "expedition-bg-elemental_nexus",
			"primordial_rift" => "expedition-bg-primordial_rift",
			"garden_of_origins" => "expedition-bg-garden_of_origins",
			"mythweavers_realm" => "expedition-bg-mythweavers_realm",
			"origin_void" => "expedition-bg-origin_void",
			_ => ""
		};
	}

	private void SelectExpedition(Expedition expedition)
	{
		if (CanStartExpedition(expedition))
		{
			selectedExpedition = expedition;
			SoundManager.PlaySelect();
			StateHasChanged();
		}
		else
		{
			SoundManager.PlayDeny();
		}
	}

	private void ToggleAutoBattle()
	{
		autoBattle = !autoBattle;
		if (ExpeditionManager.Instance != null)
			ExpeditionManager.Instance.AutoBattle = autoBattle;
		if (autoBattle)
			SoundManager.PlayToggleOn();
		else
			SoundManager.PlayToggleOff();
		StateHasChanged();
	}

	private void ToggleAutoRetry()
	{
		autoRetry = !autoRetry;
		if (ExpeditionManager.Instance != null)
			ExpeditionManager.Instance.AutoRetry = autoRetry;
		if (autoRetry)
			SoundManager.PlayToggleOn();
		else
			SoundManager.PlayToggleOff();
		StateHasChanged();
	}

	private bool IsHardModeUnlocked()
	{
		return ExpeditionManager.Instance?.IsHardModeUnlocked() ?? false;
	}

	// Difficulty dropdown methods
	private void ToggleDifficultyDropdown()
	{
		difficultyDropdownOpen = !difficultyDropdownOpen;
		catchDropdownOpen = false;
		SoundManager.PlayClick();
	}

	private void SelectDifficulty(bool hard)
	{
		// Can't select hard mode if not unlocked
		if (hard && !IsHardModeUnlocked())
		{
			SoundManager.PlayDeny();
			return;
		}

		hardModeEnabled = hard;
		if (ExpeditionManager.Instance != null)
			ExpeditionManager.Instance.HardModeEnabled = hardModeEnabled;

		difficultyDropdownOpen = false;
		SoundManager.PlaySelect();
		StateHasChanged();
	}

	// Auto Catch dropdown methods
	private void ToggleCatchDropdown()
	{
		catchDropdownOpen = !catchDropdownOpen;
		difficultyDropdownOpen = false;
		SoundManager.PlayClick();
	}

	private void SelectCatchStrategy(int strategy)
	{
		// -2 means Manual (auto catch disabled)
		if (strategy == -2)
		{
			autoNegotiate = false;
			if (ExpeditionManager.Instance != null)
				ExpeditionManager.Instance.AutoNegotiate = false;
		}
		else
		{
			autoNegotiate = true;
			autoNegotiateStrategy = strategy;
			if (ExpeditionManager.Instance != null)
			{
				ExpeditionManager.Instance.AutoNegotiate = true;
				ExpeditionManager.Instance.AutoNegotiateStrategy = strategy;
			}
		}

		catchDropdownOpen = false;
		SoundManager.PlaySelect();
		StateHasChanged();
	}

	private string GetCatchStrategyIcon()
	{
		if (!autoNegotiate) return "‚úã";
		return autoNegotiateStrategy switch
		{
			-1 => "‚è≠",
			0 => "üíù",
			1 => "ü§ù",
			2 => "üìã",
			3 => "üí∞",
			_ => "ü§ù"
		};
	}

	private string GetCatchStrategyLabel()
	{
		if (!autoNegotiate) return "Off";
		var label = autoNegotiateStrategy switch
		{
			-1 => "Skip",
			0 => "Generous",
			1 => "Fair",
			2 => "Strict",
			3 => "Golden",
			_ => "Fair"
		};
		if (autoContractTargetSpecies != null)
		{
			var targetName = MonsterManager.Instance?.GetSpecies(autoContractTargetSpecies)?.Name ?? "?";
			label += $" ({targetName})";
		}
		return label;
	}

	// Contract target search methods
	private void OpenContractTargetSearch()
	{
		catchDropdownOpen = false;
		contractTargetSearchOpen = true;
		contractTargetSearchText = "";
		SoundManager.PlayForward();
	}

	private void CloseContractTargetSearch()
	{
		contractTargetSearchOpen = false;
		contractTargetSearchText = "";
		SoundManager.PlayBack();
	}

	private void SelectContractTarget(MonsterSpecies species)
	{
		autoContractTargetSpecies = species.Id;
		contractTargetSearchOpen = false;
		contractTargetSearchText = "";
		SoundManager.PlaySelect();
	}

	private void ClearContractTarget()
	{
		autoContractTargetSpecies = null;
		catchDropdownOpen = false;
		SoundManager.PlaySelect();
	}

	private List<MonsterSpecies> GetFilteredSpecies()
	{
		var allSpecies = MonsterManager.Instance?.GetAllSpecies() ?? new List<MonsterSpecies>();
		var sorted = allSpecies.Where(s => s.IsCatchable).OrderBy(s => s.BeastiaryNumber).ToList();

		if (string.IsNullOrEmpty(contractTargetSearchText))
			return sorted.Take(20).ToList();

		return sorted
			.Where(s => s.Name.ToLower().Contains(contractTargetSearchText.ToLower()))
			.Take(20)
			.ToList();
	}

	private void SetExpeditionFilter(string filter)
	{
		expeditionFilter = filter;
		SoundManager.PlaySelect();
		StateHasChanged();
	}

	private void SetExpeditionSort(string sort)
	{
		expeditionSort = sort;
		SoundManager.PlaySelect();
		StateHasChanged();
	}

	// FilterBar callback handlers
	private void OnExpeditionElementChanged(string element)
	{
		expeditionFilter = element;
		StateHasChanged();
	}

	private void OnExpeditionSortChanged(string sort)
	{
		expeditionSort = sort;
		StateHasChanged();
	}

	private void OnExpeditionRarityChanged(string rarity)
	{
		expeditionRarity = rarity;
		StateHasChanged();
	}

	private void OnExpeditionNameFilterChanged(string name)
	{
		expeditionNameFilter = name;
		StateHasChanged();
	}

	private List<string> GetExpeditionMonsterNames()
	{
		var monsters = MonsterManager.Instance?.OwnedMonsters ?? new List<Monster>();
		var names = new HashSet<string>();

		foreach (var monster in monsters)
		{
			if (!string.IsNullOrEmpty(monster.Nickname))
				names.Add(monster.Nickname);

			var species = MonsterManager.Instance?.GetSpecies(monster.SpeciesId);
			if (species != null && !string.IsNullOrEmpty(species.Name))
				names.Add(species.Name);
		}

		return names.OrderBy(n => n).ToList();
	}

	private int GetTotalGenes(Monster m)
	{
		if (m?.Genetics == null) return 0;
		return m.Genetics.HPGene + m.Genetics.ATKGene + m.Genetics.DEFGene +
			   m.Genetics.SpAGene + m.Genetics.SpDGene + m.Genetics.SPDGene;
	}

	private string GetContractClass(int satisfaction)
	{
		return satisfaction switch
		{
			>= 90 => "excellent",
			>= 70 => "good",
			>= 50 => "warning",
			_ => "danger"
		};
	}

	private List<Monster> GetAvailableMonsters()
	{
		var monsters = MonsterManager.Instance?.OwnedMonsters
			?.Where(m => !selectedTeam.Contains(m))
			?.ToList() ?? new();

		// Element filter
		if (expeditionFilter != "all")
		{
			var elementType = expeditionFilter switch
			{
				"fire" => ElementType.Fire,
				"water" => ElementType.Water,
				"earth" => ElementType.Earth,
				"wind" => ElementType.Wind,
				"electric" => ElementType.Electric,
				"ice" => ElementType.Ice,
				"nature" => ElementType.Nature,
				"metal" => ElementType.Metal,
				"shadow" => ElementType.Shadow,
				"spirit" => ElementType.Spirit,
				"neutral" => ElementType.Neutral,
				_ => ElementType.Neutral
			};

			monsters = monsters.Where(m =>
			{
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return species?.Element == elementType;
			}).ToList();
		}

		// Rarity filter
		if (expeditionRarity != "all")
		{
			var rarityType = expeditionRarity switch
			{
				"common" => Rarity.Common,
				"uncommon" => Rarity.Uncommon,
				"rare" => Rarity.Rare,
				"epic" => Rarity.Epic,
				"legendary" => Rarity.Legendary,
				"mythic" => Rarity.Mythic,
				_ => Rarity.Common
			};

			monsters = monsters.Where(m =>
			{
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return species?.BaseRarity == rarityType;
			}).ToList();
		}

		// Name filter
		if (expeditionSort == "name" && !string.IsNullOrEmpty(expeditionNameFilter))
		{
			monsters = monsters.Where(m =>
			{
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return species?.Name?.Equals(expeditionNameFilter, StringComparison.OrdinalIgnoreCase) == true ||
					   m.Nickname?.Equals(expeditionNameFilter, StringComparison.OrdinalIgnoreCase) == true;
			}).ToList();
		}

		// Sorting
		monsters = expeditionSort switch
		{
			"fav" => monsters.OrderByDescending(m => m.IsFavorite)
							.ThenByDescending(m => m.PowerRating).ToList(),
			"power" => monsters.OrderByDescending(m => m.PowerRating).ToList(),
			"level" => monsters.OrderByDescending(m => m.Level).ToList(),
			"genes" => monsters.OrderByDescending(m => GetTotalGenes(m)).ToList(),
			"rarity" => monsters.OrderByDescending(m => {
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return (int)(species?.BaseRarity ?? Rarity.Common);
			}).ThenByDescending(m => m.PowerRating).ToList(),
			"recent" => monsters.OrderByDescending(m => m.CaughtAt).ToList(),
			"beastiary" => monsters.OrderBy(m => {
				var species = MonsterManager.Instance?.GetSpecies(m.SpeciesId);
				return species?.BeastiaryNumber ?? 9999;
			}).ToList(),
			"name" => monsters.OrderBy(m => m.Nickname ?? MonsterManager.Instance?.GetSpecies(m.SpeciesId)?.Name ?? "").ToList(),
			_ => monsters.OrderByDescending(m => m.PowerRating).ToList()
		};

		return monsters;
	}

	private void ToggleMonster(Monster monster)
	{
		Log.Info($"ToggleMonster called for: {monster?.Nickname ?? "null"}");
		if (monster == null) return;

		if (selectedTeam.Contains(monster))
		{
			selectedTeam.Remove(monster);
			SoundManager.PlayBack();
			Log.Info($"Removed {monster.Nickname} from team. Team count: {selectedTeam.Count}");
		}
		else if (selectedTeam.Count < 3)
		{
			selectedTeam.Add(monster);
			SoundManager.PlaySelect();
			Log.Info($"Added {monster.Nickname} to team. Team count: {selectedTeam.Count}");
		}
		else
		{
			SoundManager.PlayDeny();
		}

		StateHasChanged();
	}

	private void RemoveFromTeam(Monster monster)
	{
		selectedTeam.Remove(monster);
		SoundManager.PlayBack();
		StateHasChanged();
	}

	private async void StartExpedition()
	{
		Log.Info($"StartExpedition called. Team count: {selectedTeam.Count}, Expedition: {selectedExpedition?.Id ?? "null"}");
		if (selectedTeam.Count == 0 || selectedExpedition == null || isTransitioningToBattle)
		{
			Log.Warning($"Cannot start expedition: Team count={selectedTeam.Count}, Expedition={selectedExpedition?.Id ?? "null"}");
			SoundManager.PlayDeny();
			return;
		}

		SoundManager.PlayBattleStart();

		// Start slide-out transition
		isTransitioningToBattle = true;
		StateHasChanged();

		// Wait for animation to complete
		await Task.Delay(300);

		// Reset accumulated rewards
		battleGold = 0;
		battleXP = 0;
		battleTokens = 0;

		ExpeditionManager.Instance?.SelectTeam(selectedTeam);
		ExpeditionManager.Instance?.StartExpedition(selectedExpedition.Id);

		currentWave = 1;
		currentView = "battle";
		isTransitioningToBattle = false;

		// If auto battle is enabled, start playback automatically
		if (autoBattle && BattleManager.Instance != null)
		{
			BattleManager.Instance.StartPlayback();
		}

		StateHasChanged();
	}

	private void OnBattleComplete(bool playerWon)
	{
		Log.Info($"OnBattleComplete: playerWon={playerWon}, currentWave={currentWave}, totalWaves={selectedExpedition?.Waves ?? 0}");
		lastBattleWon = playerWon;

		var result = BattleManager.Instance?.CurrentResult;
		if (result != null)
		{
			battleGold += result.TotalGold;
			battleXP += result.TotalXP;

			// Track item drops from the battle
			if (result.ItemDrops?.Count > 0)
			{
				ExpeditionManager.Instance?.AddAccumulatedItems(result.ItemDrops);
				Log.Info($"OnBattleComplete: Added {result.ItemDrops.Count} item drops to accumulated items");
			}
		}

		// Note: Catchable enemies are now stored in BattleView.HandleBattleEnd before this callback runs

		// Determine if we're continuing to next wave (need transition-friendly exit)
		var currentAutoRetry = ExpeditionManager.Instance?.AutoRetry ?? autoRetry;
		bool willContinue = playerWon && currentWave < (selectedExpedition?.Waves ?? 0);
		bool willAutoRetry = currentAutoRetry && (playerWon && currentWave >= (selectedExpedition?.Waves ?? 0) || !playerWon);

		// Use transition-friendly exit if we're continuing, otherwise full exit
		if (willContinue || willAutoRetry)
		{
			BattleManager.Instance?.PrepareForNextWave();
			BattleManager.Instance?.ExitBattleForTransition();
		}
		else
		{
			BattleManager.Instance?.ExitBattle();
		}

		// Read current toggle states from manager (may have been changed in BattleView)
		var currentAutoBattle = ExpeditionManager.Instance?.AutoBattle ?? autoBattle;
		// currentAutoRetry already set above

		// If player won, check if we can offer negotiation
		// 10% chance for negotiation opportunity to appear
		// EXCEPTION: Rare boss battles (Legendary/Celestial/Mythic) ALWAYS offer negotiation (100% chance)
		var currentAutoNegotiate = ExpeditionManager.Instance?.AutoNegotiate ?? autoNegotiate;
		var currentAutoNegotiateStrategy = ExpeditionManager.Instance?.AutoNegotiateStrategy ?? autoNegotiateStrategy;

		// Check if this was a rare boss defeat
		bool isRareBossDefeat = false;
		bool isBossWave = ExpeditionManager.Instance?.IsBossWave ?? false;
		if (playerWon && isBossWave && ExpeditionManager.Instance?.IsRareBossEncounter == true)
		{
			// Check if the boss monster is Legendary or Mythic
			var bossSpeciesId = ExpeditionManager.Instance?.SelectedBoss?.SpeciesId;
			if (!string.IsNullOrEmpty(bossSpeciesId))
			{
				var bossSpecies = MonsterManager.Instance?.GetSpecies(bossSpeciesId);
				if (bossSpecies != null && bossSpecies.BaseRarity >= Rarity.Legendary)
				{
					isRareBossDefeat = true;
					Log.Info($"RARE BOSS DEFEATED! {bossSpecies.Name} ({bossSpecies.BaseRarity}) - 100% contract chance!");
				}
			}
		}

		// Note: Manual negotiation is now handled by BattleView as an overlay
		// ExpeditionPanel only handles auto-negotiate here
		if (playerWon && HasContractInk() && ExpeditionManager.Instance?.HasCatchableEnemy == true)
		{
			// Auto-negotiate only runs if enabled AND not a rare boss (those show manual overlay in BattleView)
			if (currentAutoNegotiate && !isRareBossDefeat)
			{
				// Apply 10% chance roll for auto-negotiate too
				var random = new Random();
				if (random.NextDouble() < 0.10f)
				{
					Monster autoTarget;
					if (!string.IsNullOrEmpty(autoContractTargetSpecies))
					{
						// Only target the specific species the player wants
						autoTarget = ExpeditionManager.Instance.CatchableEnemies
							.FirstOrDefault(e => e.SpeciesId == autoContractTargetSpecies);
					}
					else
					{
						autoTarget = ExpeditionManager.Instance.GetRandomCatchableEnemy();
					}
					if (autoTarget != null)
					{
						TryAutoNegotiate(autoTarget, currentAutoNegotiateStrategy);
					}
				}
				ExpeditionManager.Instance?.ClearCatchableEnemies();
			}
		}

		// Clear catchable enemies since we're not negotiating
		ExpeditionManager.Instance?.ClearCatchableEnemies();

		// If player won and there are more waves, continue (don't exit battle - just start next wave)
		if (playerWon && currentWave < (selectedExpedition?.Waves ?? 0))
		{
			Log.Info($"OnBattleComplete: Continuing to next wave");
			ContinueExpedition();
			return;
		}
		else if (playerWon && currentWave >= (selectedExpedition?.Waves ?? 0) && currentAutoRetry)
		{
			// Expedition complete but auto-retry is on - restart from wave 1
			Log.Info("Auto-retry: Expedition complete, restarting from wave 1");

			// Retry with rewards (awards completion rewards, keeps expedition active)
			RetryExpedition(awardCompletionRewards: true);

			// Track boss tokens that were just awarded
			battleTokens += ExpeditionManager.Instance?.LastAwardedBossTokens ?? 0;
			return;
		}
		else if (!playerWon && currentAutoRetry)
		{
			// Auto-retry the expedition from wave 1
			Log.Info("Auto-retry: Restarting expedition");
			RetryExpedition(awardCompletionRewards: false);
			return;
		}
		else
		{
			// Either lost or completed all waves - show final result
			Log.Info($"OnBattleComplete: Showing result view");

			// Notify ExpeditionManager that expedition is complete
			// This awards rewards and clears CurrentExpedition
			ExpeditionManager.Instance?.OnWaveComplete(playerWon);

			// Track boss tokens that were just awarded (if won)
			if (playerWon)
			{
				battleTokens = ExpeditionManager.Instance?.LastAwardedBossTokens ?? 0;
			}

			currentView = "result";
		}

		StateHasChanged();
	}

	private bool HasContractInk()
	{
		return (TamerManager.Instance?.CurrentTamer?.ContractInk ?? 0) > 0;
	}

	private void TryAutoNegotiate(Monster target, int strategyIndex)
	{
		if (target == null) return;

		// Skip catching if strategy is set to skip (-1)
		if (strategyIndex == -1)
		{
			Log.Info("Auto-negotiate: Skipping catch (strategy set to Skip)");
			return;
		}

		var species = MonsterManager.Instance?.GetSpecies(target.SpeciesId);
		if (species == null) return;

		// Generate negotiation options
		var options = ContractGenerator.GenerateNegotiationOptions(species, target);
		if (options == null || options.Count == 0) return;

		// Clamp strategy index to valid range
		strategyIndex = Math.Clamp(strategyIndex, 0, options.Count - 1);
		var selectedOption = options[strategyIndex];
		var currentInk = TamerManager.Instance?.CurrentTamer?.ContractInk ?? 0;

		// Check if we can afford this option (ink + gold)
		if (currentInk < selectedOption.InkCost)
		{
			// Try to fall back to a cheaper option
			var affordableOption = options.Where(o => currentInk >= o.InkCost).OrderByDescending(o => o.InkCost).FirstOrDefault();
			if (affordableOption == null)
			{
				Log.Warning($"Auto-negotiate: Not enough ink! Have {currentInk}, need {selectedOption.InkCost}");
				return;
			}
			Log.Info($"Auto-negotiate: Can't afford {selectedOption.Name} ({selectedOption.InkCost} ink), using {affordableOption.Name}");
			selectedOption = affordableOption;
		}

		if (selectedOption.GoldCost > 0)
		{
			var gold = TamerManager.Instance?.CurrentTamer?.Gold ?? 0;
			if (gold < selectedOption.GoldCost)
			{
				// Can't afford golden handshake, fall back to fair terms (index 1)
				Log.Info($"Auto-negotiate: Can't afford Golden Handshake ({selectedOption.GoldCost}g), using Fair Terms");
				selectedOption = options[1]; // Fair Terms
			}
		}

		// Check and spend contract ink based on option's cost
		if (!TamerManager.Instance.SpendContractInk(selectedOption.InkCost))
		{
			Log.Warning($"Auto-negotiate: Not enough ink! Need {selectedOption.InkCost}");
			return;
		}

		// Attempt the negotiation
		bool success = ContractGenerator.AttemptNegotiation(selectedOption);

		if (success)
		{
			SoundManager.PlayMonsterCatch();

			// Create the caught monster
			var caughtMonster = MonsterManager.Instance?.CreateMonster(
				target.SpeciesId,
				isBred: false,
				target.Genetics
			);

			if (caughtMonster != null)
			{
				caughtMonster.Level = target.Level;
				caughtMonster.Contract = selectedOption.Contract;
				MonsterManager.Instance?.RecalculateStats(caughtMonster);

				// Record catch (stats, leaderboard, beastiary, event)
				ExpeditionManager.Instance?.RecordMonsterCatch(caughtMonster);
				Log.Info($"Auto-caught {caughtMonster.Nickname} with {selectedOption.Name}!");
			}
		}
		else
		{
			SoundManager.PlayDeny();
			Log.Info($"Auto-negotiate failed for {target.Nickname} with {selectedOption.Name} ({selectedOption.GetSuccessText()})");
		}
	}

	private void OnNegotiationComplete(bool caught, Monster monster)
	{
		Log.Info($"OnNegotiationComplete: caught={caught}, monster={monster?.Nickname ?? "null"}");

		// Clear negotiation state
		ExpeditionManager.Instance?.ClearCatchableEnemies();
		negotiationTarget = null;
		isBossContract = false;

		var currentAutoRetry = ExpeditionManager.Instance?.AutoRetry ?? autoRetry;

		// Continue with expedition flow
		if (currentWave < (selectedExpedition?.Waves ?? 0))
		{
			// More waves to go
			ContinueExpedition();
		}
		else if (currentAutoRetry)
		{
			// Expedition complete but auto-retry is on - restart
			Log.Info("OnNegotiationComplete: Auto-retry enabled, restarting expedition");
			RetryExpedition(awardCompletionRewards: true);
		}
		else
		{
			// Expedition complete, no auto-retry
			ExpeditionManager.Instance?.OnWaveComplete(true);
			currentView = "result";
			StateHasChanged();
		}
	}

	private void OnExpeditionCancelled()
	{
		Log.Info("Expedition cancelled by user");

		// Reset local state
		selectedExpedition = null;
		selectedTeam.Clear();
		currentWave = 0;
		battleGold = 0;
		battleXP = 0;
		battleTokens = 0;
		negotiationTarget = null;

		// Return to expedition list
		currentView = "list";
		StateHasChanged();
	}

	private void ContinueExpedition()
	{
		// Only play sound during manual wave advancement, not during auto-battle
		var currentAutoBattle = ExpeditionManager.Instance?.AutoBattle ?? autoBattle;
		if (!currentAutoBattle)
		{
			SoundManager.PlayForward();
		}

		// Start next wave (ExpeditionManager increments the wave counter)
		ExpeditionManager.Instance?.StartNextWave();
		currentWave = ExpeditionManager.Instance?.CurrentWave ?? currentWave + 1;

		Log.Info($"ContinueExpedition: Wave={currentWave}, IsInBattle={BattleManager.Instance?.IsInBattle}, AutoBattle={ExpeditionManager.Instance?.AutoBattle}");

		// Auto-start playback if auto-battle is enabled
		if (currentAutoBattle && BattleManager.Instance != null)
		{
			BattleManager.Instance.StartPlayback();
			Log.Info($"ContinueExpedition: Started playback, IsPlaying={BattleManager.Instance.IsPlaying}");
		}
	}

	private void RetryExpedition(bool awardCompletionRewards = false)
	{
		if (selectedExpedition == null || selectedTeam.Count == 0) return;

		// Only play sound during manual retry, not during auto-retry
		var currentAutoRetry = ExpeditionManager.Instance?.AutoRetry ?? autoRetry;
		if (!currentAutoRetry)
		{
			SoundManager.PlayBattleStart();
		}

		// Reset accumulated rewards for the new attempt
		battleGold = 0;
		battleXP = 0;
		battleTokens = 0;

		// Use ExpeditionManager's retry method which preserves the player's active monster index
		ExpeditionManager.Instance?.RetryExpedition(awardCompletionRewards);
		currentWave = ExpeditionManager.Instance?.CurrentWave ?? 1;

		Log.Info($"RetryExpedition: Wave={currentWave}, IsInBattle={BattleManager.Instance?.IsInBattle}, AutoBattle={ExpeditionManager.Instance?.AutoBattle}");

		// Auto-start playback if auto-battle is enabled
		var currentAutoBattle = ExpeditionManager.Instance?.AutoBattle ?? autoBattle;
		if (currentAutoBattle && BattleManager.Instance != null)
		{
			BattleManager.Instance.StartPlayback();
		}
	}

	private void ReturnToList()
	{
		SoundManager.PlayBack();

		// Clear the expedition in ExpeditionManager (also cleans up battle state)
		ExpeditionManager.Instance?.CancelExpedition();

		// Reset local UI state
		currentView = "list";
		selectedExpedition = null;
		selectedTeam.Clear();
		currentWave = 0;
		battleGold = 0;
		battleXP = 0;
		battleTokens = 0;
		lastBattleWon = false;
		StateHasChanged();
	}

	private async void GoToList()
	{
		if (isTransitioningToList) return;

		SoundManager.PlayBack();

		// Start slide-out transition
		isTransitioningToList = true;
		StateHasChanged();

		// Wait for animation
		await Task.Delay(250);

		currentView = "list";
		isTransitioningToList = false;
		StateHasChanged();
	}

	private void GoToTeam()
	{
		SoundManager.PlayForward();
		currentView = "team";
		StateHasChanged();
	}

	private bool IsExpeditionRunning()
	{
		return ExpeditionManager.Instance?.CurrentExpedition != null
			&& currentView == "list";
	}

	private string GetRunningExpeditionName()
	{
		return ExpeditionManager.Instance?.CurrentExpedition?.Name ?? "Expedition";
	}

	private int GetRunningWave()
	{
		return ExpeditionManager.Instance?.CurrentWave ?? 1;
	}

	private void ResumeExpedition()
	{
		// Sync local state with the running expedition
		var expMgr = ExpeditionManager.Instance;
		if (expMgr?.CurrentExpedition != null)
		{
			selectedExpedition = expMgr.CurrentExpedition;
			selectedTeam = new List<Monster>(expMgr.SelectedTeam);
			currentWave = expMgr.CurrentWave;
			battleGold = expMgr.AccumulatedGold;
			battleXP = expMgr.AccumulatedXP;
			autoBattle = expMgr.AutoBattle;
			autoRetry = expMgr.AutoRetry;
			autoNegotiate = expMgr.AutoNegotiate;
			autoNegotiateStrategy = expMgr.AutoNegotiateStrategy;
		}

		// Disable background mode so UI takes over
		ExpeditionManager.Instance?.DisableBackgroundMode();

		// Go to battle view
		currentView = "battle";
		StateHasChanged();
	}

	private void CancelExpedition()
	{
		// Stop any ongoing battle
		if (BattleManager.Instance?.IsInBattle == true)
		{
			BattleManager.Instance.ExitBattle();
		}

		// Clear expedition state
		ExpeditionManager.Instance?.CancelExpedition();

		// Reset local state
		selectedExpedition = null;
		selectedTeam.Clear();
		currentWave = 0;
		battleGold = 0;
		battleXP = 0;
		battleTokens = 0;
		lastBattleWon = false;

		StateHasChanged();
	}

	protected override int BuildHash()
	{
		var hash = new HashCode();
		hash.Add(currentView);
		hash.Add(selectedExpedition?.Id);
		hash.Add(selectedTeam.Count);
		hash.Add(lastBattleWon);
		hash.Add(currentWave);
		hash.Add(battleGold);
		hash.Add(battleXP);
		hash.Add(autoBattle);
		hash.Add(autoRetry);
		hash.Add(autoNegotiate);
		hash.Add(autoNegotiateStrategy);
		hash.Add(SpriteAnimator.GlobalFrame);
		hash.Add(MonsterManager.Instance?.OwnedMonsters?.Count ?? 0);
		foreach (var m in selectedTeam)
			hash.Add(m.Id);
		hash.Add(GetAvailableMonsters().Count);
		// Include hovered monster for tooltip
		hash.Add(hoveredMonsterId);
		// Include running expedition state for the cancel bar
		hash.Add(ExpeditionManager.Instance?.CurrentExpedition?.Id);
		hash.Add(ExpeditionManager.Instance?.CurrentWave ?? 0);
		// Include negotiation state
		hash.Add(negotiationTarget?.Id);
		// Include monsters popup state
		hash.Add(showMonstersPopup);
		hash.Add(monstersPopupExpedition?.Id);
		// Include drops popup state
		hash.Add(showDropsPopup);
		hash.Add(dropsPopupExpedition?.Id);
		// Include transition states
		hash.Add(isTransitioningToBattle);
		hash.Add(isTransitioningToList);
		// Include dropdown states
		hash.Add(difficultyDropdownOpen);
		hash.Add(catchDropdownOpen);
		hash.Add(hardModeEnabled);
		hash.Add(contractTargetSearchOpen);
		hash.Add(contractTargetSearchText);
		hash.Add(autoContractTargetSpecies);
		return hash.ToHashCode();
	}
}
